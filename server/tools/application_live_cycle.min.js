var express=require("express"),router=express.Router(),mongoose=require("mongoose"),ApplicationLiveCycle={},Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),replaceFormDataModel=function(e,a,t){e&&Metadata.Form.update({_id:e,datamodel_id:a},{$set:{datamodel_id:t}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyDataModel=function(e,a,t,o){return t["d_"+e]?void replaceFormDataModel(o,e,t["d_"+e]):void Metadata.DataModel.findOne({_company_code:Constants.ProductionCompany,_id:e},function(s,i){if(i){if(t["d_"+e])return void replaceFormDataModel(o,e,t["d_"+e]);var r=new Metadata.DataModel(i);r._id=mongoose.Types.ObjectId(),t["d_"+e]=r._id,r.isNew=!0,r._company_code=a,r.save(function(){replaceFormDataModel(o,e,t["d_"+e]);var a;try{a=new Schema(JSON.parse(r.datamodel?r.datamodel:"{}"))}catch(s){console.log(s),a=new Schema({})}Metadata.Objects[r._id].model=mongoose.model("data"+r._id,a,"data"+r._id),module.exports=Metadata})}})};var replaceFormValues=function(e,a,t){e&&Metadata.Form.update({_id:e,"display.listofvalues":a},{$set:{"display.$.listofvalues":t}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyValues=function(e,a,t,o){return t["v_"+e]?void replaceFormValues(o,e,t["v_"+e]):void Metadata.Value.findOne({_company_code:Constants.ProductionCompany,_id:e},function(s,i){if(i){if(t["v_"+e])return void replaceFormValues(o,e,t["v_"+e]);var r=new Metadata.Value(i);r._id=mongoose.Types.ObjectId(),t["v_"+e]=r._id,r.isNew=!0,r._company_code=a,r.save(function(){replaceFormValues(o,e,t["v_"+e])})}})};var replaceFormPredecessor=function(e,a,t,o){e&&Metadata.Workflow.update({_id:e,startup_form_id:t},{$set:{startup_form_id:o}},function(e){e&&console.log(e)}),a&&(Metadata.Form.update({_id:a,"actions.next_form_id":t},{$set:{"actions.$.next_form_id":o}},function(e){e&&console.log(e)}),Metadata.Form.update({_id:a,"item_actions.next_form_id":t},{$set:{"item_actions.$.next_form_id":o}},function(e){e&&console.log(e)}))};ApplicationLiveCycle.copyForm=function(e,a,t,o,s){return e!=Constants.ApplicationHome?t["f_"+e]?void replaceFormPredecessor(o,s,e,t["f_"+e]):void Metadata.Form.findOne({_company_code:Constants.ProductionCompany,_id:e},function(i,r){if(r){if(t["f_"+e])return void replaceFormPredecessor(o,s,e,t["f_"+e]);var n=new Metadata.Form(r);n._id=mongoose.Types.ObjectId(),t["f_"+e]=n._id,n.isNew=!0,n._company_code=a,n.save(function(){if(replaceFormPredecessor(o,s,e,t["f_"+e]),ApplicationLiveCycle.copyDataModel(n.datamodel_id,a,t,n._id),n.display)for(var i=0;i<n.display.length;i++)n.display[i].listofvalues&&ApplicationLiveCycle.copyValues(n.display[i].listofvalues,a,t,n._id);if(n.actions)for(var r=0;r<n.actions.length;r++)ApplicationLiveCycle.copyForm(n.actions[r].next_form_id,a,t,null,n._id);if(n.item_actions)for(var l=0;l<n.item_actions.length;l++)ApplicationLiveCycle.copyForm(n.item_actions[l].next_form_id,a,t,null,n._id)})}}):void 0},ApplicationLiveCycle.copyWorkflow=function(e,a,t,o){if(!o["w_"+e._id]){var s=new Metadata.Workflow(e);s._id=mongoose.Types.ObjectId(),s.isNew=!0,s._company_code=a,s.application_id=""+t,o["w_"+e._id]=s._id,s.save(function(){ApplicationLiveCycle.copyForm(s.startup_form_id,a,o,s._id,null)})}},ApplicationLiveCycle.copyApplication=function(e,a,t){if(!t["a_"+e._id]){var o=new Metadata.Application(e);o._id=mongoose.Types.ObjectId(),o.isNew=!0,o._company_code=a,t["a_"+e._id]=o._id,Metadata.Workflow.find({_company_code:Constants.ProductionCompany,application_id:e._id},function(e,s){for(var i=0;i<s.length;i++)ApplicationLiveCycle.copyWorkflow(s[i],a,o._id,t)}),o.save()}},module.exports=ApplicationLiveCycle;
