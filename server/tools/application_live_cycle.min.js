var express=require("express"),router=express.Router(),mongoose=require("mongoose"),ApplicationLiveCycle={},Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),replaceFormDataModel=function(e,o,t){e&&Metadata.Form.update({_id:e,datamodel_id:o},{$set:{datamodel_id:t}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyDataModel=function(e,o,t,a){return t["d_"+e]?void replaceFormDataModel(a,e,t["d_"+e]):void Metadata.DataModel.findOne({_company_code:Constants.ProductionCompany,_id:e},function(s,r){if(r){if(t["d_"+e])return void replaceFormDataModel(a,e,t["d_"+e]);var n=new Metadata.DataModel(r);n._id=mongoose.Types.ObjectId(),t["d_"+e]=n._id,n.isNew=!0,n._company_code=o,n.save().then(function(){replaceFormDataModel(a,e,t["d_"+e]);var o;try{o=new Schema(JSON.parse(n.datamodel?n.datamodel:"{}"))}catch(s){console.log(s),o=new Schema({})}Metadata.Objects[n._id].model=mongoose.model("data"+n._id,o,"data"+n._id),module.exports=Metadata})}})};var replaceFormValues=function(e,o,t){e&&Metadata.Form.update({_id:e,"display.listofvalues":o},{$set:{"display.$.listofvalues":t}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyValues=function(e,o,t,a){return t["v_"+e]?void replaceFormValues(a,e,t["v_"+e]):void Metadata.Value.findOne({_company_code:Constants.ProductionCompany,_id:e},function(s,r){if(r){if(t["v_"+e])return void replaceFormValues(a,e,t["v_"+e]);var n=new Metadata.Value(r);n._id=mongoose.Types.ObjectId(),t["v_"+e]=n._id,n.isNew=!0,n._company_code=o,n.save().then(function(){replaceFormValues(a,e,t["v_"+e])})}})};var replaceFormPredecessor=function(e,o,t,a){e&&Metadata.Workflow.update({_id:e,startup_form_id:t},{$set:{startup_form_id:a}},function(e){e&&console.log(e)}),o&&(Metadata.Form.update({_id:o,"actions.next_form_id":t},{$set:{"actions.$.next_form_id":a}},function(e){e&&console.log(e)}),Metadata.Form.update({_id:o,"item_actions.next_form_id":t},{$set:{"item_actions.$.next_form_id":a}},function(e){e&&console.log(e)}))};ApplicationLiveCycle.copyForm=function(e,o,t,a,s){return e!=Constants.ApplicationHome?t["f_"+e]?void replaceFormPredecessor(a,s,e,t["f_"+e]):void Metadata.Form.findOne({_company_code:Constants.ProductionCompany,_id:e},function(r,n){if(n){if(t["f_"+e])return void replaceFormPredecessor(a,s,e,t["f_"+e]);var i=new Metadata.Form(n);i._id=mongoose.Types.ObjectId(),t["f_"+e]=i._id,i.isNew=!0,i._company_code=o,i.save().then(function(){if(replaceFormPredecessor(a,s,e,t["f_"+e]),ApplicationLiveCycle.copyDataModel(i.datamodel_id,o,t,i._id),i.display)for(var r=0;r<i.display.length;r++)i.display[r].listofvalues&&ApplicationLiveCycle.copyValues(i.display[r].listofvalues,o,t,i._id);if(i.actions)for(var n=0;n<i.actions.length;n++)ApplicationLiveCycle.copyForm(i.actions[n].next_form_id,o,t,null,i._id);if(i.item_actions)for(var l=0;l<i.item_actions.length;l++)ApplicationLiveCycle.copyForm(i.item_actions[l].next_form_id,o,t,null,i._id)})}}):void 0},ApplicationLiveCycle.copyWorkflow=function(e,o,t,a){if(!a["w_"+e._id]){var s=new Metadata.Workflow(e);s._id=mongoose.Types.ObjectId(),s.isNew=!0,s._company_code=o,s.application_id=""+t,a["w_"+e._id]=s._id,s.save().then(function(){ApplicationLiveCycle.copyForm(s.startup_form_id,o,a,s._id,null)})}},ApplicationLiveCycle.copyApplication=function(e,o,t){if(!t["a_"+e._id]){var a=new Metadata.Application(e);a._id=mongoose.Types.ObjectId(),a.isNew=!0,a._company_code=o,t["a_"+e._id]=a._id,Metadata.Workflow.find({_company_code:Constants.ProductionCompany,application_id:e._id},function(e,s){for(var r=0;r<s.length;r++)ApplicationLiveCycle.copyWorkflow(s[r],o,a._id,t)}),a.save()}},module.exports=ApplicationLiveCycle;
