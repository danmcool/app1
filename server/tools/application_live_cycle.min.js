var express=require("express"),router=express.Router(),mongoose=require("mongoose"),ApplicationLiveCycle={},Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),replaceFormDataModel=function(e,o,s){e&&Metadata.Form.update({_id:e,datamodel_id:o},{$set:{datamodel_id:s}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyDataModel=function(e,o,s,t){return s["d_"+e]?void replaceFormDataModel(t,e,s["d_"+e]):void Metadata.DataModel.findOne({_company_code:Constants.ProductionCompany,_id:e},function(a,r){if(r){if(s["d_"+e])return void replaceFormDataModel(t,e,s["d_"+e]);var n=new Metadata.DataModel(r);n._id=mongoose.Types.ObjectId(),s["d_"+e]=n._id,n.isNew=!0,n._company_code=o,n.save().then(function(){replaceFormDataModel(t,e,s["d_"+e]);var o;try{o=new Schema(JSON.parse(n.datamodel?n.datamodel:"{}"))}catch(a){console.log(a),o=new Schema({})}Metadata.Objects[n._id].model=mongoose.model("data"+n._id,o),module.exports=Metadata})}})};var replaceFormValues=function(e,o,s){e&&Metadata.Form.update({_id:e,"display.listofvalues":o},{$set:{"display.$.listofvalues":s}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyValues=function(e,o,s,t){return s["v_"+e]?void replaceFormValues(t,e,s["v_"+e]):void Metadata.Value.findOne({_company_code:Constants.ProductionCompany,_id:e},function(a,r){if(r){if(s["v_"+e])return void replaceFormValues(t,e,s["v_"+e]);var n=new Metadata.Value(r);n._id=mongoose.Types.ObjectId(),s["v_"+e]=n._id,n.isNew=!0,n._company_code=o,n.save().then(function(){replaceFormValues(t,e,s["v_"+e])})}})};var replaceFormPredecessor=function(e,o,s,t){e&&Metadata.Workflow.update({_id:e,startup_form_id:s},{$set:{startup_form_id:t}},function(e){e&&console.log(e)}),o&&(Metadata.Form.update({_id:o,"actions.next_form_id":s},{$set:{"actions.$.next_form_id":t}},function(e){e&&console.log(e)}),Metadata.Form.update({_id:o,"item_actions.next_form_id":s},{$set:{"item_actions.$.next_form_id":t}},function(e){e&&console.log(e)}))};ApplicationLiveCycle.copyForm=function(e,o,s,t,a){return e!=Constants.ApplicationHome?s["f_"+e]?void replaceFormPredecessor(t,a,e,s["f_"+e]):void Metadata.Form.findOne({_company_code:Constants.ProductionCompany,_id:e},function(r,n){if(n){if(s["f_"+e])return void replaceFormPredecessor(t,a,e,s["f_"+e]);var i=new Metadata.Form(n);i._id=mongoose.Types.ObjectId(),s["f_"+e]=i._id,i.isNew=!0,i._company_code=o,i.save().then(function(){if(replaceFormPredecessor(t,a,e,s["f_"+e]),ApplicationLiveCycle.copyDataModel(i.datamodel_id,o,s,i._id),i.display)for(var r=0;r<i.display.length;r++)i.display[r].listofvalues&&ApplicationLiveCycle.copyValues(i.display[r].listofvalues,o,s,i._id);if(i.actions)for(var n=0;n<i.actions.length;n++)ApplicationLiveCycle.copyForm(i.actions[n].next_form_id,o,s,null,i._id);if(i.item_actions)for(var d=0;d<i.item_actions.length;d++)ApplicationLiveCycle.copyForm(i.item_actions[d].next_form_id,o,s,null,i._id)})}}):void 0},ApplicationLiveCycle.copyWorkflow=function(e,o,s,t){if(!t["w_"+e._id]){var a=new Metadata.Workflow(e);a._id=mongoose.Types.ObjectId(),a.isNew=!0,a._company_code=o,a.application_id=""+s,t["w_"+e._id]=a._id,a.save().then(function(){ApplicationLiveCycle.copyForm(a.startup_form_id,o,t,a._id,null)})}},ApplicationLiveCycle.copyApplication=function(e,o,s){if(!s["a_"+e._id]){var t=new Metadata.Application(e);t._id=mongoose.Types.ObjectId(),t.isNew=!0,t._company_code=o,s["a_"+e._id]=t._id,Metadata.Workflow.find({_company_code:Constants.ProductionCompany,application_id:e._id},function(e,a){for(var r=0;r<a.length;r++)ApplicationLiveCycle.copyWorkflow(a[r],o,t._id,s)}),t.save()}},module.exports=ApplicationLiveCycle;
