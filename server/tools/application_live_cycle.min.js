var express=require("express"),router=express.Router(),mongoose=require("mongoose"),ApplicationLiveCycle={},Metadata=require("../models/metadata.min.js"),Constants=require("../tools/constants.min.js"),replaceFormDataModel=function(e,o,a){e&&Metadata.Form.update({_id:e,datamodel_id:o},{$set:{datamodel_id:a}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyDataModel=function(e,o,a,s){return a["d_"+e]?void replaceFormDataModel(s,e,a["d_"+e]):void Metadata.DataModel.findOne({_company_code:Constants.ProductionCompany,_id:e},function(t,i){if(i){if(a["d_"+e])return void replaceFormDataModel(s,e,a["d_"+e]);var n=new Metadata.DataModel(i);n._id=mongoose.Types.ObjectId(),a["d_"+e]=n._id,n.isNew=!0,n._company_code=o,n.save().then(function(){replaceFormDataModel(s,e,a["d_"+e]);var o;try{o=new Schema(JSON.parse(n.datamodel?n.datamodel:"{}"))}catch(t){console.log(t),o=new Schema({})}Metadata.Objects[n._id].model=mongoose.model("data"+n._id,o),module.exports=Metadata})}})};var replaceFormValues=function(e,o,a){e&&Metadata.Form.update({_id:e,"display.listofvalues":o},{$set:{"display.$.listofvalues":a}},function(e){e&&console.log(e)})};ApplicationLiveCycle.copyValues=function(e,o,a,s){return a["v_"+e]?void replaceFormValues(s,e,a["v_"+e]):void Metadata.Value.findOne({_company_code:Constants.ProductionCompany,_id:e},function(t,i){if(i){if(a["v_"+e])return void replaceFormValues(s,e,a["v_"+e]);var n=new Metadata.Value(i);n._id=mongoose.Types.ObjectId(),a["v_"+e]=n._id,n.isNew=!0,n._company_code=o,n.save().then(function(){replaceFormValues(s,e,a["v_"+e])})}})};var replaceFormPredecessor=function(e,o,a,s){e&&Metadata.Workflow.update({_id:e,startup_form_id:a},{$set:{startup_form_id:s}},function(e){e&&console.log(e)}),o&&(Metadata.Form.update({_id:o,"actions.next_form_id":a},{$set:{"actions.$.next_form_id":s}},function(e){e&&console.log(e)}),Metadata.Form.update({_id:o,"item_actions.next_form_id":a},{$set:{"item_actions.$.next_form_id":s}},function(e){e&&console.log(e)}))};ApplicationLiveCycle.copyForm=function(e,o,a,s,t){return e!=Constants.ApplicationHome?a["f_"+e]?void replaceFormPredecessor(s,t,e,a["f_"+e]):void Metadata.Form.findOne({_company_code:Constants.ProductionCompany,_id:e},function(i,n){if(n){if(a["f_"+e])return void replaceFormPredecessor(s,t,e,a["f_"+e]);var r=new Metadata.Form(n);r._id=mongoose.Types.ObjectId(),a["f_"+e]=r._id,r.isNew=!0,r._company_code=o,r.save().then(function(){if(replaceFormPredecessor(s,t,e,a["f_"+e]),ApplicationLiveCycle.copyDataModel(r.datamodel_id,o,a,r._id),r.display)for(var i=0;i<r.display.length;i++)r.display[i].listofvalues&&ApplicationLiveCycle.copyValues(r.display[i].listofvalues,o,a,r._id);if(r.actions)for(var n=0;n<r.actions.length;n++)ApplicationLiveCycle.copyForm(r.actions[n].next_form_id,o,a,null,r._id);if(r.item_actions)for(var d=0;d<r.item_actions.length;d++)ApplicationLiveCycle.copyForm(r.item_actions[d].next_form_id,o,a,null,r._id)})}}):void 0},ApplicationLiveCycle.copyWorkflow=function(e,o,a,s){if(!s["w_"+e._id]){var t=new Metadata.Workflow(e);t._id=mongoose.Types.ObjectId(),t.isNew=!0,t._company_code=o,t.application_id=""+a,s["w_"+e._id]=t._id,t.save().then(function(){ApplicationLiveCycle.copyForm(t.startup_form_id,o,s,t._id,null)})}},ApplicationLiveCycle.copyApplication=function(e,o,a){if(!a["a_"+e._id]){var s=new Metadata.Application(e);s._id=mongoose.Types.ObjectId(),s.isNew=!0,s._company_code=o,a["a_"+e._id]=s._id,Metadata.Workflow.find({_company_code:Constants.ProductionCompany,application_id:e._id},function(e,t){for(var i=0;i<t.length;i++)ApplicationLiveCycle.copyWorkflow(t[i],o,s._id,a)}),s.save()}},module.exports=ApplicationLiveCycle;
