var mongoose=require("mongoose"),Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),Session=Metadata.Session,User=Metadata.User,SessionCache={userData:{},userTimeout:{},serviceProvider:{},identityProvider:{}},SamlServiceProviderCache={};setInterval(function(){var e=Date.now();Metadata.Session.remove({timeout:{$lt:e}})},Constants.DBSessionTimerCleanup),setInterval(function(){for(var e=Date.now(),a=Object.keys(SessionCache.userTimeout),t=0;t<a.length;t++)SessionCache.userTimeout[a[t]]<e&&SessionCache.removeUserCache(a[t])},Constants.CacheSessionTimerCleanup),SessionCache.prepareUser=function(e){var a=JSON.stringify(e);e.user&&(a=a.replace(/@@user/g,e._id)),e.manager&&(a=a.replace(/@@manager/g,e.manager)),a=a.replace(/@@public/g,Constants.PublicUser+"@"+e._company_code),e.reports&&(a=a.replace(/'@@reports'/g,e.reports&&e.reports.length>0?JSON.stringify(e.reports).replace(/]|[[]/g,""):"''")),e._company_code&&(a=a.replace(/@@company_code/g,e._company_code));var t=JSON.parse(a);return t.company.properties&&(t.company.properties.saml={}),t},SessionCache.cacheUser=function(e,a){SessionCache.userData[e]=SessionCache.prepareUser(a),SessionCache.touch(e)},SessionCache.update=function(e,a){SessionCache.userData[e]=SessionCache.prepareUser(a)},SessionCache.isActive=function(e,a){var t=e.cookies[Constants.SessionCookie];if(!t)return void a(!1);var s=Date.now();return SessionCache.userTimeout[t]&&SessionCache.userTimeout[t]>s?void a(!0):void Session.findOneAndUpdate({_id:{$eq:t},timeout:{$gt:s}},{timeout:s+Constants.MaxSessionTimeout}).exec(function(e,s){return e?next(e):s?void User.findOne({_id:s.user,validated:!0},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,s){return e?next(e):void(s&&(SessionCache.cacheUser(t,s),a(!0)))}):void a(!1)})},SessionCache.touch=function(e){SessionCache.userTimeout[e]=Date.now()+Constants.MaxSessionCacheTimeout},SessionCache.removeUserCache=function(e){delete SessionCache.userData[e],delete SessionCache.userTimeout[e]},SessionCache.filterCompanyCode=function(e,a){var t=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code;return null!=e.body&&null==e.body._company_code&&(e.body._company_code=t),t!=Constants.AdminCompany&&(a||(a={}),a._company_code={$eq:t},null!=e.body&&e.body._company_code!=t&&(e.body._company_code=t)),a},SessionCache.filterApplicationCompanyCode=function(e,a){var t=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code;return t!=Constants.AdminCompany&&(a||(a={}),a._company_code={$in:[t,Constants.ProductionCompany]},null!=e.body&&e.body._company_code!=t&&(e.body._company_code=t)),a},SessionCache.filterDataUserProfile=function(e,a,t,s){var o=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code;return null!=e.body&&null==e.body._company_code&&(e.body._company_code=o),o!=Constants.AdminCompany&&(a||(a={}),a._company_code={$eq:o},null!=e.body&&e.body._company_code!=o&&(e.body._company_code=o)),a};var getDefaultProfile=function(e){return e==Constants.UserProfileAdministrator?Constants.UserProfileAdministratorDefault:e==Constants.UserProfilePrivate?Constants.UserProfilePrivateDefault:e==Constants.UserProfilePublic?Constants.UserProfilePublicDefault:null};SessionCache.getProfile=function(e,a){var t=SessionCache.userData[e],s=t.profile.profile;return s||(s={datamodels:{}}),s.datamodels[a]||(s.datamodels[a]=getDefaultProfile(SessionCache.userData[e].profile.type),t.profile.profile=s,SessionCache.update(e,t),s=SessionCache.userData[e].profile.profile),s},module.exports=SessionCache;
