var mongoose=require("mongoose"),Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),Session=Metadata.Session,User=Metadata.User,SessionCache={userData:{},userTimeout:{},serviceProvider:{},identityProvider:{}},SamlServiceProviderCache={};setInterval(function(){var e=Date.now();Metadata.Session.remove({timeout:{$lt:e}})},Constants.DBSessionTimerCleanup),setInterval(function(){for(var e=Date.now(),o=Object.keys(SessionCache.userTimeout),s=0;s<o.length;s++)SessionCache.userTimeout[o[s]]<e&&SessionCache.removeUserCache(o[s])},Constants.CacheSessionTimerCleanup),SessionCache.prepareUser=function(e){var o=JSON.stringify(e);e.user&&(o=o.replace(/@@user/g,e._id)),e.manager&&(o=o.replace(/@@manager/g,e.manager)),o=o.replace(/@@public/g,Constants.PublicUser+"@"+e._company_code),e.reports&&(o=o.replace(/'@@reports'/g,e.reports&&e.reports.length>0?JSON.stringify(e.reports).replace(/]|[[]/g,""):"''")),e._company_code&&(o=o.replace(/@@company_code/g,e._company_code));var s=JSON.parse(o);return s.company.properties&&(s.company.properties.saml={}),s},SessionCache.cacheUser=function(e,o){SessionCache.userData[e]=SessionCache.prepareUser(o),SessionCache.touch(e)},SessionCache.update=function(e,o){SessionCache.userData[e]=SessionCache.prepareUser(o)},SessionCache.isActive=function(e,o){var s=e.cookies[Constants.SessionCookie];if(!s)return void o(!1);var t=Date.now();return SessionCache.userTimeout[s]&&SessionCache.userTimeout[s]>t?void o(!0):void Session.findOneAndUpdate({_id:{$eq:s},timeout:{$gt:t}},{timeout:t+Constants.MaxSessionTimeout}).exec(function(e,t){return e?next(e):t?void User.findOne({_id:t.user,validated:!0},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,t){return e?next(e):void(t&&(SessionCache.cacheUser(s,t),o(!0)))}):void o(!1)})},SessionCache.touch=function(e){SessionCache.userTimeout[e]=Date.now()+Constants.MaxSessionCacheTimeout},SessionCache.removeUserCache=function(e){delete SessionCache.userData[e],delete SessionCache.userTimeout[e]},SessionCache.filterCompanyCode=function(e,o){var s=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code;return null!=e.body&&null==e.body._company_code&&(e.body._company_code=s),s!=Constants.AdminCompany&&(o||(o={}),o._company_code={$eq:s},null!=e.body&&e.body._company_code!=s&&(e.body._company_code=s)),o},SessionCache.filterApplicationCompanyCode=function(e,o){var s=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code;return s!=Constants.AdminCompany&&(o||(o={}),o._company_code={$in:[s,Constants.ProductionCompany]},null!=e.body&&e.body._company_code!=s&&(e.body._company_code=s)),o},SessionCache.filterDataUserProfile=function(e,o,s,t){var a=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code;return null!=e.body&&null==e.body._company_code&&(e.body._company_code=a),a!=Constants.AdminCompany&&(o||(o={}),o._company_code={$eq:a},null!=e.body&&e.body._company_code!=a&&(e.body._company_code=a)),o},module.exports=SessionCache;
