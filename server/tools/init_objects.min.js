var mongoose=require("mongoose"),fs=require("fs"),saml2=require("saml2-js"),Schema=mongoose.Schema,Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),SessionCache=require("../tools/session_cache.js"),DatamodelTools=require("../tools/datamodel_tools.js"),DataModel=Metadata.DataModel;DataModel.find(function(e,t){if(e)return next(e);for(var s=0;s<t.length;s++){var o;if(t[s].properties&&t[s].properties.reference==Constants.DataModelUserId)Metadata.Objects[t[s]._id]=Metadata.User;else{var o,r={fields:{},options:{name:Constants.DataModelIndexName,weights:{}}};try{console.log(t[s]._id),o=new Schema(DatamodelTools.buildDataModel(t[s].projection,r))}catch(a){console.log(a),o=new Schema({})}o.index(r.fields,r.options),Metadata.Objects[t[s]._id]=mongoose.model(Constants.DataModelPrefix+t[s]._id,o,Constants.DataModelPrefix+t[s]._id)}}});var sp_options={entity_id:"app1_saml_metadata.xml",private_key:fs.readFileSync("./server/ssl/app1-key.pem","utf8"),certificate:fs.readFileSync("./server/ssl/app1-cert.crt","utf8"),assert_endpoint:"https://"+Constants.WebAddress+"/authentication/saml_callback",force_authn:!1,sign_get_request:!1,allow_unencrypted_assertion:!0};SessionCache.serviceProvider=new saml2.ServiceProvider(sp_options);
