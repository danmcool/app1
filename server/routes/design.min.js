var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.min.js"),SessionCache=require("../tools/session_cache.min.js"),Constants=require("../tools/constants.min.js"),Email=require("../tools/email.min.js"),DataModel=Metadata.DataModel,User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Form=Metadata.Form,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.get("/application",function(e,s,o){var a=computePage(e);Application.find(SessionCache.filterApplicationCompanyCode(e,{})).populate("profiles").skip(a.skip).limit(a.limit).exec(function(e,a){return e?o(e):void s.json(a)})}),router.post("/application/",function(e,s,o){SessionCache.filterCompanyCode(e,{}),Application.create(e.body,function(e,a){return e?o(e):void s.json(a)})}),router.get("/application/:id/",function(e,s,o){Application.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id})).populate("workflows").exec(function(e,a){return e?o(e):void s.json(a)})}),router.put("/application/:id",function(e,s,o){Application.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?o(e):void s.json(a)})}),router["delete"]("/application/:id",function(e,s,o){Application.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?o(e):void s.json(a)})}),router.post("/workflow/",function(e,s,o){SessionCache.filterCompanyCode(e,{}),Workflow.create(e.body,function(e,a){return e?o(e):void s.json(a)})}),router.get("/workflow/:id",function(e,s,o){Workflow.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id})).populate("forms").exec(function(e,a){return e?o(e):void s.json(a)})}),router.put("/workflow/:id",function(e,s,o){Workflow.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?o(e):void s.json(a)})}),router["delete"]("/workflow/:id",function(e,s,o){Workflow.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?o(e):void s.json(a)})}),router.post("/form",function(e,s,o){SessionCache.filterCompanyCode(e,{}),Form.create(e.body,function(e,a){return e?o(e):void s.json(a)})}),router.get("/form/:id",function(e,s,o){Metadata.Form.findOne(SessionCache.filterApplicationCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,a){return e?o(e):a?s.status(200).json(a):s.status(400).json({msg:"Url is null!"})})}),router.put("/form/:id",function(e,s,o){Form.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?o(e):void s.json(a)})}),router["delete"]("/form/:id",function(e,s,o){Form.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?o(e):void s.json(a)})}),router.post("/datamodel",function(e,s,o){SessionCache.filterCompanyCode(e,{}),Form.create(e.body,function(e,a){return e?o(e):void s.json(a)})}),router.get("/datamodel/:id",function(e,s,o){Metadata.Form.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id})).exec(function(e,a){return e?o(e):a?s.status(200).json(a):s.status(400).json({msg:"Url is null!"})})}),router.put("/datamodel/:id",function(e,s,o){Form.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?o(e):void s.json(a)})}),router["delete"]("/datamodel/:id",function(e,s,o){Form.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?o(e):void s.json(a)})}),module.exports=router;
