var exec=require("child_process").exec,express=require("express"),router=express.Router(),mongoose=require("mongoose"),Schema=mongoose.Schema,Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}},DataModel=Metadata.DataModel;router.get("/datamodel/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);DataModel.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/datamodel/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});SessionCache.filterCompanyCode(e,{});var s=JSON.parse(e.body.datamodel?e.body.datamodel:"{}");s._ref==Constants.DataModelUserId?(e.body.projection||(e.body.projection={}),DataModel.create(e.body,function(e,a){return e?t(e):(Metadata.Objects[a._id]=Metadata.User,module.exports=Metadata,o.json(a))})):(s._updated_at="Date",s._company_code="String",s._user="String",s._files=[{type:Schema.Types.ObjectId,ref:"File"}],e.body.datamodel=JSON.stringify(s),e.body.projection||(e.body.projection={}),e.body.projection._file={en:"Files",fr:"Fichiers"},e.body.projection._updated_at={en:"Updated at",fr:"Mis a jour à"},e.body.projection._user={en:"User",fr:"Utilisateur"},DataModel.create(e.body,function(e,a){if(e)return t(e);var s;try{s=new Schema(a.datamodel)}catch(r){console.log(r),s=new Schema({})}return Metadata.Objects[a._id]=mongoose.model("data"+a._id,s,"data"+a._id),module.exports=Metadata,o.json(a)}))}),router.get("/datamodel/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void DataModel.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/datamodel/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=JSON.parse(e.body.datamodel?e.body.datamodel:"{}");if(s._ref==Constants.DataModelUserId)e.body.projection||(e.body.projection={}),DataModel.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):o.json(a)});else{delete mongoose.connection.models["data"+e.body._id],delete mongoose.modelSchemas["data"+e.body._id],delete Metadata.Objects[e.body._id];var r;s._updated_at="Date",s._company_code="String",s._user="String",s._files=[{type:Schema.Types.ObjectId,ref:"File"}],e.body.datamodel=JSON.stringify(s),e.body.projection||(e.body.projection={}),e.body.projection._file={en:"Files",fr:"Fichiers"},e.body.projection._updated_at={en:"Updated at",fr:"Mis a jour à"},e.body.projection._user={en:"User",fr:"Utilisateur"};try{r=new Schema(s)}catch(n){return console.log(n),r=new Schema({}),o.status(400),o.json(e.body)}Metadata.Objects[e.body._id]=mongoose.model("data"+e.body._id,r,"data"+e.body._id),module.exports=Metadata,DataModel.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):o.json(a)})}}),router["delete"]("/datamodel/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void DataModel.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(a,s){return a?t(a):(delete mongoose.connection.models["data"+e.params._id],delete mongoose.modelSchemas["data"+e.params._id],delete Metadata.Objects[e.params._id],void o.json(s))})});var Value=Metadata.Value;router.get("/value/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);Value.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/value/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void Value.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/value/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Value.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/value/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Value.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/value/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Value.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var Form=Metadata.Form;router.get("/form/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);Form.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/form/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void Form.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/form/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Form.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/form/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Form.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/form/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Form.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var Company=Metadata.Company;router.get("/company/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);Company.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/company/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void Company.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/company/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/company/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/company/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Company.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var UserProfile=Metadata.UserProfile;router.get("/userprofile/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);UserProfile.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/userprofile/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void UserProfile.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/userprofile/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void UserProfile.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/userprofile/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void UserProfile.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/userprofile/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void UserProfile.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var Session=Metadata.Session;router.get("/session/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);Session.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/session/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void Session.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/session/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Session.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/session/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Session.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/session/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Session.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var User=Metadata.User;router.get("/user/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);User.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/user/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(e.body.user=e.body.user.toLowerCase(),SessionCache.filterCompanyCode(e,{}),void User.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/user/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void User.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/user/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(e.body.user&&(e.body.user=e.body.user.toLowerCase()),void User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)}))}),router["delete"]("/user/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void User.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var Workflow=Metadata.Workflow;router.get("/workflow/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);Workflow.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/workflow/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void Workflow.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/workflow/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Workflow.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/workflow/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Workflow.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/workflow/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Workflow.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})});var Application=Metadata.Application;router.get("/application/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany)return o.status(401).json({err:"Not enough user rights"});var s=computePage(e);Application.find(SessionCache.filterCompanyCode(e,{})).skip(s.skip).limit(s.limit).exec(function(e,a){return e?t(e):void o.json(a)})}),router.post("/application/",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):(SessionCache.filterCompanyCode(e,{}),void Application.create(e.body,function(e,a){return e?t(e):void o.json(a)}))}),router.get("/application/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Application.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/application/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Application.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?t(e):void o.json(a)})}),router["delete"]("/application/:id",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):void Application.findOneAndRemove(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?t(e):void o.json(a)})}),router.put("/update",function(e,o,t){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type!=Constants.UserProfileAdministrator||SessionCache.userData[a]._company_code!=Constants.AdminCompany?o.status(401).json({err:"Not enough user rights"}):SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code!=Constants.AdminCompany?o.status(400).json({error:"Invalid user rights!"}):e.body.repository?void exec("git pull "+e.body.repository,function(e,t,a){object={error:e,stdout:t,stderr:a},o.json(object)}):o.status(400).json({error:"Invalid repository!"})}),module.exports=router;
