var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),AWS=require("aws-sdk");AWS.config.update({accessKeyId:Constants.ACCESS_KEY_ID,secretAccessKey:Constants.SECRET_ACCESS_KEY,region:Constants.REGION});var s3Instance=new AWS.S3({params:{Bucket:Constants.S3_BUCKET}});router.get("/",function(e,o,s){var t={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10},r=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");r._company_code={$eq:SessionCache.userData[userToken]._company_code};var a=JSON.parse(e.query.sort_by?e.query.sort_by:"{}");Metadata.File.find(r).skip(t.skip).limit(t.limit).sort(a).exec(function(e,t){return e?s(e):void o.json(t)})}),router.post("/",function(e,o,s){e.body&&(e.body._updated_at=Date.now(),e.body._company_code=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code),Metadata.File.create(e.body,function(t,r){if(t)return s(t);var a={Key:e.body._company_code+"/"+r._id+"/"+r.name,ContentType:r.type,ACL:"public-read"};s3Instance.getSignedUrl("putObject",a,function(e,t){if(e)return console.log(e),s(e);var a={file:r,signedRequest:t,url:"http://s3."+Constants.REGION+".amazonaws.com/"+Constants.S3_BUCKET+"/"+r._company_code+"/"+r._id+"/"+r.name};o.json(a),o.end()})})}),router.get("/:id",function(e,o,s){Metadata.File.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(t,r){if(t)return s(t);if(!r)return o.status(401).json({msg:"Cannot find file object!"});var a={Key:e.body._company_code+"/"+r._id+"/"+r.name};s3Instance.getSignedUrl("getObject",a,function(e,t){return e?s(e):t?void o.redirect(t):o.status(400).json({msg:"Url is null!"})})})}),router.put("/:id",function(e,o,s){var t=Date.parse(e.body._updated_at);e.body._updated_at=Date.now(),Metadata.File.findOneAndUpdate({_id:e.params.id,_updated_at:t,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]].code},e.body,function(t,r){return t?s(t):void(r?o.json(r):Metadata.File.findOne({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(e,t){return e?s(e):void o.status(400).json({msg:"Object has been modified by another user!"})}))})}),router["delete"]("/:id",function(e,o,s){Metadata.File.findOneAndRemove({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(t,r){if(t)return s(t);var a={Key:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code+"/"+r._id+"/"+r.name};s3Instance.deleteObject(a,function(e,t){return e?s(e):void o.json({msg:"Object has been deleted!"})})})}),module.exports=router;
