var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.min.js"),SessionCache=require("../tools/session_cache.min.js"),Constants=require("../tools/constants.min.js"),AWS=require("aws-sdk");AWS.config.update({accessKeyId:Constants.ACCESS_KEY_ID,secretAccessKey:Constants.SECRET_ACCESS_KEY,region:Constants.REGION});var s3Instance=new AWS.S3({params:{Bucket:Constants.S3_BUCKET}});router.get("/",function(e,o,s){var a={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10},t=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");t._company_code={$eq:SessionCache.userData[userToken]._company_code};var i=JSON.parse(e.query.sort_by?e.query.sort_by:"{}");Metadata.File.find(t).skip(a.skip).limit(a.limit).sort(i).exec(function(e,a){return e?s(e):void o.json(a)})}),router.post("/",function(e,o,s){e.body&&(e.body._updated_at=Date.now(),e.body._company_code=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code),Metadata.File.create(e.body,function(a,t){if(a)return s(a);var i={Key:e.body._company_code+"/"+t._id+"/"+t.name,ContentType:t.type,ACL:"public-read"};s3Instance.getSignedUrl("putObject",i,function(e,a){if(e)return console.log(e),s(e);var i={file:t,signedRequest:a,url:"http://s3."+Constants.REGION+".amazonaws.com/"+Constants.S3_BUCKET+"/"+t._company_code+"/"+t._id+"/"+t.name};o.json(i),o.end()})})}),router.get("/:id",function(e,o,s){Metadata.File.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(a,t){if(a)return s(a);if(!t)return o.status(401).json({msg:"Cannot find file object!"});var i={Key:e.body._company_code+"/"+t._id+"/"+t.name};s3Instance.getSignedUrl("getObject",i,function(e,a){return e?s(e):a?void o.redirect(a):o.status(400).json({msg:"Url is null!"})})})}),router.put("/:id",function(e,o,s){var a=Date.parse(e.body._updated_at);e.body._updated_at=Date.now(),Metadata.File.findOneAndUpdate({_id:e.params.id,_updated_at:a,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]].code},e.body,function(a,t){return a?s(a):void(t?o.json(t):Metadata.File.findOne({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(e,a){return e?s(e):void o.status(400).json({msg:"Object has been modified by another user!"})}))})}),router["delete"]("/:id",function(e,o,s){Metadata.File.findOneAndRemove({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(a,t){if(a)return s(a);var i={Key:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code+"/"+t._id+"/"+t.name};s3Instance.deleteObject(i,function(e,a){return e?s(e):void o.json({msg:"Object has been deleted!"})})})}),module.exports=router;
