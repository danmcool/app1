var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),AWS=require("aws-sdk");AWS.config.update({accessKeyId:Constants.ACCESS_KEY_ID,secretAccessKey:Constants.SECRET_ACCESS_KEY,region:Constants.REGION});var s3Instance=new AWS.S3({params:{Bucket:Constants.S3_BUCKET}});router.get("/url/:id",function(e,a,t){Metadata.File.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(o,s){if(o)return t(o);if(!s)return a.status(401).json({msg:"Cannot find file object!"});var i={Key:e.body._company_code+"/"+s._id+"/"+s.name};s3Instance.getSignedUrl("getObject",i,function(e,o){return e?t(e):o?void a.json({url:o}):a.status(400).json({msg:"Url is null!"})})})}),router.get("/",function(e,a,t){var o=e.cookies[Constants.SessionCookie],s={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10},i=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");i._company_code={$eq:SessionCache.userData[o]._company_code};var r=JSON.parse(e.query.sort_by?e.query.sort_by:"{}");Metadata.File.find(i).skip(s.skip).limit(s.limit).sort(r).exec(function(e,o){return e?t(e):void a.json(o)})}),router.post("/",function(e,a,t){e.body&&(e.body._updated_at=Date.now(),e.body._company_code=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code),Metadata.File.create(e.body,function(o,s){if(o)return t(o);var i={Key:e.body._company_code+"/"+s._id+"/"+s.name,ContentType:s.type,ACL:"public-read"};s3Instance.getSignedUrl("putObject",i,function(e,o){if(e)return t(e);var i={file:s,signedRequest:o,url:"http://s3."+Constants.REGION+".amazonaws.com/"+Constants.S3_BUCKET+"/"+s._company_code+"/"+s._id+"/"+s.name};a.json(i),a.end()})})}),router.get("/:id",function(e,a,t){Metadata.File.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(o,s){if(o)return t(o);if(!s)return a.status(401).json({msg:"Cannot find file object!"});var i={Key:e.body._company_code+"/"+s._id+"/"+s.name};s3Instance.getSignedUrl("getObject",i,function(e,o){return e?t(e):o?void a.redirect(o):a.status(400).json({msg:"Url is null!"})})})}),router.put("/:id",function(e,a,t){var o=Date.parse(e.body._updated_at);e.body._updated_at=Date.now(),Metadata.File.findOneAndUpdate({_id:e.params.id,_updated_at:o,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]].code},e.body,function(o,s){return o?t(o):void(s?a.json(s):Metadata.File.findOne({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(e,o){return e?t(e):void a.status(400).json(o)}))})}),router["delete"]("/:id",function(e,a,t){Metadata.File.findOneAndRemove({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(o,s){if(o)return t(o);var i={Key:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code+"/"+s._id+"/"+s.name};s3Instance.deleteObject(i,function(e,o){return e?t(e):void a.json({msg:"Object has been deleted!"})})})}),module.exports=router;
