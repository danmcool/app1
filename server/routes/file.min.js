var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),AWS=require("aws-sdk");AWS.config.update({accessKeyId:Constants.ACCESS_KEY_ID,secretAccessKey:Constants.SECRET_ACCESS_KEY,region:Constants.REGION});var s3Instance=new AWS.S3({params:{Bucket:Constants.S3_BUCKET}});router.get("/url/:id",function(e,t,a){Metadata.File.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(n,i){if(n)return a(n);if(!i)return t.status(401).json({msg:"Cannot find file object!"});var o={Key:e.body._company_code+"/"+i._id+"/"+i.name};s3Instance.getSignedUrl("getObject",o,function(e,n){return e?a(e):n?void t.json({url:n}):t.status(400).json({msg:"Url is null!"})})})}),router.get("/",function(e,t,a){var n={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10},i=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");i._company_code={$eq:SessionCache.userData[userToken]._company_code};var o=JSON.parse(e.query.sort_by?e.query.sort_by:"{}");Metadata.File.find(i).skip(n.skip).limit(n.limit).sort(o).exec(function(e,n){return e?a(e):void t.json(n)})}),router.post("/",function(e,t,a){e.body&&(e.body._updated_at=Date.now(),e.body._company_code=SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code),Metadata.File.create(e.body,function(n,i){if(n)return a(n);var o={Key:e.body._company_code+"/"+i._id+"/"+i.name,ContentType:i.type,ACL:"public-read"};s3Instance.getSignedUrl("putObject",o,function(e,n){if(e)return console.log(e),a(e);var o={file:i,signedRequest:n,url:"http://s3."+Constants.REGION+".amazonaws.com/"+Constants.S3_BUCKET+"/"+i._company_code+"/"+i._id+"/"+i.name};t.json(o),t.end()})})}),router.get("/:id",function(e,t,a){Metadata.File.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(n,i){if(n)return a(n);if(!i)return t.status(401).json({msg:"Cannot find file object!"});var o={Key:e.body._company_code+"/"+i._id+"/"+i.name};s3Instance.getSignedUrl("getObject",o,function(e,n){return e?a(e):n?void t.redirect(n):t.status(400).json({msg:"Url is null!"})})})}),router.put("/:id",function(e,t,a){var n=Date.parse(e.body._updated_at);e.body._updated_at=Date.now(),Metadata.File.findOneAndUpdate({_id:e.params.id,_updated_at:n,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]].code},e.body,function(n,i){return n?a(n):void(i?t.json(i):Metadata.File.findOne({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(e,n){return e?a(e):void t.status(400).json({msg:"Object has been modified by another user!"})}))})}),router["delete"]("/:id",function(e,t,a){Metadata.File.findOneAndRemove({_id:e.params.id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code},function(n,i){if(n)return a(n);var o={Key:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code+"/"+i._id+"/"+i.name};s3Instance.deleteObject(o,function(e,n){return e?a(e):void t.json({msg:"Object has been deleted!"})})})}),module.exports=router;
