var express=require("express"),router=express.Router(),mongoose=require("mongoose"),crypto=require("crypto"),fs=require("fs"),saml2=require("saml2-js"),Metadata=require("../models/metadata.js"),Constants=require("../tools/constants.js"),Email=require("../tools/email.js"),SessionCache=require("../tools/session_cache.js"),ApplicationLiveCycle=require("../tools/application_live_cycle.js"),Company=Metadata.Company,User=Metadata.User,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Session=Metadata.Session,randomString=function(){return Math.random().toString(36).substr(2,8)};router.put("/password",function(e,t){return e.body.old&&e.body["new"]?void SessionCache.isActive(e.cookies[Constants.SessionCookie],function(a){if(!a)return t.status(401).redirect("/");var o=SessionCache.userData[e.cookies[Constants.SessionCookie]].user;crypto.pbkdf2(e.body.old,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(a,r){if(a)return next(a);var i=r.toString("hex");crypto.pbkdf2(e.body["new"],Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(e,a){if(e)return next(e);var r=a.toString("hex");User.findOneAndUpdate({user:o,password:i,validated:!0},{password:r}).exec(function(e,a){return e?t.status(401).json({errUser:info}):a?void t.status(200).json({msg:"Password changed!"}):t.status(401).json({err:"Invalid user name or password!"})})})})}):t.status(400).json({msg:"Password missing data!"})}),router.post("/register",function(e,t){if(!e.body.email)return t.status(400).json({msg:"Registration: email is not provided!"});var a=e.body.email.toLowerCase();e.body.company_name&&(e.body.company_name=e.body.company_name.trim()),User.findOne({user:a},function(o,r){if(o)return next(o);if(r)return t.status(400).json({msg:"Registration: email is already used, please choose another email!"});var i={name:e.body.company_name,applications:["58209e223ee6583658eceedb","586bbda98983994e00fc9757","58223c8dfaa281219c13beaf","5981c48700ba0804fc43b9b0"]};Company.create(i,function(o,r){return o?next(o):(e.body.code=r._id,void Company.findOneAndUpdate({_id:r._id},{_company_code:e.body.code},function(o,i){if(o)return next(o);var n={name:{en:"Administrator"},type:Constants.UserProfileAdministrator,_company_code:e.body.code};UserProfile.create(n,function(o,i){if(o)return next(o);var n={name:{en:"Private"},type:Constants.UserProfilePrivate,_company_code:e.body.code};UserProfile.create(n,function(o,n){if(o)return next(errUserProfile);var s={name:{en:"Public"},type:Constants.UserProfilePublic,_company_code:e.body.code};UserProfile.create(s,function(o,n){if(o)return next(o);var s=randomString();crypto.pbkdf2(s,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(o,l){if(o)return next(o);var c=l.toString("hex"),p={user:a,password:c,email:e.body.email,firstname:e.body.firstname,lastname:e.body.lastname,properties:{theme:"default",language:"auto"},profile:i._id,validated:!1,company:r._id,_company_code:e.body.code};User.create(p,function(a,o){if(a)return next(a);var i={user:Constants.PublicUser+"@"+o._company_code,password:c,email:e.body.email,firstname:Constants.PublicUserFirstName,lastname:Constants.PublicUserLastName,properties:{theme:"default",language:"auto"},profile:n._id,validated:!0,company:r._id,_company_code:e.body.code};User.create(i,function(e,a){return e?next(e):(t.status(200).json({msg:"Registration: please check your email inbox to validate the registration!"}),void Email.sendValidation(o.email,o.user,o._company_code,s))})})})})})})}))})})}),router.get("/validate",function(e,t){var a=e.query.code;User.findOneAndUpdate({user:e.query.user,_company_code:a,validated:!1},{$set:{validated:!0}},function(e,o){return e?next(e):o?(Application.find({_company_code:Constants.ProductionCompany},function(e,t){for(var o=[],r=0;r<t.length;r++)o.push(""+t[r]._id);Company.findOneAndUpdate({_company_code:a},{applications:o})}),void t.status(200).send('<p>Registration: user has been validated, please log on using initial password!</p><br><a href="https://'+Constants.WebAddress+'/#!/login">Login</a>')):t.status(401).send("Registration: user has been already validated!")})}),router.post("/invite",function(e,t,a){if(!e.query.key)return t.status(401).json({err:"Invalid parameters!"});if(!e.body.users)return t.status(401).json({err:"Invalid parameters!"});var o=e.query.key,r=Date.now();Session.findOneAndUpdate({_id:{$eq:o},timeout:{$gt:r}},{timeout:r+Constants.MaxSessionTimeout}).populate("user").exec(function(o,r){return o?a(o):r?void UserProfile.findOne({_company_code:{$eq:r.user._company_code},type:{$eq:Constants.UserProfilePrivate}},function(o,i){if(o)return a(o);if(!i)return t.status(401).json({err:"Not found user profile!"});for(var n in e.body.users){var s=e.body.users[n];User.findOne({user:s.user},function(e,t){if(e)return a(e);if(!t){var o=randomString();crypto.pbkdf2(o,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(e,t){return e?a(e):(s.password=t.toString("hex"),s.company=r.user.company,s._company_code=r.user._company_code,s.profile=i._id,s.validated=!1,void User.create(s,function(e,t){return e?a(e):void Email.sendValidation(t.email,t.user,t._company_code,o)}))})}})}t.status(200).json({msg:"Invitation: users have been invited to join App1!"})}):t.status(401).json({err:"Not found user session!"})})}),router.post("/login",function(e,t,a){return e.body&&e.body.user&&e.body.password?void crypto.pbkdf2(e.body.password,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(o,r){if(o)return a(o);var i=r.toString("hex");User.findOne({user:e.body.user.toLowerCase(),password:i,validated:!0},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,o){return e?t.status(401).json({msg:e}):o?void Session.findOneAndUpdate({user:o._id,_company_code:o._company_code},{user:o._id,_company_code:o._company_code,timeout:Date.now()+Constants.MaxSessionTimeout},{upsert:!0,"new":!0},function(e,r){return e?a(e):(SessionCache.cacheUser(r._id,o),void t.cookie(Constants.SessionCookie,r._id,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).status(200).json({token:r._id,user:SessionCache.userData[r._id]}))}):t.status(401).json({err:"Invalid user name or password!"})})}):t.status(401).json({err:"Invalid user name or password!"})}),router.get("/status",function(e,t){SessionCache.isActive(e,function(a){if(!a)return t.clearCookie(Constants.SessionCookie).status(401).json({err:"Invalid session!"});var o=e.cookies[Constants.SessionCookie];t.cookie(Constants.SessionCookie,o,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).status(200).json({token:o,user:SessionCache.userData[o]})})}),router.get("/logout",function(e,t){var a=e.cookies[Constants.SessionCookie];Session.findOneAndRemove({_id:a},function(a,o){return a?next(a):o?(SessionCache.removeUserCache(e.cookies[Constants.SessionCookie]),void t.clearCookie(Constants.SessionCookie).status(200)):t.status(401).json({err:"Invalid session!"})})}),router.get("/open",function(e,t,a){return e.query.pid?void UserProfile.findOne({_id:e.query.pid},function(o,r){return o?a(o):r&&r.type==Constants.UserProfileShare?void(r.properties&&r.properties.user==Constants.UserProfilePublic?User.findOne({user:Constants.PublicUser+"@"+r._company_code,_company_code:r._company_code,validated:!0},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,o){return e?t.status(401).json({msg:e}):o?void Session.findOneAndUpdate({user:o._id,_company_code:o._company_code},{user:o._id,_company_code:o._company_code,timeout:Date.now()+Constants.MaxSessionPublicTimeout},{upsert:!0,"new":!0},function(e,i){if(e)return a(e);o.remote_profiles.push(JSON.parse(JSON.stringify(r))),SessionCache.cacheUser(i._id,o),t.cookie(Constants.SessionCookie,i._id,{maxAge:Constants.MaxSessionPublicTimeout,httpOnly:!0});var n=Object.keys(r.profile.applications)[0];Workflow.findOne({_id:Object.keys(r.profile.applications[n].workflows)[0]}).exec(function(e,a){return e?t.status(400).json({err:"Workflow error"}):void t.redirect("/#!/form/"+a.startup_form+"/0?application_id="+n+"&workflow_id="+a._id)})}):t.status(401).json({err:"Invalid user name or password!"})}):SessionCache.isActive(e,function(a){if(!a)return t.status(200).send('<p>Authentication: please register or login to App1 in order to use this workflow!</p><br><a href="https://'+Constants.WebAddress+'/#!/register">Register</a><br><a href="https://'+Constants.WebAddress+'/#!/login">Login</a>');var o=SessionCache.userData[e.cookies[Constants.SessionCookie]];o.remote_profiles.push(JSON.parse(JSON.stringify(r))),SessionCache.update(e.cookies[Constants.SessionCookie],o);var i=Object.keys(r.profile.applications)[0];Workflow.findOne({_id:Object.keys(r.profile.applications[i].workflows)[0]}).exec(function(e,a){if(e)return t.status(400).json({err:"Workflow error"});var o=Object.keys(r.profile.datamodels)[0];t.redirect("/#!/form/"+a.startup_form+"/"+Object.keys(r.profile.datamodels[o])[0]+"?application_id="+i+"&workflow_id="+a._id)})})):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})}),router.get("/login_saml/:company_code",function(e,t){var a=e.params.company_code;Company.findOne({_company_code:a},function(e,o){if(!o.properties||!o.properties.saml||!o.properties.saml.enabled)return t.status(401).json({err:"Company SAML not setup correctly!"});var r={sso_login_url:o.properties.saml.sso_redirect_url,certificates:[o.properties.saml.sso_certificate]};SessionCache.identityProvider[a]={test:o.properties.saml.test,company_id:o._id},SessionCache.identityProvider[a].idp=new saml2.IdentityProvider(r),SessionCache.serviceProvider.create_login_request_url(SessionCache.identityProvider[a].idp,{relay_state:a},function(e,a,o){return e?t.status(500).json({err:e}):void t.redirect(a)})})}),router.post("/saml_callback",function(e,t){var a={request_body:e.body},o=e.body.RelayState||e.query.RelayState;return SessionCache.identityProvider[o]?void SessionCache.serviceProvider.post_assert(SessionCache.identityProvider[o].idp,a,function(e,a){return e?t.status(401).json({err:e.message}):SessionCache.identityProvider[o].test?t.send("Hello "+JSON.stringify(a)):void User.findOne({user:a.user.attributes.EmailAddress[0],_company_code:o},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,r){return e?t.status(401).json({err:e}):void(r?Session.findOneAndUpdate({user:r._id,_company_code:r._company_code},{user:r._id,_company_code:r._company_code,timeout:Date.now()+Constants.MaxSessionTimeout},{upsert:!0,"new":!0},function(e,a){return e?next(e):(SessionCache.cacheUser(a._id,r),t.cookie(Constants.SessionCookie,a._id,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).redirect("/"))}):UserProfile.findOne({_company_code:o,type:Constants.UserProfilePrivate},function(e,r){if(e)return t.status(401).json({err:e});if(!r)return t.status(401).json({err:"Missing private user profile"});var i={user:a.user.attributes.EmailAddress[0],password:Constants.InitialPasswordHash,email:a.user.attributes.EmailAddress[0],firstname:a.user.attributes.FirstName,lastname:a.user.attributes.LastName,validated:!0,properties:{theme:"default",language:"en"},profile:r._id,company:SessionCache.identityProvider[o].company_id,_company_code:o};User.create(i,function(e,a){return e?next(e):(Session.findOneAndUpdate({user:a._id,_company_code:a._company_code},{user:a._id,_company_code:a._company_code,timeout:Date.now()+Constants.MaxSessionTimeout},{upsert:!0,"new":!0},function(e,o){return e?next(e):(SessionCache.cacheUser(o._id,a),t.cookie(Constants.SessionCookie,o._id,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).redirect("/"))}),void Email.sendSAMLNewUser(a.email,a.user,a._company_code))})}))})}):t.status(401).json({err:"Missing company code!"})}),router.get("/saml_metadata",function(e,t){t.type("application/xml"),t.status(200).send(SessionCache.serviceProvider.create_metadata())}),module.exports=router;
