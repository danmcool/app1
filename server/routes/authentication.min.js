var express=require("express"),router=express.Router(),mongoose=require("mongoose"),crypto=require("crypto"),fs=require("fs"),saml2=require("saml2-js"),Metadata=require("../models/metadata.min.js"),Constants=require("../tools/constants.min.js"),Email=require("../tools/email.min.js"),SessionCache=require("../tools/session_cache.min.js"),ApplicationLiveCycle=require("../tools/application_live_cycle.min.js"),Company=Metadata.Company,User=Metadata.User,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Session=Metadata.Session,randomString=function(){return Math.random().toString(36).substr(2,8)};router.put("/password",function(e,s){return e.body.old&&e.body["new"]?void SessionCache.isActive(e.cookies[Constants.SessionCookie],function(t){if(!t)return s.status(401).redirect("/");var r=SessionCache.userData[e.cookies[Constants.SessionCookie]].user;console.log(r),crypto.pbkdf2(e.body.old,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(t,o){if(t)return next(t);var n=o.toString("hex");crypto.pbkdf2(e.body["new"],Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(e,t){if(e)return next(e);var o=t.toString("hex");User.findOneAndUpdate({user:r,password:n,validated:!0},{password:o}).exec(function(e,t){return e?s.status(401).json({errUser:info}):t?void s.status(200).json({msg:"Password changed!"}):s.status(401).json({err:"Invalid user name or password!"})})})})}):s.status(400).json({msg:"Password missing data!"})}),router.post("/register",function(e,s){if(!e.body.email)return s.status(400).json({msg:"Registration: email is not provided!"});var t=e.body.email.toLowerCase();User.findOne({user:t},function(r,o){return r?next(r):o?s.status(400).json({msg:"Registration: email is already used, please choose another email!"}):void Company.findOne({_company_code:e.body.code},function(r,o){if(r)return next(r);if(o)return s.status(400).json({msg:"Registration: company code is already used, please use another code!"});var n={name:e.body.company_name,_company_code:e.body.code,applications:["593d6a2b09290d1e3e9d9863","58223c8dfaa281219c13beaf","584185e59b20a92dd877ee9f","586bbda98983994e00fc9757"]};Company.create(n,function(r,o){if(r)return next(r);var n={name:{en:"Administrator"},type:Constants.UserProfileAdministrator,_company_code:e.body.code};UserProfile.create(n,function(r,n){if(r)return next(r);var a={name:{en:"Private"},type:Constants.UserProfilePrivate,_company_code:e.body.code};UserProfile.create(a,function(r,a){if(r)return next(errUserProfile);var i={name:{en:"Public"},type:Constants.UserProfilePublic,_company_code:e.body.code};UserProfile.create(i,function(r,a){if(r)return next(r);var i=randomString();crypto.pbkdf2(i,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(r,u){if(r)return next(r);var c=u.toString("hex"),p={user:t,password:c,email:e.body.email,firstname:e.body.firstname,lastname:e.body.lastname,properties:{theme:"default",language:"en"},profile:n._id,validated:!1,company:o._id,_company_code:e.body.code};User.create(p,function(t,r){if(t)return next(t);var n={user:Constants.PublicUser+"@"+r._company_code,password:c,email:e.body.email,firstname:Constants.PublicUserFirstName,lastname:Constants.PublicUserLastName,properties:{theme:"default",language:"en"},profile:a._id,validated:!0,company:o._id,_company_code:e.body.code};User.create(n,function(e,t){return e?next(e):(s.status(200).json({msg:"Registration: please check your email to validate the registration!"}),void Email.sendValidation(r.email,r.user,r._company_code,i))})})})})})})})})})}),router.get("/validate",function(e,s){var t=e.query.code;User.findOneAndUpdate({user:e.query.user,_company_code:t,validated:!1},{$set:{validated:!0}},function(e,r){return e?next(e):r?(Application.find({_company_code:Constants.ProductionCompany},function(e,s){for(var r=[],o=0;o<s.length;o++)r.push(""+s[o]._id);Company.findOneAndUpdate({_company_code:t},{applications:r})}),void s.status(200).send('<p>Registration: user has been validated, please log on using initial password!</p><br><a href="/#/login">Login</a>')):s.status(401).send("Registration: user has been already validated!")})}),router.post("/invite",function(e,s,t){if(!e.query.key)return s.status(401).json({err:"Invalid parameters!"});if(!e.body.users)return s.status(401).json({err:"Invalid parameters!"});var r=e.query.key,o=Date.now();Session.findOneAndUpdate({_id:{$eq:r},timeout:{$gt:o}},{timeout:o+Constants.MaxSessionTimeout}).populate("user").exec(function(r,o){return r?t(r):o?void UserProfile.findOne({_company_code:{$eq:o.user._company_code},type:{$eq:Constants.UserProfilePrivate}},function(r,n){if(r)return t(r);if(!n)return s.status(401).json({err:"Not found user profile!"});for(var a in e.body.users){var i=e.body.users[a];User.findOne({user:i.user},function(e,s){return e?t(e):void(s||(i.password=Constants.InitialPasswordHash,i.company=o.user.company,i._company_code=o.user._company_code,i.profile=n._id,i.validated=!1,User.create(i,function(e,s){return e?t(e):void Email.sendValidation(s.email,s.user,s._company_code)})))})}s.status(200).json({msg:"Invitation: users have been invited to join App1!"})}):s.status(401).json({err:"Not found user session!"})})}),router.post("/login",function(e,s,t){return e.body&&e.body.user&&e.body.password?void crypto.pbkdf2(e.body.password,Constants.SecretKey,Constants.SecretIterations,Constants.SecretByteSize,Constants.SecretAlgorithm,function(r,o){if(r)return t(r);var n=o.toString("hex");User.findOne({user:e.body.user.toLowerCase(),password:n,validated:!0},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,r){return e?s.status(401).json({errUser:info}):r?void Session.findOneAndUpdate({user:r._id,_company_code:r._company_code},{user:r._id,_company_code:r._company_code,timeout:Date.now()+Constants.MaxSessionTimeout},{upsert:!0,"new":!0},function(e,o){return e?t(e):(SessionCache.cacheUser(o._id,r),void s.cookie(Constants.SessionCookie,o._id,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).status(200).json({token:o._id,user:SessionCache.userData[o._id]}))}):s.status(401).json({err:"Invalid user name or password!"})})}):s.status(401).json({err:"Invalid user name or password!"})}),router.get("/status",function(e,s){SessionCache.isActive(e,function(t){if(!t)return s.clearCookie(Constants.SessionCookie).status(401).json({err:"Invalid session!"});var r=e.cookies[Constants.SessionCookie];s.cookie(Constants.SessionCookie,r,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).status(200).json({token:r,user:SessionCache.userData[r]})})}),router.get("/logout",function(e,s){e.cookies[Constants.SessionCookie];Session.findOneAndRemove({_id:e.cookies[Constants.SessionCookie]},function(t,r){return t?next(t):r?(SessionCache.removeUserCache(e.cookies[Constants.SessionCookie]),void s.clearCookie(Constants.SessionCookie).status(200)):s.status(401).json({err:"Invalid session!"})})}),router.get("/open",function(e,s,t){return e.query.pid?void UserProfile.findOne({_id:e.query.pid},function(r,o){if(r)return t(r);if(!o||o.type!=Constants.UserProfileShare)return s.status(400).json({err:"Invalid parameters!"});if(o.properties.user==Constants.UserProfilePublic)User.findOne({user:Constants.PublicUser+"@"+o._company_code,_company_code:o._company_code,validated:!0},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,r){return e?s.status(401).json({errUser:info}):r?void Session.findOneAndUpdate({user:r._id,_company_code:r._company_code},{user:r._id,_company_code:r._company_code,timeout:Date.now()+Constants.MaxSessionPublicTimeout},{upsert:!0,"new":!0},function(e,n){if(e)return t(e);r.remote_profiles.push(JSON.parse(JSON.stringify(o))),SessionCache.cacheUser(n._id,r),s.cookie(Constants.SessionCookie,n._id,{maxAge:Constants.MaxSessionPublicTimeout,httpOnly:!0});var a=Object.keys(o.profile.applications)[0];Workflow.findOne({_id:Object.keys(o.profile.applications[a].workflows)[0]}).exec(function(e,t){return e?s.status(400).json({err:"Workflow error"}):void s.redirect("/#!/form/"+t.startup_form+"/0?application_id="+a)})}):s.status(401).json({err:"Invalid user name or password!"})});else{var n=SessionCache.userData[e.cookies[Constants.SessionCookie]];n.remote_profiles.push(JSON.parse(JSON.stringify(o))),SessionCache.update(e.cookies[Constants.SessionCookie],n);var a=o.profile.applications[Object.keys(o)[0]];Workflow.findOne(Object.keys(o.profile.applications[a].workflows)[0]).exec(function(t,r){return t?s.status(400).json({err:"Workflow error"}):void s.redirect("/#!/form/"+r.startup_form+"/"+e.query.data_id+"?application_id="+a)})}}):s.status(400).json({err:"Invalid parameters!"})}),router.get("/login_saml/:company_code",function(e,s){var t=e.params.company_code;Company.findOne({_company_code:t},function(e,r){if(!r.properties||!r.properties.saml||!r.properties.saml.enabled)return s.status(401).json({err:"Company SAML not setup correctly!"});var o={sso_login_url:r.properties.saml.sso_redirect_url,certificates:[r.properties.saml.sso_certificate]};SessionCache.identityProvider[t]={test:r.properties.saml.test,company_id:r._id},SessionCache.identityProvider[t].idp=new saml2.IdentityProvider(o),SessionCache.serviceProvider.create_login_request_url(SessionCache.identityProvider[t].idp,{relay_state:t},function(e,t,r){return e?s.status(500).json({err:e}):void s.redirect(t)})})}),router.post("/saml_callback",function(e,s){var t={request_body:e.body},r=e.body.RelayState||e.query.RelayState;return SessionCache.identityProvider[r]?void SessionCache.serviceProvider.post_assert(SessionCache.identityProvider[r].idp,t,function(e,t){return e?s.status(401).json({err:e.message}):SessionCache.identityProvider[r].test?s.send("Hello "+JSON.stringify(t)):void User.findOne({user:t.user.attributes.EmailAddress[0],_company_code:r},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(e,o){return e?s.status(401).json({err:e}):void(o?Session.findOneAndUpdate({user:o._id,_company_code:o._company_code},{user:o._id,_company_code:o._company_code,timeout:Date.now()+Constants.MaxSessionTimeout},{upsert:!0,"new":!0},function(e,t){return e?next(e):(SessionCache.cacheUser(t._id,o),s.cookie(Constants.SessionCookie,t._id,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).redirect("/"))}):UserProfile.findOne({_company_code:r,type:Constants.UserProfilePrivate},function(e,o){if(e)return s.status(401).json({err:e});if(!o)return s.status(401).json({err:"Missing private user profile"});var n={user:t.user.attributes.EmailAddress[0],password:Constants.InitialPasswordHash,email:t.user.attributes.EmailAddress[0],firstname:t.user.attributes.FirstName,lastname:t.user.attributes.LastName,validated:!0,properties:{theme:"default",language:"en"},profile:o._id,company:SessionCache.identityProvider[r].company_id,_company_code:r};User.create(n,function(e,t){return e?next(e):(Session.findOneAndUpdate({user:t._id,_company_code:t._company_code},{user:t._id,_company_code:t._company_code,timeout:Date.now()+Constants.MaxSessionTimeout},{upsert:!0,"new":!0},function(e,r){return e?next(e):(SessionCache.cacheUser(r._id,t),s.cookie(Constants.SessionCookie,r._id,{maxAge:Constants.MaxSessionTimeout,httpOnly:!0}).redirect("/"))}),void Email.sendSAMLNewUser(t.email,t.user,t._company_code))})}))})}):s.status(401).json({err:"Missing company code!"})}),router.get("/saml_metadata",function(e,s){s.type("application/xml"),s.status(200).send(SessionCache.serviceProvider.create_metadata())}),module.exports=router;
