var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),Email=require("../tools/email.js"),DataModel=Metadata.DataModel,User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Form=Metadata.Form,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,a,t){var o=computePage(e);if(!e.query.type)return a.status(400).json({msg:"Missing values parameters!"});var r={_id:e.params.id,index:e.body.index,values:[]};if(e.query.type!=Constants.ValuesTypeUser)return e.query.type==Constants.ValuesTypeQuery?a.status(200).json(""):a.status(200).json("");if(!e.body.relation)return a.status(400).json({msg:"Missing values parameters!"});var i=null;e.body.relation==Constants.ValuesRelationUserReports?i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].manager}}:e.body.relation==Constants.ValuesRelationUserList&&(i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),i&&User.find(i,"user email firstname lastname").skip(o.skip).limit(o.limit).exec(function(e,o){if(e)return t(e);if(!o)return a.status(400).json({msg:"Url is null!"});for(var i in o)r.values.push({_id:o[i]._id,name:{en:(o[i].firstname?o[i].firstname:"")+" "+(o[i].lastname?o[i].lastname:"")},email:o[i].email});return a.status(200).json(r)})}),router.get("/form/:id",function(e,a,t){return e.params.id?void Metadata.Form.findOne(SessionCache.filterApplicationCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,o){return e?t(e):o?a.status(200).json(o):a.status(400).json({msg:"Url is null!"})}):a.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,a,t){var o=computePage(e);Application.find(SessionCache.filterApplicationCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications},active:!0})).skip(o.skip).limit(o.limit).populate("profiles default_profile workflows").exec(function(o,r){if(o)return t(o);for(var i=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,s=e.cookies[Constants.SessionCookie],n=r.length-1;n>=0;n--)if(r[n].profiles&&0!=r[n].profiles.length){var l;SessionCache.userData[s].profile.type!=Constants.UserProfilePublic&&(l=r[n].default_profile);for(var d=0;d<i.length;d++)if(i[d].profile.applications[r[n]._id])if(SessionCache.userData[s].profile.type==Constants.UserProfilePublic){if(i[d].type==Constants.UserProfileShare){l=i[d];break}}else if(i[d].type==Constants.UserProfileApplication){l=i[d];break}if(l&&l.profile.applications[r[n]._id])for(var d=r[n].workflows.length-1;d>=0;d--)l.profile.applications[r[n]._id].workflows[r[n].workflows[d]._id]||r[n].workflows.splice(d,1)}else SessionCache.userData[s].profile.type==Constants.UserProfilePublic&&r.splice(n,1);a.json(r)})}),router.put("/user/:id",function(e,a,t){var o=e.cookies[Constants.SessionCookie];if(SessionCache.userData[o].profile.type==Constants.UserProfilePublic)return a.status(401).json({errUser:"Not enough user rights"});var r={properties:e.body.properties};e.body.properties||(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),r,function(e,t){return e?a.status(400).json({errUser:e}):(a.json(t),void SessionCache.removeUserCache(o))})}),router.get("/company/:id",function(e,a,t){var o=e.cookies[Constants.SessionCookie];return SessionCache.userData[o].profile.type==Constants.UserProfilePublic?a.status(401).json({errUser:"Not enough user rights"}):void Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,o){return e?t(e):void a.json(o)})}),router.put("/company/:id",function(e,a,t){var o=e.cookies[Constants.SessionCookie];return SessionCache.userData[o].profile.type==Constants.UserProfilePublic?a.status(401).json({errUser:"Not enough user rights"}):void Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,r){return e?t(e):(a.json(r),void SessionCache.removeUserCache(o))})}),router.put("/share",function(e,a,t){var o=e.cookies[Constants.SessionCookie];return SessionCache.userData[o].profile.type==Constants.UserProfilePublic?a.status(401).json({err:"Not enough user rights"}):e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(r,i){if(r)return t(r);if(!i)return a.status(400).json({err:"Invalid parameters!"});var s={name:{en:"Share"},profile:i.profile,properties:i.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[o]._company_code};if(i.properties.user&&i.properties.user==Constants.UserProfilePublic){var n=Object.keys(i.profile.applications)[0],l=Object.keys(i.profile.applications[n].workflows)[0],d="profile.applications."+n+".workflows."+l,c={"properties.user":Constants.UserProfilePublic,_company_code:SessionCache.userData[o]._company_code,type:Constants.UserProfileShare};c[d]=!0,UserProfile.findOne(c,function(r,i){return r?t(r):void(i?(a.status(200).json({msg:"Application shared successfully (existing share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),Email.sendSharePublic(SessionCache.userData[o].email,i._id,e.body.app_name,e.body.profile_name)):UserProfile.create(s,function(r,i){return r?t(r):(a.status(200).json({msg:"Application shared successfully (new share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),void Email.sendSharePublic(SessionCache.userData[o].email,i._id,e.body.app_name,e.body.profile_name))}))})}else s.profile.datamodels||(s.profile.datamodels={}),s.profile.datamodels[e.query.datamodel_id]={},s.profile.datamodels[e.query.datamodel_id][e.query.data_id]={_company_code:SessionCache.userData[o]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(s,function(r,i){return r?t(r):(a.status(200).json({msg:"Application shared successfully!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),void Email.sendShare(e.body.email,SessionCache.userData[o].email,e.query.data_id,i._id))})}):a.status(400).json({err:"Invalid parameters!"})}),router.get("/calendar",function(e,a,t){return e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(o,r){return o?t(err):r?(a.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(r.email,e.query.project_name,e.query.start_date,e.query.end_date,(r.firstname?r.firstname:"")+" "+(r.lastname?r.lastname:""))):a.status(400).json({err:"Invalid parameters!"})}):a.status(400).json({err:"Invalid parameters!"})}),router.put("/event/:id",function(e,a,t){if(!(e.query.start_date&&e.query.end_date&&e.query.user_id&&e.query.object_id&&e.query.datamodel_id))return a.status(400).json({err:"Invalid parameters!"});var o=e.cookies[Constants.SessionCookie],r=SessionCache.userData[o],i=getProfile(o,e.params.datamodelid),s={},n=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var l=0;l<r.remote_profiles.length;l++)if(r.remote_profiles[l].type==Constants.UserProfileShare&&r.remote_profiles[l].profile.datamodels[e.params.datamodelid]&&r.remote_profiles[l].profile.datamodels[e.params.datamodelid][e.params.id]){s=r.remote_profiles[l].profile.datamodels[e.params.datamodelid][e.params.id],n=!0;break}if(!(i&&i.datamodels[e.params.datamodelid]&&i.datamodels[e.params.datamodelid].update&&e.body._user||n))return a.status(401).json({err:"Not enough user rights!"});var d={_id:{$eq:e.params.id}};n?(d._company_code={$eq:s._company_code},d._user={$eq:e.body._user},d[s.constraint.key]={$eq:s.constraint.value}):(d._company_code={$eq:i.datamodels[e.params.datamodelid].update._company_code},i.datamodels[e.params.datamodelid].update._user&&(d._user={$in:i.datamodels[e.params.datamodelid].update._user})),d._updated_at=Date.parse(e.body._updated_at),e.body._updated_at=Date.now(),Metadata.Objects[e.params.datamodelid].findOne(d,e.body,function(o,r){return o?t(o):void(r?a.status(200).json({msg:"Data: entry updated!"}):(delete d._updated_at,Metadata.Objects[e.params.datamodelid].findOne(d,function(e,o){return e?t(e):void a.status(400).json(o)})))}),User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(o,r){return o?t(err):r?(a.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(r.email,e.query.project_name,e.query.start_date,e.query.end_date,(r.firstname?r.firstname:"")+" "+(r.lastname?r.lastname:""))):a.status(400).json({err:"Invalid parameters!"})})}),router.put("/notify/:user_id",function(e,a,t){return e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(o,r){return o?t(err):r?(a.status(200).json({msg:"Email sent!"}),void Email.send(r.email,null,e.body.email_title,"Automatic message from App1",e.body.email_html.replace(/@@user/g,(r.firstname?r.firstname:"")+" "+(r.lastname?r.lastname:"")))):a.status(400).json({err:"Invalid parameters!"})}):a.status(400).json({err:"Invalid parameters!"})}),module.exports=router;
