var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),Email=require("../tools/email.js"),User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,computePage=function(e){return{skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,t,a){var o=computePage(e);if(!e.query.type)return t.status(400).json({msg:"Missing values parameters!"});var i={_id:e.params.id,values:[]};if(e.query.type!=Constants.ValuesTypeUser)return e.query.type==Constants.ValuesTypeQuery?t.status(200).json(""):t.status(200).json("");if(!e.body.relation)return t.status(400).json({msg:"Missing values parameters!"});var s=null;e.body.relation==Constants.ValuesRelationUserReports?s={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?s={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].manager}}:e.body.relation==Constants.ValuesRelationUserList&&(s={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),s&&User.find(s,e.body.user_fields).skip(o.skip).limit(o.limit).exec(function(e,o){return e?a(e):o?(i.values=o,t.status(200).json(i)):t.status(400).json({msg:"Url is null!"})})}),router.get("/form/:id",function(e,t,a){return e.params.id?void Metadata.Form.findOne(SessionCache.filterAddProductionCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,o){return e?a(e):o?t.status(200).json(o):t.status(400).json({msg:"Url is null!"})}):t.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,t,a){var o=computePage(e);Application.find(SessionCache.filterAddProductionCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications},active:!0})).skip(o.skip).limit(o.limit).populate("profiles default_profile workflows").exec(function(o,i){if(o)return a(o);for(var s=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,l=e.cookies[Constants.SessionCookie],r=i.length-1;r>=0;r--)if(i[r].profiles&&0!=i[r].profiles.length){var n=null;if(SessionCache.userData[l].profile.type==Constants.UserProfilePublic){for(var d=0;d<i[r].profiles.length;d++)if(i[r].profiles[d].properties&&i[r].profiles[d].properties.user==Constants.UserProfilePublic){n=i[r].profiles[d];break}}else n=i[r].default_profile;for(var d=0;d<s.length;d++)if(s[d].profile.applications[i[r]._id])if(SessionCache.userData[l].profile.type==Constants.UserProfilePublic){if(s[d].type==Constants.UserProfileShare){n=s[d];break}}else if(s[d].type==Constants.UserProfileApplication){n=s[d];break}if(n&&n.profile.applications[i[r]._id])for(var f=i[r].workflows.length-1;f>=0;f--)n.profile.applications[i[r]._id].workflows[i[r].workflows[f]._id]||i[r].workflows.splice(f,1);else i.splice(r,1)}else SessionCache.userData[l].profile.type==Constants.UserProfilePublic&&i.splice(r,1);t.json(i)})}),router.get("/application/:id",function(e,t,a){computePage(e);Application.findOne(SessionCache.filterAddProductionCompanyCode(e,{_id:e.params.id})).populate("profiles default_profile workflows").exec(function(o,i){if(o)return a(o);var s=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,l=e.cookies[Constants.SessionCookie];if((!i.profiles||0==i.profiles.length)&&SessionCache.userData[l].profile.type==Constants.UserProfilePublic)return t.json({});var r;SessionCache.userData[l].profile.type!=Constants.UserProfilePublic&&(r=i.default_profile);for(var n=0;n<s.length;n++)if(s[n].profile.applications[i._id])if(SessionCache.userData[l].profile.type==Constants.UserProfilePublic){if(s[n].type==Constants.UserProfileShare){r=s[n];break}}else if(s[n].type==Constants.UserProfileApplication){r=s[n];break}if(r&&r.profile.applications[i._id])for(var d=i.workflows.length-1;d>=0;d--)r.profile.applications[i._id].workflows[i.workflows[d]._id]||i.workflows.splice(d,1);t.json(i)})}),router.get("/user/",function(e,t,a){var o=e.cookies[Constants.SessionCookie];if(SessionCache.userData[o].profile.type==Constants.UserProfilePublic)return t.status(401).json({errUser:"Not enough user rights"});var s=(SessionCache.userData[o],computePage(e)),l=JSON.parse(e.query.sort_by?e.query.sort_by:"{}"),r={_company_code:{$eq:SessionCache.userData[o]._company_code}},n={};e.query.search_text&&""!=e.query.search_text&&(r.$text={$search:e.query.search_text},n={score:{$meta:"textScore"}},l={score:{$meta:"textScore"}}),User.find(r,n).skip(s.skip).limit(s.limit).sort(l).exec(function(e,o){return e?a(e):void t.json(o)})}),router.put("/user/:id",function(e,t,a){var o=e.cookies[Constants.SessionCookie];if(SessionCache.userData[o].profile.type==Constants.UserProfilePublic)return t.status(401).json({errUser:"Not enough user rights"});var i={};e.body.properties&&(i.properties=e.body.properties),e.body.remote_profiles&&(i.remote_profiles=e.body.remote_profiles),e.body.user&&(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),i,function(e,i){return e?a(e):i?(SessionCache.removeUserCache(o),t.json(i)):t.status(401).json({errUser:"Not enough user rights"})})}),router.get("/company/:id",function(e,t,a){var o=e.cookies[Constants.SessionCookie];return SessionCache.userData[o].profile.type==Constants.UserProfilePublic?t.status(401).json({errUser:"Not enough user rights"}):void Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,o){return e?a(e):void t.json(o)})}),router.put("/company/:id",function(e,t,a){var o=e.cookies[Constants.SessionCookie];return SessionCache.userData[o].profile.type==Constants.UserProfilePublic?t.status(401).json({errUser:"Not enough user rights"}):void Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,i){return e?a(e):(t.json(i),void SessionCache.removeUserCache(o))})}),router.put("/share",function(e,t,a){var o=e.cookies[Constants.SessionCookie];return SessionCache.userData[o].profile.type==Constants.UserProfilePublic?t.status(401).json({err:"Not enough user rights"}):e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(i,s){if(i)return a(i);if(!s)return t.status(400).json({err:"Invalid parameters!"});var l={name:{en:"Share"},profile:s.profile,properties:s.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[o]._company_code};if(s.properties&&s.properties.user==Constants.UserProfilePublic){var r=Object.keys(s.profile.applications)[0],n=Object.keys(s.profile.applications[r].workflows)[0],d="profile.applications."+r+".workflows."+n,f={"properties.user":Constants.UserProfilePublic,_company_code:SessionCache.userData[o]._company_code,type:Constants.UserProfileShare};f[d]=!0,UserProfile.findOne(f,function(i,s){return i?a(i):void(s?(t.status(200).json({msg:"Application shared successfully (existing share)!",share_url:"https://"+Constants.WebAddress+"/authentication/open?pid="+s._id}),Email.sendSharePublic(SessionCache.userData[o].email,s._id,e.body.app_name,e.body.profile_name)):UserProfile.create(l,function(i,s){return i?a(i):(t.status(200).json({msg:"Application shared successfully (new share)!",share_url:"https://"+Constants.WebAddress+"/authentication/open?pid="+s._id}),void Email.sendSharePublic(SessionCache.userData[o].email,s._id,e.body.app_name,e.body.profile_name))}))})}else l.profile.datamodels||(l.profile.datamodels={}),l.profile.datamodels[e.body.datamodel_id]={},l.profile.datamodels[e.body.datamodel_id][e.body.data_id]={_company_code:SessionCache.userData[o]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(l,function(i,s){return i?a(i):(t.status(200).json({msg:"Application shared successfully!",share_url:"https://"+Constants.WebAddress+"/authentication/open?pid="+s._id}),e.body.message||(e.body.message=""),void Email.sendShare(e.body.email,SessionCache.userData[o].email,s._id,Email.prepareMessage(e.body.message,SessionCache.userData[o])))})}):t.status(400).json({err:"Invalid parameters!"})}),router.get("/calendar",function(e,t,a){return e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(o,i){return o?a(o):i?(t.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(i.email,e.query.project_name,e.query.start_date,e.query.end_date,!0,i.firstname)):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})});var computeDateKey=function(e){return[e.getFullYear(),e.getMonth()+1,e.getDate()].join("-")},computeTimeObject=function(e){return 60*e.hours+1*e.minutes},computeTimeDate=function(e){return 60*e.getHours()+e.getMinutes()},checkTimeIntersection=function(e,t,a,o){return computeTimeObject(e)<=computeTimeDate(a)&&computeTimeDate(a)<computeTimeObject(t)?!0:computeTimeDate(a)<=computeTimeObject(e)&&computeTimeObject(e)<computeTimeDate(o)?!0:!1};router.put("/event/:id",function(e,t,a){if(!(e.body.start_time&&e.body.end_time&&e.body.object_name&&e.body.datamodel_id))return t.status(400).json({err:"Invalid parameters!"});var o=new Date(e.body.start_time),i=new Date(e.body.end_time);if(!o||!i||o>=i||o.getTime()+Constants.OneWeek<i.getTime()||o.getDay()>i.getDay())return t.status(400).json({err:"Invalid time parameter!"});var s=e.cookies[Constants.SessionCookie],l=SessionCache.userData[s],r=SessionCache.getProfile(s,e.params.datamodelid),n={},d=!1;if(l.remote_profiles&&l.remote_profiles.length>0)for(var f=0;f<l.remote_profiles.length;f++)if(l.remote_profiles[f].type==Constants.UserProfileShare&&l.remote_profiles[f].profile.datamodels[e.params.datamodelid]&&l.remote_profiles[f].profile.datamodels[e.params.datamodelid][e.params.id]){n=l.remote_profiles[f].profile.datamodels[e.params.datamodelid][e.params.id],d=!0;break}if(!(r&&r.datamodels[e.body.datamodel_id]&&r.datamodels[e.body.datamodel_id].update&&e.body._user||d))return t.status(401).json({err:"Not enough user rights!"});var p={_id:{$eq:e.params.id}};d?(p._company_code={$eq:n._company_code},p._user={$eq:e.body._user},p[n.constraint.key]={$eq:n.constraint.value}):(p._company_code={$eq:r.datamodels[e.body.datamodel_id].update._company_code},r.datamodels[e.body.datamodel_id].update._user&&(p._user={$in:r.datamodels[e.body.datamodel_id].update._user})),p._updated_at=Date.parse(e.body._updated_at),Metadata.Objects[e.body.datamodel_id].findOne(p,function(s,l){if(s)return a(s);if(l){if(l._appointments||(l._appointments={}),o.getDay()!=i.getDay())return t.status(400);var r=computeDateKey(o);if(!l._appointment_properties||!l._appointment_properties.days)return t.status(400);var n=l._appointment_properties.days[o.getDay()];if(n.enabled&&(computeTimeDate(i)>=computeTimeObject(n.start_time)||computeTimeDate(o)<=computeTimeObject(n.end_time))){computeTimeDate(o)<computeTimeObject(n.start_time)&&(o.setHours(n.start_time.hours),o.setMinutes(n.start_time.minutes)),computeTimeDate(i)>computeTimeObject(n.end_time)&&(i.setHours(n.end_time.hours),i.setMinutes(n.end_time.minutes)),l._appointments[r]||(l._appointments[r]=[]);for(var d=l._appointments[r],f=!0,c=0;c<d.length;c++)if(checkTimeIntersection(d[c].start_time,d[c].end_time,o,i)){f=!1;break}if(!f)return t.status(400);var u=SessionCache.userData[e.cookies[Constants.SessionCookie]];d.push({start_time:{hours:o.getHours()<10?"0"+o.getHours():o.getHours(),minutes:o.getMinutes()<10?"0"+o.getMinutes():o.getMinutes()},end_time:{hours:i.getHours()<10?"0"+i.getHours():i.getHours(),minutes:i.getMinutes()<10?"0"+i.getMinutes():i.getMinutes()},user:{id:u._id,email:u.email,name:(u.firstname?u.firstname:"")+" "+(u.lastname?u.lastname:"")}}),Metadata.Objects[e.body.datamodel_id].findOneAndUpdate(p,l,function(o,i){return o?a(o):(i||(delete p._updated_at,Metadata.Objects[e.body.datamodel_id].findOne(p,function(e,o){return e?a(e):void t.status(400).json(o)})),Email.sendCalendar(u.email,e.body.object_name,e.body.start_time,e.body.end_time,!1,u.firstname),t.status(200).json({msg:"Reservation done!"}))})}}else delete p._updated_at,Metadata.Objects[e.body.datamodel_id].findOne(p,function(e,o){return e?a(e):void t.status(400).json(o)})})}),router.put("/notify/:user_id",function(e,t,a){return e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").populate("company").exec(function(o,i){return o?a(o):i?(t.status(200).json({msg:"Email sent!"}),void Email.send(i.email,null,e.body.email_title,"Automatic message from App1",Email.prepareMessage(e.body.email_html,i))):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})}),module.exports=router;
