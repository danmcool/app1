var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.min.js"),SessionCache=require("../tools/session_cache.min.js"),Constants=require("../tools/constants.min.js"),Email=require("../tools/email.min.js"),DataModel=Metadata.DataModel,User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Form=Metadata.Form,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,s,o){var a=computePage(e);if(!e.query.type)return s.status(400).json({msg:"Missing values parameters!"});var i={_id:e.params.id,index:e.body.index,values:[]};if(e.query.type!=Constants.ValuesTypeUser)return e.query.type==Constants.ValuesTypeQuery?s.status(200).json(""):s.status(200).json("");if(!e.body.relation)return s.status(400).json({msg:"Missing values parameters!"});var t=null;e.body.relation==Constants.ValuesRelationUserReports?t={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?t={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}}:e.body.relation==Constants.ValuesRelationUserList&&(t={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),t&&User.find(t,"user email firstname lastname").skip(a.skip).limit(a.limit).exec(function(e,a){if(e)return o(e);if(!a)return s.status(400).json({msg:"Url is null!"});for(var t in a)i.values.push({_id:a[t]._id,en:(a[t].firstname?a[t].firstname:"")+" "+(a[t].lastname?a[t].lastname:""),name:(a[t].firstname?a[t].firstname:"")+" "+(a[t].lastname?a[t].lastname:""),email:a[t].email});return s.status(200).json(i)})}),router.get("/form/:id",function(e,s,o){return e.params.id?void Metadata.Form.findOne(SessionCache.filterApplicationCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,a){return e?o(e):a?s.status(200).json(a):s.status(400).json({msg:"Url is null!"})}):s.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,s,o){var a=computePage(e);Application.find(SessionCache.filterApplicationCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications},active:!0})).skip(a.skip).limit(a.limit).populate("profiles default_profile workflows").exec(function(a,i){if(a)return o(a);for(var t=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,r=e.cookies[Constants.SessionCookie],n=i.length-1;n>=0;n--)if(i[n].profiles&&0!=i[n].profiles.length){var l;SessionCache.userData[r].profile.type!=Constants.UserProfilePublic&&(l=i[n].default_profile);for(var u=0;u<t.length;u++)if(t[u].profile.applications[i[n]._id])if(SessionCache.userData[r].profile.type==Constants.UserProfilePublic){if(t[u].type==Constants.UserProfileShare){l=t[u];break}}else if(t[u].type==Constants.UserProfileApplication){l=t[u];break}if(l)for(var u=i[n].workflows.length-1;u>=0;u--)l.profile.applications[i[n]._id].workflows[i[n].workflows[u]._id]||i[n].workflows.splice(u,1)}else SessionCache.userData[r].profile.type==Constants.UserProfilePublic&&i.splice(n,1);s.json(i)})}),router.put("/user/:id",function(e,s,o){var a={properties:e.body.properties};e.body.properties||(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),a,function(o,a){return o?s.status(400).json({errUser:o}):void User.findOne({_id:e.params.id},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(o,a){return o?s.status(400).json({errUser:info}):a?(SessionCache.update(e.cookies[Constants.SessionCookie],a),void s.json(a)):s.status(400).json({err:"Invalid user name!"})})})}),router.get("/company/:id",function(e,s,o){Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?o(e):void s.json(a)})}),router.put("/company/:id",function(e,s,o){Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,a){return e?o(e):void s.json(a)})}),router.put("/share",function(e,s,o){return e.cookies[Constants.SessionCookie]?e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(a,i){if(a)return o(a);if(!i)return s.status(400).json({err:"Invalid parameters!"});var t={name:{en:"Share"},profile:i.profile,properties:i.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code};if(i.properties.user&&i.properties.user==Constants.UserProfilePublic){var r=Object.keys(i.profile.applications)[0],n=Object.keys(i.profile.applications[r].workflows)[0],l="profile.applications."+r+".workflows."+n,u={"properties.user":Constants.UserProfilePublic,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,type:Constants.UserProfileShare};u[l]=!0,console.log(u),UserProfile.findOne(u,function(a,i){return a?o(a):void(i?(s.status(200).json({msg:"Application shared successfully (existing share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),Email.sendSharePublic(SessionCache.userData[e.cookies[Constants.SessionCookie]].email,i._id)):(console.log(t),UserProfile.create(t,function(a,i){return a?o(a):(s.status(200).json({msg:"Application shared successfully (new share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),void Email.sendSharePublic(SessionCache.userData[e.cookies[Constants.SessionCookie]].email,i._id))})))})}else t.profile.datamodels||(t.profile.datamodels={}),t.profile.datamodels[e.query.datamodel_id]={},t.profile.datamodels[e.query.datamodel_id][e.query.data_id]={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(t,function(a,i){return a?o(a):(s.status(200).json({msg:"Application shared successfully!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),void Email.sendShare(e.body.email,SessionCache.userData[e.cookies[Constants.SessionCookie]].email,e.query.data_id,i._id))})}):s.status(400).json({err:"Invalid parameters!"}):s.status(401).json({err:"Not logged in!"})}),router.get("/calendar",function(e,s,o){return e.cookies[Constants.SessionCookie]?e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(a,i){return a?o(err):i?(s.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(i.email,e.query.project_name,e.query.start_date,e.query.end_date,(i.firstname?i.firstname:"")+" "+(i.lastname?i.lastname:""))):s.status(400).json({err:"Invalid parameters!"})}):s.status(400).json({err:"Invalid parameters!"}):s.status(401).json({err:"Not logged in!"})}),router.put("/notify/:user_id",function(e,s,o){return e.cookies[Constants.SessionCookie]?e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(a,i){return a?o(err):i?(s.status(200).json({msg:"Email sent!"}),void Email.send(i.email,null,e.body.email_title,"Automatic message from App1",e.body.email_html.replace(/@@user/g,(i.firstname?i.firstname:"")+" "+(i.lastname?i.lastname:"")))):s.status(400).json({err:"Invalid parameters!"})}):s.status(400).json({err:"Invalid parameters!"}):s.status(401).json({err:"Not logged in!"})}),module.exports=router;
