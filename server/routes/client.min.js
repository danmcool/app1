var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.min.js"),SessionCache=require("../tools/session_cache.min.js"),Constants=require("../tools/constants.min.js"),Email=require("../tools/email.min.js"),DataModel=Metadata.DataModel,User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Form=Metadata.Form,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,a,t){var n=computePage(e);if(!e.query.type)return a.status(400).json({msg:"Missing values parameters!"});var o={_id:e.params.id,index:e.body.index,values:[]};if(e.query.type!=Constants.ValuesTypeUser)return e.query.type==Constants.ValuesTypeQuery?a.status(200).json(""):a.status(200).json("");if(!e.body.relation)return a.status(400).json({msg:"Missing values parameters!"});var i=null;e.body.relation==Constants.ValuesRelationUserReports?i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}}:e.body.relation==Constants.ValuesRelationUserList&&(i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),i&&User.find(i,"user email firstname lastname").skip(n.skip).limit(n.limit).exec(function(e,n){if(e)return t(e);if(!n)return a.status(400).json({msg:"Url is null!"});for(var i in n)o.values.push({_id:n[i]._id,en:(n[i].firstname?n[i].firstname:"")+" "+(n[i].lastname?n[i].lastname:""),name:(n[i].firstname?n[i].firstname:"")+" "+(n[i].lastname?n[i].lastname:""),email:n[i].email});return a.status(200).json(o)})}),router.get("/form/:id",function(e,a,t){return e.params.id?void Metadata.Form.findOne(SessionCache.filterApplicationCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,n){return e?t(e):n?a.status(200).json(n):a.status(400).json({msg:"Url is null!"})}):a.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,a,t){var n=computePage(e);Application.find(SessionCache.filterApplicationCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications}})).skip(n.skip).limit(n.limit).populate("profiles default_profile workflows").exec(function(n,o){if(n)return t(n);for(var i=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,s=o.length-1;s>=0;s--)if(o[s].profiles&&0!=o[s].profiles.length){var r;SessionCache.userData[e.cookies[Constants.SessionCookie]].profile.type!=Constants.UserProfilePublic&&(r=o[s].default_profile);for(var l=0;l<i.length;l++)if(i[l].type==Constants.UserProfileApplication&&i[l].profile.applications[o[s]._id]){r=i[l];break}if(r)for(var l=o[s].workflows.length-1;l>=0;l--)r.profile.applications[o[s]._id].workflows[o[s].workflows[l]._id]||o[s].workflows.splice(l,1)}else SessionCache.userData[e.cookies[Constants.SessionCookie]].profile.type==Constants.UserProfilePublic&&o.splice(s,1);a.json(o)})}),router.put("/user/:id",function(e,a,t){var n={properties:e.body.properties};e.body.properties||(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),n,function(t,n){return t?a.status(400).json({errUser:t}):void User.findOne({_id:e.params.id},"email firstname lastname user _company_code properties company profile remote_profiles manager reports").populate("company profile remote_profiles").exec(function(t,n){return t?a.status(400).json({errUser:info}):n?(SessionCache.update(e.cookies[Constants.SessionCookie],n),void a.json(n)):a.status(400).json({err:"Invalid user name!"})})})}),router.get("/company/:id",function(e,a,t){Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,n){return e?t(e):void a.json(n)})}),router.put("/company/:id",function(e,a,t){Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,n){return e?t(e):void a.json(n)})}),router.post("/share",function(e,a,t){return e.cookies[Constants.SessionCookie]?e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(n,o){if(n)return t(n);if(!o)return a.status(400).json({err:"Invalid parameters!"});var i={name:{en:"Share"},profile:{applications:o.applications,datamodels:{}},properties:o.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code};i.profile.datamodels[e.query.datamodel_id]={},i.profile.datamodels[e.query.datamodel_id][e.query.data_id]={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(i,function(n,o){return n?t(n):(a.status(200).json({msg:"Form shared successfully!"}),void Email.sendShare(e.body.email,SessionCache.userData[e.cookies[Constants.SessionCookie]].email,e.query.data_id,o._id))})}):a.status(400).json({err:"Invalid parameters!"}):a.status(401).json({err:"Not logged in!"})}),router.get("/calendar",function(e,a,t){return e.cookies[Constants.SessionCookie]?e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(n,o){return n?t(err):o?(a.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(o.email,e.query.project_name,e.query.start_date,e.query.end_date,(o.firstname?o.firstname:"")+" "+(o.lastname?o.lastname:""))):a.status(400).json({err:"Invalid parameters!"})}):a.status(400).json({err:"Invalid parameters!"}):a.status(401).json({err:"Not logged in!"})}),router.put("/notify/:user_id",function(e,a,t){return e.cookies[Constants.SessionCookie]?e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(n,o){return n?t(err):o?(a.status(200).json({msg:"Email sent!"}),void Email.send(o.email,null,e.body.email_title,"Automatic message from App1",e.body.email_html.replace(/@@user/g,(o.firstname?o.firstname:"")+" "+(o.lastname?o.lastname:"")))):a.status(400).json({err:"Invalid parameters!"})}):a.status(400).json({err:"Invalid parameters!"}):a.status(401).json({err:"Not logged in!"})}),module.exports=router;
