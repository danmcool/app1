var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),Email=require("../tools/email.js"),User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,computePage=function(e){return{skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,t,a){var r=computePage(e);if(!e.query.type||!e.body)return t.status(400).json({msg:"Missing values parameters!"});var o={_id:e.params.id,values:[]};if(e.query.type!=Constants.ValuesTypeUser){if(e.query.type==Constants.ValuesTypeQuery){var i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code};return e.body.id_list&&(i._id={$in:e.body.id_list}),User.find(n,e.body.user_fields).skip(r.skip).limit(r.limit).exec(function(e,r){return e?a(e):r?(o.values=r,t.status(200).json(o)):t.status(400).json({msg:"Url is null!"})}),t.status(200).json("")}return t.status(200).json("")}if(!e.body.relation)return t.status(400).json({msg:"Missing values parameters!"});var n=null;e.body.relation==Constants.ValuesRelationUserReports?n={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?n={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].manager}}:e.body.relation==Constants.ValuesRelationUserList&&(n={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),n&&User.find(n,e.body.user_fields).skip(r.skip).limit(r.limit).exec(function(e,r){return e?a(e):r?(o.values=r,t.status(200).json(o)):t.status(400).json({msg:"Url is null!"})})}),router.get("/form/:id",function(e,t,a){return e.params.id?void Metadata.Form.findOne(SessionCache.filterAddProductionCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,r){return e?a(e):r?t.status(200).json(r):t.status(400).json({msg:"Url is null!"})}):t.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,t,a){var r=computePage(e);Application.find(SessionCache.filterAddProductionCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications},active:!0})).skip(r.skip).limit(r.limit).populate("profiles default_profile workflows").exec(function(r,o){if(r)return a(r);for(var n=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,i=e.cookies[Constants.SessionCookie],s=o.length-1;s>=0;s--)if(o[s].profiles&&0!=o[s].profiles.length){var l=null;if(SessionCache.userData[i].profile.type==Constants.UserProfilePublic){for(var p=0;p<o[s].profiles.length;p++)if(o[s].profiles[p].properties&&o[s].profiles[p].properties.user==Constants.UserProfilePublic){l=o[s].profiles[p];break}}else l=o[s].default_profile;for(var p=0;p<n.length;p++)if(n[p].profile.applications[o[s]._id])if(SessionCache.userData[i].profile.type==Constants.UserProfilePublic){if(n[p].type==Constants.UserProfileShare){l=n[p];break}}else if(n[p].type==Constants.UserProfileApplication){l=n[p];break}if(l&&l.profile.applications[o[s]._id])for(var c=o[s].workflows.length-1;c>=0;c--)l.profile.applications[o[s]._id].workflows[o[s].workflows[c]._id]||o[s].workflows.splice(c,1);else o.splice(s,1)}else SessionCache.userData[i].profile.type==Constants.UserProfilePublic&&o.splice(s,1);t.json(o)})}),router.get("/application/:id",function(e,t,a){computePage(e);Application.findOne(SessionCache.filterAddProductionCompanyCode(e,{_id:e.params.id})).populate("profiles default_profile workflows").exec(function(r,o){if(r)return a(r);var n=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,i=e.cookies[Constants.SessionCookie];if((!o.profiles||0==o.profiles.length)&&SessionCache.userData[i].profile.type==Constants.UserProfilePublic)return t.json({});var s;SessionCache.userData[i].profile.type!=Constants.UserProfilePublic&&(s=o.default_profile);for(var l=0;l<n.length;l++)if(n[l].profile.applications[o._id])if(SessionCache.userData[i].profile.type==Constants.UserProfilePublic){if(n[l].type==Constants.UserProfileShare){s=n[l];break}}else if(n[l].type==Constants.UserProfileApplication){s=n[l];break}if(s&&s.profile.applications[o._id])for(var p=o.workflows.length-1;p>=0;p--)s.profile.applications[o._id].workflows[o.workflows[p]._id]||o.workflows.splice(p,1);t.json(o)})}),router.get("/user/",function(e,t,a){var r=e.cookies[Constants.SessionCookie];if(SessionCache.userData[r].profile.type==Constants.UserProfilePublic)return t.status(401).json({errUser:"Not enough user rights"});var n=(SessionCache.userData[r],computePage(e)),i=JSON.parse(e.query.sort_by?e.query.sort_by:"{}"),s={_company_code:{$eq:SessionCache.userData[r]._company_code}},l={};e.query.search_text&&""!=e.query.search_text&&(s.$text={$search:e.query.search_text},l={score:{$meta:"textScore"}},i={score:{$meta:"textScore"}}),User.find(s,l).skip(n.skip).limit(n.limit).sort(i).exec(function(e,r){return e?a(e):void t.json(r)})}),router.put("/user/:id",function(e,t,a){var r=e.cookies[Constants.SessionCookie];if(SessionCache.userData[r].profile.type==Constants.UserProfilePublic)return t.status(401).json({errUser:"Not enough user rights"});var o={};e.body.properties&&(o.properties=e.body.properties),e.body.remote_profiles&&(o.remote_profiles=e.body.remote_profiles),e.body.user&&(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),o,function(e,o){return e?a(e):o?(SessionCache.removeUserCache(r),t.json(o)):t.status(401).json({errUser:"Not enough user rights"})})}),router.get("/company/:id",function(e,t,a){var r=e.cookies[Constants.SessionCookie];return SessionCache.userData[r].profile.type==Constants.UserProfilePublic?t.status(401).json({errUser:"Not enough user rights"}):void Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,r){return e?a(e):void t.json(r)})}),router.put("/company/:id",function(e,t,a){var r=e.cookies[Constants.SessionCookie];return SessionCache.userData[r].profile.type==Constants.UserProfilePublic?t.status(401).json({errUser:"Not enough user rights"}):void Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,o){return e?a(e):(t.json(o),void SessionCache.removeUserCache(r))})}),router.put("/share",function(e,t,a){var r=e.cookies[Constants.SessionCookie];return SessionCache.userData[r].profile.type==Constants.UserProfilePublic?t.status(401).json({err:"Not enough user rights"}):e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(o,n){if(o)return a(o);if(!n)return t.status(400).json({err:"Invalid parameters!"});var i={name:{en:"Share"},profile:n.profile,properties:n.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[r]._company_code};if(n.properties&&n.properties.user==Constants.UserProfilePublic){var s=Object.keys(n.profile.applications)[0],l=Object.keys(n.profile.applications[s].workflows)[0],p="profile.applications."+s+".workflows."+l,c={"properties.user":Constants.UserProfilePublic,_company_code:SessionCache.userData[r]._company_code,type:Constants.UserProfileShare};c[p]=!0,UserProfile.findOne(c,function(o,n){return o?a(o):void(n?(t.status(200).json({msg:"Application shared successfully (existing share)!",share_url:"https://"+Constants.WebAddress+"/authentication/open?pid="+n._id}),Email.sendSharePublic(SessionCache.userData[r].email,n._id,e.body.app_name,e.body.profile_name)):UserProfile.create(i,function(o,n){return o?a(o):(t.status(200).json({msg:"Application shared successfully (new share)!",share_url:"https://"+Constants.WebAddress+"/authentication/open?pid="+n._id}),void Email.sendSharePublic(SessionCache.userData[r].email,n._id,e.body.app_name,e.body.profile_name))}))})}else i.profile.datamodels||(i.profile.datamodels={}),i.profile.datamodels[e.body.datamodel_id]={},i.profile.datamodels[e.body.datamodel_id][e.body.data_id]={_company_code:SessionCache.userData[r]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(i,function(o,n){return o?a(o):(t.status(200).json({msg:"Application shared successfully!",share_url:"https://"+Constants.WebAddress+"/authentication/open?pid="+n._id}),e.body.message||(e.body.message=""),void Email.sendShare(e.body.email,SessionCache.userData[r].email,n._id,Email.prepareMessage(e.body.message,SessionCache.userData[r])))})}):t.status(400).json({err:"Invalid parameters!"})}),router.get("/calendar",function(e,t,a){return e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(r,o){return r?a(r):o?(t.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(o.email,e.query.project_name,e.query.start_date,e.query.end_date,!0,o.firstname)):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})});var computeDateKey=function(e){return[e.getFullYear(),e.getMonth()+1,e.getDate()].join("-")},computeTimeObject=function(e){return 60*e.hours+1*e.minutes},computeTimeDate=function(e){return 60*e.getHours()+e.getMinutes()},checkTimeIntersection=function(e,t,a,r){return computeTimeObject(e)<=computeTimeDate(a)&&computeTimeDate(a)<computeTimeObject(t)?!0:computeTimeDate(a)<=computeTimeObject(e)&&computeTimeObject(e)<computeTimeDate(r)?!0:!1};router.put("/event/:id",function(e,t,a){if(!(e.body.start_time&&e.body.end_time&&e.body.object_name&&e.body.datamodel_id))return t.status(400).json({err:"Invalid parameters!"});var r=new Date(e.body.start_time),o=new Date(e.body.end_time);if(!r||!o||r>=o||r.getTime()+Constants.OneWeek<o.getTime()||r.getDay()>o.getDay())return t.status(400).json({err:"Invalid time parameter!"});var n=e.cookies[Constants.SessionCookie],i=SessionCache.userData[n],s=SessionCache.getProfile(n,e.params.datamodelid),l={},p=!1;if(i.remote_profiles&&i.remote_profiles.length>0)for(var c=0;c<i.remote_profiles.length;c++)if(i.remote_profiles[c].type==Constants.UserProfileShare&&i.remote_profiles[c].profile.datamodels[e.params.datamodelid]&&i.remote_profiles[c].profile.datamodels[e.params.datamodelid][e.params.id]){l=i.remote_profiles[c].profile.datamodels[e.params.datamodelid][e.params.id],p=!0;break}if(!(s&&s.datamodels[e.body.datamodel_id]&&s.datamodels[e.body.datamodel_id].update&&e.body._user||p))return t.status(401).json({err:"Not enough user rights!"});var u={_id:{$eq:e.params.id}};p?(u._company_code={$eq:l._company_code},u._user={$eq:e.body._user},u[l.constraint.key]={$eq:l.constraint.value}):(u._company_code={$eq:s.datamodels[e.body.datamodel_id].update._company_code},s.datamodels[e.body.datamodel_id].update._user&&(u._user={$in:s.datamodels[e.body.datamodel_id].update._user})),u._updated_at=Date.parse(e.body._updated_at),Metadata.Objects[e.body.datamodel_id].findOne(u,function(n,i){if(n)return a(n);if(i){if(i._appointments||(i._appointments={}),r.getDay()!=o.getDay())return t.status(400);var s=computeDateKey(r);if(!i._appointment_properties||!i._appointment_properties.days)return t.status(400);var l=i._appointment_properties.days[r.getDay()];if(l.enabled&&(computeTimeDate(o)>=computeTimeObject(l.start_time)||computeTimeDate(r)<=computeTimeObject(l.end_time))){computeTimeDate(r)<computeTimeObject(l.start_time)&&(r.setHours(l.start_time.hours),r.setMinutes(l.start_time.minutes)),computeTimeDate(o)>computeTimeObject(l.end_time)&&(o.setHours(l.end_time.hours),o.setMinutes(l.end_time.minutes)),i._appointments[s]||(i._appointments[s]=[]);for(var p=i._appointments[s],c=!0,d=0;d<p.length;d++)if(checkTimeIntersection(p[d].start_time,p[d].end_time,r,o)){c=!1;break}if(!c)return t.status(400);var f=SessionCache.userData[e.cookies[Constants.SessionCookie]];p.push({start_time:{hours:r.getHours()<10?"0"+r.getHours():r.getHours(),minutes:r.getMinutes()<10?"0"+r.getMinutes():r.getMinutes()},end_time:{hours:o.getHours()<10?"0"+o.getHours():o.getHours(),minutes:o.getMinutes()<10?"0"+o.getMinutes():o.getMinutes()},user:{id:f._id,email:f.email,name:(f.firstname?f.firstname:"")+" "+(f.lastname?f.lastname:"")}}),Metadata.Objects[e.body.datamodel_id].findOneAndUpdate(u,i,function(r,o){return r?a(r):(o||(delete u._updated_at,Metadata.Objects[e.body.datamodel_id].findOne(u,function(e,r){return e?a(e):void t.status(400).json(r)})),Email.sendCalendar(f.email,e.body.object_name,e.body.start_time,e.body.end_time,!1,f.firstname),t.status(200).json({msg:"Reservation done!"}))})}}else delete u._updated_at,Metadata.Objects[e.body.datamodel_id].findOne(u,function(e,r){return e?a(e):void t.status(400).json(r)})})}),router.put("/notify/:user_id",function(e,t,a){return e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").populate("company").exec(function(r,o){return r?a(r):o?(t.status(200).json({msg:"Email sent!"}),void Email.send(o.email,null,e.body.email_title,"Automatic message from App1",Email.prepareMessage(e.body.email_html,o))):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})}),module.exports=router;
