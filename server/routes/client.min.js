var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),Email=require("../tools/email.js"),DataModel=Metadata.DataModel,User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,Workflow=Metadata.Workflow,Form=Metadata.Form,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,o,s){var t=computePage(e);if(!e.query.type)return o.status(400).json({msg:"Missing values parameters!"});var n={_id:e.params.id,index:e.body.index,values:[]};if(e.query.type!=Constants.ValuesTypeUser)return e.query.type==Constants.ValuesTypeQuery?o.status(200).json(""):o.status(200).json("");if(!e.body.relation)return o.status(400).json({msg:"Missing values parameters!"});var r=null;e.body.relation==Constants.ValuesRelationUserReports?r={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?r={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}}:e.body.relation==Constants.ValuesRelationUserList&&(r={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),r&&User.find(r,"user email firstname lastname").skip(t.skip).limit(t.limit).exec(function(e,t){if(e)return s(e);if(!t)return o.status(400).json({msg:"Url is null!"});for(var r in t)n.values.push({_id:t[r]._id,en:(t[r].firstname?t[r].firstname:"")+" "+(t[r].lastname?t[r].lastname:""),name:(t[r].firstname?t[r].firstname:"")+" "+(t[r].lastname?t[r].lastname:""),email:t[r].email});return o.status(200).json(n)})}),router.get("/form/:id",function(e,o,s){return e.params.id?void Metadata.Form.findOne(SessionCache.filterApplicationCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,t){return e?s(e):t?o.status(200).json(t):o.status(400).json({msg:"Url is null!"})}):o.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,o,s){var t=computePage(e);Application.find(SessionCache.filterApplicationCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications},active:!0})).skip(t.skip).limit(t.limit).populate("profiles default_profile workflows").exec(function(t,n){if(t)return s(t);for(var r=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,a=e.cookies[Constants.SessionCookie],i=n.length-1;i>=0;i--)if(n[i].profiles&&0!=n[i].profiles.length){var u;SessionCache.userData[a].profile.type!=Constants.UserProfilePublic&&(u=n[i].default_profile);for(var d=0;d<r.length;d++)if(r[d].profile.applications[n[i]._id])if(SessionCache.userData[a].profile.type==Constants.UserProfilePublic){if(r[d].type==Constants.UserProfileShare){u=r[d];break}}else if(r[d].type==Constants.UserProfileApplication){u=r[d];break}if(u)for(var d=n[i].workflows.length-1;d>=0;d--)u.profile.applications[n[i]._id].workflows[n[i].workflows[d]._id]||n[i].workflows.splice(d,1)}else SessionCache.userData[a].profile.type==Constants.UserProfilePublic&&n.splice(i,1);o.json(n)})}),router.put("/user/:id",function(e,o,s){var t=e.cookies[Constants.SessionCookie];if(SessionCache.userData[t].profile.type==Constants.UserProfilePublic)return o.status(401).json({errUser:"Not enough user rights"});var n={properties:e.body.properties};e.body.properties||(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),n,function(e,s){return e?o.status(400).json({errUser:e}):(o.json(s),void SessionCache.removeUserCache(t))})}),router.get("/company/:id",function(e,o,s){var t=e.cookies[Constants.SessionCookie];return SessionCache.userData[t].profile.type==Constants.UserProfilePublic?o.status(401).json({errUser:"Not enough user rights"}):void Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,t){return e?s(e):void o.json(t)})}),router.put("/company/:id",function(e,o,s){var t=e.cookies[Constants.SessionCookie];return SessionCache.userData[t].profile.type==Constants.UserProfilePublic?o.status(401).json({errUser:"Not enough user rights"}):void Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,n){return e?s(e):(o.json(n),void SessionCache.removeUserCache(t))})}),router.put("/share",function(e,o,s){var t=e.cookies[Constants.SessionCookie];return SessionCache.userData[t].profile.type==Constants.UserProfilePublic?o.status(401).json({err:"Not enough user rights"}):e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(n,r){if(n)return s(n);if(!r)return o.status(400).json({err:"Invalid parameters!"});var a={name:{en:"Share"},profile:r.profile,properties:r.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[t]._company_code};if(r.properties.user&&r.properties.user==Constants.UserProfilePublic){var i=Object.keys(r.profile.applications)[0],u=Object.keys(r.profile.applications[i].workflows)[0],d="profile.applications."+i+".workflows."+u,c={"properties.user":Constants.UserProfilePublic,_company_code:SessionCache.userData[t]._company_code,type:Constants.UserProfileShare};c[d]=!0,UserProfile.findOne(c,function(n,r){return n?s(n):void(r?(o.status(200).json({msg:"Application shared successfully (existing share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+r._id}),Email.sendSharePublic(SessionCache.userData[t].email,r._id,e.body.app_name,e.body.profile_name)):UserProfile.create(a,function(n,r){return n?s(n):(o.status(200).json({msg:"Application shared successfully (new share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+r._id}),void Email.sendSharePublic(SessionCache.userData[t].email,r._id,e.body.app_name,e.body.profile_name))}))})}else a.profile.datamodels||(a.profile.datamodels={}),a.profile.datamodels[e.query.datamodel_id]={},a.profile.datamodels[e.query.datamodel_id][e.query.data_id]={_company_code:SessionCache.userData[t]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(a,function(n,r){return n?s(n):(o.status(200).json({msg:"Application shared successfully!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+r._id}),void Email.sendShare(e.body.email,SessionCache.userData[t].email,e.query.data_id,r._id))})}):o.status(400).json({err:"Invalid parameters!"})}),router.get("/calendar",function(e,o,s){return e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(t,n){return t?s(err):n?(o.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(n.email,e.query.project_name,e.query.start_date,e.query.end_date,(n.firstname?n.firstname:"")+" "+(n.lastname?n.lastname:""))):o.status(400).json({err:"Invalid parameters!"})}):o.status(400).json({err:"Invalid parameters!"})}),router.put("/notify/:user_id",function(e,o,s){return e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(t,n){return t?s(err):n?(o.status(200).json({msg:"Email sent!"}),void Email.send(n.email,null,e.body.email_title,"Automatic message from App1",e.body.email_html.replace(/@@user/g,(n.firstname?n.firstname:"")+" "+(n.lastname?n.lastname:"")))):o.status(400).json({err:"Invalid parameters!"})}):o.status(400).json({err:"Invalid parameters!"})}),module.exports=router;
