var express=require("express"),router=express.Router(),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),Constants=require("../tools/constants.js"),Email=require("../tools/email.js"),User=Metadata.User,Company=Metadata.Company,UserProfile=Metadata.UserProfile,Application=Metadata.Application,computePage=function(e){return{skip:parseInt(e.query.skip)||Constants.QuerySkip,limit:parseInt(e.query.limit)||Constants.QueryLimit}};router.put("/value/:id",function(e,t,o){var a=computePage(e);if(!e.query.type)return t.status(400).json({msg:"Missing values parameters!"});var s={_id:e.params.id,index:e.body.index,values:[]};if(e.query.type!=Constants.ValuesTypeUser)return e.query.type==Constants.ValuesTypeQuery?t.status(200).json(""):t.status(200).json("");if(!e.body.relation)return t.status(400).json({msg:"Missing values parameters!"});var i=null;e.body.relation==Constants.ValuesRelationUserReports?i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,$or:[{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].reports}},{_id:{$eq:SessionCache.userData[e.cookies[Constants.SessionCookie]]._id}}]}:e.body.relation==Constants.ValuesRelationUserManager?i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].manager}}:e.body.relation==Constants.ValuesRelationUserList&&(i={_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,_id:{$in:e.body.id_list}}),i&&User.find(i,e.body.user_fields).skip(a.skip).limit(a.limit).exec(function(e,a){return e?o(e):a?(s.values=a,t.status(200).json(s)):t.status(400).json({msg:"Url is null!"})})}),router.get("/form/:id",function(e,t,o){return e.params.id?void Metadata.Form.findOne(SessionCache.filterAddProductionCompanyCode(e,{_id:{$eq:e.params.id}})).populate("datamodel values").exec(function(e,a){return e?o(e):a?t.status(200).json(a):t.status(400).json({msg:"Url is null!"})}):t.status(400).json({msg:"Form id is null!"})}),router.get("/application/",function(e,t,o){var a=computePage(e);Application.find(SessionCache.filterAddProductionCompanyCode(e,{_id:{$in:SessionCache.userData[e.cookies[Constants.SessionCookie]].company.applications},active:!0})).skip(a.skip).limit(a.limit).populate("profiles default_profile workflows").exec(function(a,s){if(a)return o(a);for(var i=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,r=e.cookies[Constants.SessionCookie],n=s.length-1;n>=0;n--)if(s[n].profiles&&0!=s[n].profiles.length){var l;SessionCache.userData[r].profile.type!=Constants.UserProfilePublic&&(l=s[n].default_profile);for(var d=0;d<i.length;d++)if(i[d].profile.applications[s[n]._id])if(SessionCache.userData[r].profile.type==Constants.UserProfilePublic){if(i[d].type==Constants.UserProfileShare){l=i[d];break}}else if(i[d].type==Constants.UserProfileApplication){l=i[d];break}if(l&&l.profile.applications[s[n]._id])for(var c=s[n].workflows.length-1;c>=0;c--)l.profile.applications[s[n]._id].workflows[s[n].workflows[c]._id]||s[n].workflows.splice(c,1)}else SessionCache.userData[r].profile.type==Constants.UserProfilePublic&&s.splice(n,1);t.json(s)})}),router.get("/application/:id",function(e,t,o){computePage(e);Application.findOne(SessionCache.filterAddProductionCompanyCode(e,{_id:e.params.id})).populate("profiles default_profile workflows").exec(function(a,s){if(a)return o(a);var i=SessionCache.userData[e.cookies[Constants.SessionCookie]].remote_profiles,r=e.cookies[Constants.SessionCookie];if((!s.profiles||0==s.profiles.length)&&SessionCache.userData[r].profile.type==Constants.UserProfilePublic)return t.json({});var n;SessionCache.userData[r].profile.type!=Constants.UserProfilePublic&&(n=s.default_profile);for(var l=0;l<i.length;l++)if(i[l].profile.applications[s._id])if(SessionCache.userData[r].profile.type==Constants.UserProfilePublic){if(i[l].type==Constants.UserProfileShare){n=i[l];break}}else if(i[l].type==Constants.UserProfileApplication){n=i[l];break}if(n&&n.profile.applications[s._id])for(var d=s.workflows.length-1;d>=0;d--)n.profile.applications[s._id].workflows[s.workflows[d]._id]||s.workflows.splice(d,1);t.json(s)})}),router.put("/user/:id",function(e,t,o){var a=e.cookies[Constants.SessionCookie];if(SessionCache.userData[a].profile.type==Constants.UserProfilePublic)return t.status(401).json({errUser:"Not enough user rights"});var s={properties:e.body.properties};e.body.properties||(e.body.user=e.body.user.toLowerCase()),User.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.params.id}),s,function(e,s){return e?o(e):s?(SessionCache.removeUserCache(a),t.json(s)):t.status(401).json({errUser:"Not enough user rights"})})}),router.get("/company/:id",function(e,t,o){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type==Constants.UserProfilePublic?t.status(401).json({errUser:"Not enough user rights"}):void Company.findOne(SessionCache.filterCompanyCode(e,{_id:e.params.id}),function(e,a){return e?o(e):void t.json(a)})}),router.put("/company/:id",function(e,t,o){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type==Constants.UserProfilePublic?t.status(401).json({errUser:"Not enough user rights"}):void Company.findOneAndUpdate(SessionCache.filterCompanyCode(e,{_id:e.body._id}),e.body,function(e,s){return e?o(e):(t.json(s),void SessionCache.removeUserCache(a))})}),router.put("/share",function(e,t,o){var a=e.cookies[Constants.SessionCookie];return SessionCache.userData[a].profile.type==Constants.UserProfilePublic?t.status(401).json({err:"Not enough user rights"}):e.body.app_profile_id?void UserProfile.findOne({_id:e.body.app_profile_id},function(s,i){if(s)return o(s);if(!i)return t.status(400).json({err:"Invalid parameters!"});var r={name:{en:"Share"},profile:i.profile,properties:i.properties,type:Constants.UserProfileShare,_company_code:SessionCache.userData[a]._company_code};if(i.properties.user&&i.properties.user==Constants.UserProfilePublic){var n=Object.keys(i.profile.applications)[0],l=Object.keys(i.profile.applications[n].workflows)[0],d="profile.applications."+n+".workflows."+l,c={"properties.user":Constants.UserProfilePublic,_company_code:SessionCache.userData[a]._company_code,type:Constants.UserProfileShare};c[d]=!0,UserProfile.findOne(c,function(s,i){return s?o(s):void(i?(t.status(200).json({msg:"Application shared successfully (existing share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),Email.sendSharePublic(SessionCache.userData[a].email,i._id,e.body.app_name,e.body.profile_name)):UserProfile.create(r,function(s,i){return s?o(s):(t.status(200).json({msg:"Application shared successfully (new share)!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),void Email.sendSharePublic(SessionCache.userData[a].email,i._id,e.body.app_name,e.body.profile_name))}))})}else r.profile.datamodels||(r.profile.datamodels={}),r.profile.datamodels[e.query.datamodel_id]={},r.profile.datamodels[e.query.datamodel_id][e.query.data_id]={_company_code:SessionCache.userData[a]._company_code,constraint:{key:e.body.key,value:e.body.value}},UserProfile.create(r,function(s,i){return s?o(s):(t.status(200).json({msg:"Application shared successfully!",share_url:"http://"+Constants.WebAddress+"/authentication/open?pid="+i._id}),void Email.sendShare(e.body.email,SessionCache.userData[a].email,e.query.data_id,i._id))})}):t.status(400).json({err:"Invalid parameters!"})}),router.get("/calendar",function(e,t,o){return e.query.project_name&&e.query.start_date&&e.query.end_date&&e.query.user_id?void User.findOne({_id:e.query.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(a,s){return a?o(a):s?(t.status(200).json({msg:"Calendar sent!"}),void Email.sendCalendar(s.email,e.query.project_name,e.query.start_date,e.query.end_date,(s.firstname?s.firstname:"")+" "+(s.lastname?s.lastname:""))):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})});var computeDateKey=function(e){return[e.getFullYear(),e.getMonth()+1,e.getDate()].join("-")},computeTimeObject=function(e){return 60*e.hours+1*e.minutes},computeTimeDate=function(e){return 60*e.getHours()+e.getMinutes()},checkTimeIntersection=function(e,t,o,a){return computeTimeObject(e)<=computeTimeDate(o)&&computeTimeDate(o)<computeTimeObject(t)?!0:computeTimeDate(o)<=computeTimeObject(e)&&computeTimeObject(e)<computeTimeDate(a)?!0:!1};router.put("/event/:id",function(e,t,o){if(!(e.body.start_time&&e.body.end_time&&e.body.object_name&&e.body.datamodel_id))return t.status(400).json({err:"Invalid parameters!"});var a=new Date(e.body.start_time),s=new Date(e.body.end_time);if(!a||!s||a>=s||a.getTime()+Constants.OneWeek<s.getTime()||a.getDay()>s.getDay())return t.status(400).json({err:"Invalid time parameter!"});var i=e.cookies[Constants.SessionCookie],r=SessionCache.userData[i],n=SessionCache.getProfile(i,e.params.datamodelid),l={},d=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var c=0;c<r.remote_profiles.length;c++)if(r.remote_profiles[c].type==Constants.UserProfileShare&&r.remote_profiles[c].profile.datamodels[e.params.datamodelid]&&r.remote_profiles[c].profile.datamodels[e.params.datamodelid][e.params.id]){l=r.remote_profiles[c].profile.datamodels[e.params.datamodelid][e.params.id],d=!0;break}if(!(n&&n.datamodels[e.body.datamodel_id]&&n.datamodels[e.body.datamodel_id].update&&e.body._user||d))return t.status(401).json({err:"Not enough user rights!"});var p={_id:{$eq:e.params.id}};d?(p._company_code={$eq:l._company_code},p._user={$eq:e.body._user},p[l.constraint.key]={$eq:l.constraint.value}):(p._company_code={$eq:n.datamodels[e.body.datamodel_id].update._company_code},n.datamodels[e.body.datamodel_id].update._user&&(p._user={$in:n.datamodels[e.body.datamodel_id].update._user})),p._updated_at=Date.parse(e.body._updated_at),Metadata.Objects[e.body.datamodel_id].findOne(p,function(i,r){if(i)return o(i);if(r){if(r._appointments||(r._appointments={}),a.getDay()!=s.getDay())return t.status(400);var n=computeDateKey(a);if(!r._appointment_properties||!r._appointment_properties.days)return t.status(400);var l=r._appointment_properties.days[a.getDay()];if(l.enabled&&(computeTimeDate(s)>=computeTimeObject(l.start_time)||computeTimeDate(a)<=computeTimeObject(l.end_time))){computeTimeDate(a)<computeTimeObject(l.start_time)&&(a.setHours(l.start_time.hours),a.setMinutes(l.start_time.minutes)),computeTimeDate(s)>computeTimeObject(l.end_time)&&(s.setHours(l.end_time.hours),s.setMinutes(l.end_time.minutes)),r._appointments[n]||(r._appointments[n]=[]);for(var d=r._appointments[n],c=!0,u=0;u<d.length;u++)if(checkTimeIntersection(d[u].start_time,d[u].end_time,a,s)){c=!1;break}if(!c)return t.status(400);var f=SessionCache.userData[e.cookies[Constants.SessionCookie]];d.push({start_time:{hours:a.getHours()<10?"0"+a.getHours():a.getHours(),minutes:a.getMinutes()<10?"0"+a.getMinutes():a.getMinutes()},end_time:{hours:s.getHours()<10?"0"+s.getHours():s.getHours(),minutes:s.getMinutes()<10?"0"+s.getMinutes():s.getMinutes()},user:{id:f._id,email:f.email,name:(f.firstname?f.firstname:"")+" "+(f.lastname?f.lastname:"")}}),Metadata.Objects[e.body.datamodel_id].findOneAndUpdate(p,r,function(a,s){return a?o(a):(s||(delete p._updated_at,Metadata.Objects[e.body.datamodel_id].findOne(p,function(e,a){return e?o(e):void t.status(400).json(a)})),Email.sendCalendar(f.email,e.body.object_name,e.body.start_time,e.body.end_time,(f.firstname?f.firstname:"")+" "+(f.lastname?f.lastname:"")),t.status(200).json({msg:"Reservation done!"}))})}}else delete p._updated_at,Metadata.Objects[e.body.datamodel_id].findOne(p,function(e,a){return e?o(e):void t.status(400).json(a)})})}),router.put("/notify/:user_id",function(e,t,o){return e.body.email_title&&e.body.email_html?void User.findOne({_id:e.params.user_id,_company_code:SessionCache.userData[e.cookies[Constants.SessionCookie]]._company_code,validated:!0},"email firstname lastname").exec(function(a,s){return a?o(a):s?(t.status(200).json({msg:"Email sent!"}),void Email.send(s.email,null,e.body.email_title,"Automatic message from App1",e.body.email_html.replace(/@@user/g,(s.firstname?s.firstname:"")+" "+(s.lastname?s.lastname:"")))):t.status(400).json({err:"Invalid parameters!"})}):t.status(400).json({err:"Invalid parameters!"})}),module.exports=router;
