var express=require("express"),router=express.Router(),Constants=require("../tools/constants.js"),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),computePage=function(e){return{skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10}};router.get("/:datamodelid/",function(e,a,t){var o=e.cookies[Constants.SessionCookie],s=SessionCache.userData[o],i=SessionCache.getProfile(o,e.params.datamodelid),l={},r=!1;if(s.remote_profiles&&s.remote_profiles.length>0)for(var n=0;n<s.remote_profiles.length;n++)s.remote_profiles[n].type==Constants.UserProfileShare&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid].list&&(l=s.remote_profiles[n].profile.datamodels[e.params.datamodelid].list,r=!0);if(!(i&&i.datamodels[e.params.datamodelid]&&i.datamodels[e.params.datamodelid].list||r))return a.status(401).json({err:"Not enough user rights!"});var d=computePage(e),p=JSON.parse(e.query.sort_by?e.query.sort_by:"{}"),c=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");r?(c._company_code={$eq:l._company_code},l._user&&(c._user={$in:l._user})):(c._company_code={$eq:i.datamodels[e.params.datamodelid].list._company_code},i.datamodels[e.params.datamodelid].list._user&&(c._user={$in:i.datamodels[e.params.datamodelid].list._user}));var f={};e.query.search_text&&""!=e.query.search_text&&(c.$text={$search:e.query.search_text},f={score:{$meta:"textScore"}},p={score:{$meta:"textScore"}}),e.query.populate||(e.query.populate=""),Metadata.Objects[e.params.datamodelid].find(c,f).skip(d.skip).limit(d.limit).populate(e.query.populate).sort(p).exec(function(e,o){return e?t(e):void a.json(o)})}),router.post("/:datamodelid/",function(e,a,t){var o=e.cookies[Constants.SessionCookie],s=SessionCache.userData[o],i=SessionCache.getProfile(o,e.params.datamodelid),l={},r=!1;if(s.remote_profiles&&s.remote_profiles.length>0)for(var n=0;n<s.remote_profiles.length;n++)if(s.remote_profiles[n].type==Constants.UserProfileShare&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid]){if(s.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){l=s.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],r=!0;break}s.remote_profiles[n].profile.datamodels[e.params.datamodelid].create&&(l=s.remote_profiles[n].profile.datamodels[e.params.datamodelid].create,r=!0)}return i&&i.datamodels[e.params.datamodelid]&&i.datamodels[e.params.datamodelid].create||r?(e.body&&(e.body._updated_at=Date.now(),delete e.body._appointments,r?(e.body._company_code=l._company_code,e.body._user=l._user[0]):(e.body._company_code=i.datamodels[e.params.datamodelid].create._company_code,e.body._user=i.datamodels[e.params.datamodelid].create._user[0])),void Metadata.Objects[e.params.datamodelid].create(e.body,function(e,o){return e?t(e):void a.status(200).json({msg:"Data: entry created!",_id:o._id})})):a.status(401).json({err:"Not enough user rights!"})}),router.get("/:datamodelid/:id",function(e,a,t){var o=e.cookies[Constants.SessionCookie],s=SessionCache.userData[o],i=SessionCache.getProfile(o,e.params.datamodelid),l={},r=!1;if(s.remote_profiles&&s.remote_profiles.length>0)for(var n=0;n<s.remote_profiles.length;n++)if(s.remote_profiles[n].type==Constants.UserProfileShare&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){l=s.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],r=!0;break}if(!(i&&i.datamodels[e.params.datamodelid]&&i.datamodels[e.params.datamodelid].read||r))return a.status(401).json({err:"Not enough user rights!"});var d=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");d._id={$eq:e.params.id},r?d._company_code={$eq:l._company_code}:(d._company_code={$eq:i.datamodels[e.params.datamodelid].read._company_code},i.datamodels[e.params.datamodelid].read._user&&(d._user={$in:i.datamodels[e.params.datamodelid].read._user})),e.query.populate||(e.query.populate=""),Metadata.Objects[e.params.datamodelid].findOne(d).populate(e.query.populate).exec(function(e,o){return e?t(e):void a.json(o)})}),router.put("/:datamodelid/:id",function(e,a,t){var o=e.cookies[Constants.SessionCookie],s=SessionCache.userData[o],i=SessionCache.getProfile(o,e.params.datamodelid),l={},r=!1;if(s.remote_profiles&&s.remote_profiles.length>0)for(var n=0;n<s.remote_profiles.length;n++)if(s.remote_profiles[n].type==Constants.UserProfileShare&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&s.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){l=s.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],r=!0;break}if(!(i&&i.datamodels[e.params.datamodelid]&&i.datamodels[e.params.datamodelid].update&&e.body&&e.body._user||r))return a.status(401).json({err:"Not enough user rights!"});var d={_id:{$eq:e.params.id}},p={};r?(d._company_code={$eq:l._company_code},d._user={$eq:e.body._user},p[l.constraint.key]=l.constraint.value):(d._company_code={$eq:i.datamodels[e.params.datamodelid].update._company_code},i.datamodels[e.params.datamodelid].update._user&&(d._user={$in:i.datamodels[e.params.datamodelid].update._user}),p=e.body),d._updated_at=Date.parse(e.body._updated_at),p._updated_at=Date.now(),delete p._appointments,Metadata.Objects[e.params.datamodelid].findOneAndUpdate(d,e.body,function(o,s){return o?t(o):void(s?a.status(200).json({msg:"Data: entry updated!"}):(delete d._updated_at,Metadata.Objects[e.params.datamodelid].findOne(d,function(e,o){return e?t(e):void a.status(400).json(o)})))})}),router["delete"]("/:datamodelid/:id",function(e,a,t){var o=SessionCache.getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid);if(!o||!o.datamodels[e.params.datamodelid]||!o.datamodels[e.params.datamodelid]["delete"])return a.status(401).json({err:"Not enough user rights!"});if(o.datamodels[e.params.datamodelid]["delete"]._user)for(var s=!1,i=0;i<o.datamodels[e.params.datamodelid]["delete"]._user.length;i++){if(o.datamodels[e.params.datamodelid]["delete"]._user[i]==SessionCache.userData[e.cookies[Constants.SessionCookie]]._id){s=!0;break}if(!s)return a.status(401).json({err:"Not enough user rights!"})}Metadata.Objects[e.params.datamodelid].findOneAndRemove({_id:e.params.id,_company_code:o.datamodels[e.params.datamodelid]["delete"]._company_code},function(e,o){return e?t(e):void a.status(200).json({msg:"Data: entry deleted!"})})}),module.exports=router;
