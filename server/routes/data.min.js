var express=require("express"),router=express.Router(),Constants=require("../tools/constants.js"),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),DataModel=Metadata.DataModel,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10}},getDefaultProfile=function(e){return e==Constants.UserProfileAdministrator?Constants.UserProfileAdministratorDefault:e==Constants.UserProfilePrivate?Constants.UserProfilePrivateDefault:e==Constants.UserProfilePublic?Constants.UserProfilePublicDefault:null},getProfile=function(e,a){var s=SessionCache.userData[e],t=s.profile.profile;return t||(t={datamodels:{}}),t.datamodels[a]||(t.datamodels[a]=getDefaultProfile(SessionCache.userData[e].profile.type),s.profile.profile=t,SessionCache.update(e,s),t=SessionCache.userData[e].profile.profile),t};router.get("/:datamodelid/",function(e,a,s){var t=e.cookies[Constants.SessionCookie],r=SessionCache.userData[t],o=getProfile(t,e.params.datamodelid),i={},n=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var d=0;d<r.remote_profiles.length;d++)r.remote_profiles[d].type==Constants.UserProfileShare&&r.remote_profiles[d].profile.datamodels[e.params.datamodelid]&&r.remote_profiles[d].profile.datamodels[e.params.datamodelid].list&&(i=r.remote_profiles[d].profile.datamodels[e.params.datamodelid].list,n=!0);if(!(o&&o.datamodels[e.params.datamodelid]&&o.datamodels[e.params.datamodelid].list||n))return a.status(401).json({err:"Not enough user rights!"});var l=computePage(e),m=JSON.parse(e.query.sort_by?e.query.sort_by:"{}"),u=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");n?(u._company_code={$eq:i._company_code},i._user&&(u._user={$in:i._user})):(u._company_code={$eq:o.datamodels[e.params.datamodelid].list._company_code},o.datamodels[e.params.datamodelid].list._user&&(u._user={$in:o.datamodels[e.params.datamodelid].list._user}));var p={};e.query.search_text&&""!=e.query.search_text&&(u.$text={$search:e.query.search_text},p={score:{$meta:"textScore"}},m={score:{$meta:"textScore"}}),Metadata.Objects[e.params.datamodelid].find(u,p).skip(l.skip).limit(l.limit).sort(m).exec(function(e,t){return e?s(e):void a.json(t)})}),router.post("/:datamodelid/",function(e,a,s){var t=e.cookies[Constants.SessionCookie],r=SessionCache.userData[t],o=getProfile(t,e.params.datamodelid),i={},n=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var d=0;d<r.remote_profiles.length;d++)if(r.remote_profiles[d].type==Constants.UserProfileShare&&r.remote_profiles[d].profile.datamodels[e.params.datamodelid]){if(r.remote_profiles[d].profile.datamodels[e.params.datamodelid][e.params.id]){i=r.remote_profiles[d].profile.datamodels[e.params.datamodelid][e.params.id],n=!0;break}r.remote_profiles[d].profile.datamodels[e.params.datamodelid].create&&(i=r.remote_profiles[d].profile.datamodels[e.params.datamodelid].create,n=!0)}return o&&o.datamodels[e.params.datamodelid]&&o.datamodels[e.params.datamodelid].create||n?(e.body&&(e.body._updated_at=Date.now(),delete e.body._appointments,n?(e.body._company_code=i._company_code,e.body._user=i._user[0]):(e.body._company_code=o.datamodels[e.params.datamodelid].create._company_code,e.body._user=o.datamodels[e.params.datamodelid].create._user[0])),void Metadata.Objects[e.params.datamodelid].create(e.body,function(e,t){return e?s(e):void a.status(200).json({msg:"Data: entry created!",_id:t._id})})):a.status(401).json({err:"Not enough user rights!"})}),router.get("/:datamodelid/:id",function(e,a,s){var t=e.cookies[Constants.SessionCookie],r=SessionCache.userData[t],o=getProfile(t,e.params.datamodelid),i={},n=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var d=0;d<r.remote_profiles.length;d++)if(r.remote_profiles[d].type==Constants.UserProfileShare&&r.remote_profiles[d].profile.datamodels[e.params.datamodelid]){if(r.remote_profiles[d].profile.datamodels[e.params.datamodelid][e.params.id]){i=r.remote_profiles[d].profile.datamodels[e.params.datamodelid][e.params.id],n=!0;break}r.remote_profiles[d].profile.datamodels[e.params.datamodelid].read&&(i=r.remote_profiles[d].profile.datamodels[e.params.datamodelid].read,n=!0)}if(!(o&&o.datamodels[e.params.datamodelid]&&o.datamodels[e.params.datamodelid].read||n))return a.status(401).json({err:"Not enough user rights!"});var l={_id:{$eq:e.params.id}};n?(l._company_code={$eq:i._company_code},l[i.constraint.key]={$eq:i.constraint.value}):(l._company_code={$eq:o.datamodels[e.params.datamodelid].read._company_code},o.datamodels[e.params.datamodelid].read._user&&(l._user={$in:o.datamodels[e.params.datamodelid].read._user})),e.query.populate||(e.query.populate=""),Metadata.Objects[e.params.datamodelid].findOne(l).populate(e.query.populate).exec(function(e,t){return e?s(e):void a.json(t)})}),router.put("/:datamodelid/:id",function(e,a,s){var t=e.cookies[Constants.SessionCookie],r=SessionCache.userData[t],o=getProfile(t,e.params.datamodelid),i={},n=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var d=0;d<r.remote_profiles.length;d++)if(r.remote_profiles[d].type==Constants.UserProfileShare&&r.remote_profiles[d].profile.datamodels[e.params.datamodelid]&&r.remote_profiles[d].profile.datamodels[e.params.datamodelid][e.params.id]){i=r.remote_profiles[d].profile.datamodels[e.params.datamodelid][e.params.id],n=!0;break}if(!(o&&o.datamodels[e.params.datamodelid]&&o.datamodels[e.params.datamodelid].update&&e.body&&e.body._user||n))return a.status(401).json({err:"Not enough user rights!"});var l={_id:{$eq:e.params.id}};n?(l._company_code={$eq:i._company_code},l._user={$eq:e.body._user},l[i.constraint.key]={$eq:i.constraint.value}):(l._company_code={$eq:o.datamodels[e.params.datamodelid].update._company_code},o.datamodels[e.params.datamodelid].update._user&&(l._user={$in:o.datamodels[e.params.datamodelid].update._user})),l._updated_at=Date.parse(e.body._updated_at),e.body._updated_at=Date.now(),delete e.body._appointments,Metadata.Objects[e.params.datamodelid].findOneAndUpdate(l,e.body,function(t,r){return t?s(t):void(r?a.status(200).json({msg:"Data: entry updated!"}):(delete l._updated_at,Metadata.Objects[e.params.datamodelid].findOne(l,function(e,t){return e?s(e):void a.status(400).json(t)})))})}),router["delete"]("/:datamodelid/:id",function(e,a,s){var t=getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid);if(!t||!t.datamodels[e.params.datamodelid]||!t.datamodels[e.params.datamodelid]["delete"])return a.status(401).json({err:"Not enough user rights!"});if(t.datamodels[e.params.datamodelid]["delete"]._user)for(var r=!1,o=0;o<t.datamodels[e.params.datamodelid]["delete"]._user.length;o++){if(t.datamodels[e.params.datamodelid]["delete"]._user[o]==SessionCache.userData[e.cookies[Constants.SessionCookie]]._id){r=!0;break}if(!r)return a.status(401).json({err:"Not enough user rights!"})}Metadata.Objects[e.params.datamodelid].findOneAndRemove({_id:e.params.id,_company_code:t.datamodels[e.params.datamodelid]["delete"]._company_code},function(e,t){return e?s(e):void a.status(200).json({msg:"Data: entry deleted!"})})}),module.exports=router;
