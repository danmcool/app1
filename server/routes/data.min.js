var express=require("express"),router=express.Router(),Constants=require("../tools/constants.js"),Metadata=require("../models/metadata.js"),SessionCache=require("../tools/session_cache.js"),DataModel=Metadata.DataModel,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10}};router.get("/:datamodelid/",function(e,a,o){var s=e.cookies[Constants.SessionCookie],r=SessionCache.userData[s],t=SessionCache.getProfile(s,e.params.datamodelid),d={},i=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var n=0;n<r.remote_profiles.length;n++)r.remote_profiles[n].type==Constants.UserProfileShare&&r.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&r.remote_profiles[n].profile.datamodels[e.params.datamodelid].list&&(d=r.remote_profiles[n].profile.datamodels[e.params.datamodelid].list,i=!0);if(!(t&&t.datamodels[e.params.datamodelid]&&t.datamodels[e.params.datamodelid].list||i))return a.status(401).json({err:"Not enough user rights!"});var m=computePage(e),l=JSON.parse(e.query.sort_by?e.query.sort_by:"{}"),p=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");i?(p._company_code={$eq:d._company_code},d._user&&(p._user={$in:d._user})):(p._company_code={$eq:t.datamodels[e.params.datamodelid].list._company_code},t.datamodels[e.params.datamodelid].list._user&&(p._user={$in:t.datamodels[e.params.datamodelid].list._user}));var c={};e.query.search_text&&""!=e.query.search_text&&(p.$text={$search:e.query.search_text},c={score:{$meta:"textScore"}},l={score:{$meta:"textScore"}}),Metadata.Objects[e.params.datamodelid].find(p,c).skip(m.skip).limit(m.limit).sort(l).exec(function(e,s){return e?o(e):void a.json(s)})}),router.post("/:datamodelid/",function(e,a,o){var s=e.cookies[Constants.SessionCookie],r=SessionCache.userData[s],t=SessionCache.getProfile(s,e.params.datamodelid),d={},i=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var n=0;n<r.remote_profiles.length;n++)if(r.remote_profiles[n].type==Constants.UserProfileShare&&r.remote_profiles[n].profile.datamodels[e.params.datamodelid]){if(r.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){d=r.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],i=!0;break}r.remote_profiles[n].profile.datamodels[e.params.datamodelid].create&&(d=r.remote_profiles[n].profile.datamodels[e.params.datamodelid].create,i=!0)}return t&&t.datamodels[e.params.datamodelid]&&t.datamodels[e.params.datamodelid].create||i?(e.body&&(e.body._updated_at=Date.now(),delete e.body._appointments,i?(e.body._company_code=d._company_code,e.body._user=d._user[0]):(e.body._company_code=t.datamodels[e.params.datamodelid].create._company_code,e.body._user=t.datamodels[e.params.datamodelid].create._user[0])),void Metadata.Objects[e.params.datamodelid].create(e.body,function(e,s){return e?o(e):void a.status(200).json({msg:"Data: entry created!",_id:s._id})})):a.status(401).json({err:"Not enough user rights!"})}),router.get("/:datamodelid/:id",function(e,a,o){var s=e.cookies[Constants.SessionCookie],r=SessionCache.userData[s],t=SessionCache.getProfile(s,e.params.datamodelid),d={},i=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var n=0;n<r.remote_profiles.length;n++)if(r.remote_profiles[n].type==Constants.UserProfileShare&&r.remote_profiles[n].profile.datamodels[e.params.datamodelid]){if(r.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){d=r.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],i=!0;break}r.remote_profiles[n].profile.datamodels[e.params.datamodelid].read&&(d=r.remote_profiles[n].profile.datamodels[e.params.datamodelid].read,i=!0)}if(!(t&&t.datamodels[e.params.datamodelid]&&t.datamodels[e.params.datamodelid].read||i))return a.status(401).json({err:"Not enough user rights!"});var m={_id:{$eq:e.params.id}};i?(m._company_code={$eq:d._company_code},m[d.constraint.key]={$eq:d.constraint.value}):(m._company_code={$eq:t.datamodels[e.params.datamodelid].read._company_code},t.datamodels[e.params.datamodelid].read._user&&(m._user={$in:t.datamodels[e.params.datamodelid].read._user})),e.query.populate||(e.query.populate=""),Metadata.Objects[e.params.datamodelid].findOne(m).populate(e.query.populate).exec(function(e,s){return e?o(e):void a.json(s)})}),router.put("/:datamodelid/:id",function(e,a,o){var s=e.cookies[Constants.SessionCookie],r=SessionCache.userData[s],t=SessionCache.getProfile(s,e.params.datamodelid),d={},i=!1;if(r.remote_profiles&&r.remote_profiles.length>0)for(var n=0;n<r.remote_profiles.length;n++)if(r.remote_profiles[n].type==Constants.UserProfileShare&&r.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&r.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){d=r.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],i=!0;break}if(!(t&&t.datamodels[e.params.datamodelid]&&t.datamodels[e.params.datamodelid].update&&e.body&&e.body._user||i))return a.status(401).json({err:"Not enough user rights!"});var m={_id:{$eq:e.params.id}};i?(m._company_code={$eq:d._company_code},m._user={$eq:e.body._user},m[d.constraint.key]={$eq:d.constraint.value}):(m._company_code={$eq:t.datamodels[e.params.datamodelid].update._company_code},t.datamodels[e.params.datamodelid].update._user&&(m._user={$in:t.datamodels[e.params.datamodelid].update._user})),m._updated_at=Date.parse(e.body._updated_at),e.body._updated_at=Date.now(),delete e.body._appointments,Metadata.Objects[e.params.datamodelid].findOneAndUpdate(m,e.body,function(s,r){return s?o(s):void(r?a.status(200).json({msg:"Data: entry updated!"}):(delete m._updated_at,Metadata.Objects[e.params.datamodelid].findOne(m,function(e,s){return e?o(e):void a.status(400).json(s)})))})}),router["delete"]("/:datamodelid/:id",function(e,a,o){var s=SessionCache.getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid);if(!s||!s.datamodels[e.params.datamodelid]||!s.datamodels[e.params.datamodelid]["delete"])return a.status(401).json({err:"Not enough user rights!"});if(s.datamodels[e.params.datamodelid]["delete"]._user)for(var r=!1,t=0;t<s.datamodels[e.params.datamodelid]["delete"]._user.length;t++){if(s.datamodels[e.params.datamodelid]["delete"]._user[t]==SessionCache.userData[e.cookies[Constants.SessionCookie]]._id){r=!0;break}if(!r)return a.status(401).json({err:"Not enough user rights!"})}Metadata.Objects[e.params.datamodelid].findOneAndRemove({_id:e.params.id,_company_code:s.datamodels[e.params.datamodelid]["delete"]._company_code},function(e,s){return e?o(e):void a.status(200).json({msg:"Data: entry deleted!"})})}),module.exports=router;
