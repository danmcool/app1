var express=require("express"),router=express.Router(),Constants=require("../tools/constants.min.js"),Metadata=require("../models/metadata.min.js"),SessionCache=require("../tools/session_cache.min.js"),DataModel=Metadata.DataModel,computePage=function(e){return pageOptions={skip:parseInt(e.query.skip)||0,limit:parseInt(e.query.limit)||10}},getDefaultProfile=function(e){return e==Constants.UserProfileAdministrator?Constants.UserProfileAdministratorDefault:e==Constants.UserProfilePrivate?Constants.UserProfilePrivateDefault:e==Constants.UserProfilePublic?Constants.UserProfilePublicDefault:null},getProfile=function(e,s){var a=SessionCache.userData[e],o=a.profile.profile;return o||(o={datamodels:{}}),o.datamodels[s]||(o.datamodels[s]=getDefaultProfile(SessionCache.userData[e].profile.type),a.profile.profile=o,SessionCache.update(e,a),o=SessionCache.userData[e].profile.profile),o};router.get("/:datamodelid/",function(e,s,a){var o=getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid);if(!o||!o.datamodels[e.params.datamodelid]||!o.datamodels[e.params.datamodelid].list)return s.status(401).json({err:"Not enough user rights!"});var t=computePage(e),i=JSON.parse(e.query.sort_by?e.query.sort_by:"{}"),r=JSON.parse(e.query.search_criteria?e.query.search_criteria:"{}");r._company_code={$eq:o.datamodels[e.params.datamodelid].list._company_code},o.datamodels[e.params.datamodelid].list._user&&(r._user={$in:o.datamodels[e.params.datamodelid].list._user}),Metadata.Objects[e.params.datamodelid].find(r).skip(t.skip).limit(t.limit).sort(i).exec(function(e,o){return e?a(e):void s.json(o)})}),router.post("/:datamodelid/",function(e,s,a){var o=getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid);return o&&o.datamodels[e.params.datamodelid]&&o.datamodels[e.params.datamodelid].create?(e.body&&(e.body._updated_at=Date.now(),e.body._company_code=o.datamodels[e.params.datamodelid].create._company_code,e.body._user=o.datamodels[e.params.datamodelid].create._user[0]),void Metadata.Objects[e.params.datamodelid].create(e.body,function(e,o){return e?a(e):void s.status(200).json({msg:"Data: entry created!"})})):s.status(401).json({err:"Not enough user rights!"})}),router.get("/:datamodelid/:id",function(e,s,a){var o=SessionCache.userData[e.cookies[Constants.SessionCookie]],t=getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid),i={},r=!1;if(o.remote_profiles&&o.remote_profiles.length>0)for(var n=0;n<o.remote_profiles.length;n++)if(o.remote_profiles[n].type==Constants.UserProfileShare&&o.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&o.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){i=o.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],r=!0;break}if(!(t&&t.datamodels[e.params.datamodelid]&&t.datamodels[e.params.datamodelid].read||r))return s.status(401).json({err:"Not enough user rights!"});var u={_id:{$eq:e.params.id}};r?(u._company_code={$eq:i._company_code},u[i.constraint.key]={$eq:i.constraint.value}):(u._company_code={$eq:t.datamodels[e.params.datamodelid].read._company_code},t.datamodels[e.params.datamodelid].read._user&&(u._user={$in:t.datamodels[e.params.datamodelid].read._user})),Metadata.Objects[e.params.datamodelid].findOne(u).populate("_files").exec(function(e,o){return e?a(e):void s.json(o)})}),router.put("/:datamodelid/:id",function(e,s,a){var o=SessionCache.userData[e.cookies[Constants.SessionCookie]],t=getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid),i={},r=!1;if(o.remote_profiles&&o.remote_profiles.length>0)for(var n=0;n<o.remote_profiles.length;n++)if(o.remote_profiles[n].type==Constants.UserProfileShare&&o.remote_profiles[n].profile.datamodels[e.params.datamodelid]&&o.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id]){i=o.remote_profiles[n].profile.datamodels[e.params.datamodelid][e.params.id],r=!0;break}if(!(t&&t.datamodels[e.params.datamodelid]&&t.datamodels[e.params.datamodelid].update&&e.body._user||r))return s.status(401).json({err:"Not enough user rights!"});var u={_id:{$eq:e.params.id}};r?(u._company_code={$eq:i._company_code},u._user={$eq:e.body._user},u[i.constraint.key]={$eq:i.constraint.value}):(u._company_code={$eq:t.datamodels[e.params.datamodelid].update._company_code},t.datamodels[e.params.datamodelid].update._user&&(u._user={$in:t.datamodels[e.params.datamodelid].update._user})),u._updated_at=Date.parse(e.body._updated_at),e.body._updated_at=Date.now(),Metadata.Objects[e.params.datamodelid].findOneAndUpdate(u,e.body,function(o,t){return o?a(o):void(t?s.status(200).json({msg:"Data: entry updated!"}):(delete u._updated_at,Metadata.Objects[e.params.datamodelid].findOne(u,function(e,o){return e?a(e):void s.status(400).json(o)})))})}),router["delete"]("/:datamodelid/:id",function(e,s,a){var o=getProfile(e.cookies[Constants.SessionCookie],e.params.datamodelid);if(!o||!o.datamodels[e.params.datamodelid]||!o.datamodels[e.params.datamodelid]["delete"])return s.status(401).json({err:"Not enough user rights!"});if(o.datamodels[e.params.datamodelid]["delete"]._user)for(var t=!1,i=0;i<o.datamodels[e.params.datamodelid]["delete"]._user.length;i++){if(o.datamodels[e.params.datamodelid]["delete"]._user[i]==SessionCache.userData[e.cookies[Constants.SessionCookie]]._id){t=!0;break}if(!t)return s.status(401).json({err:"Not enough user rights!"})}Metadata.Objects[e.params.datamodelid].findOneAndRemove({_id:e.params.id,_company_code:o.datamodels[e.params.datamodelid]["delete"]._company_code},function(e,o){return e?a(e):void s.status(200).json({msg:"Data: entry deleted!"})})}),module.exports=router;
