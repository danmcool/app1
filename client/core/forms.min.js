app1.controller("FormDetailsCtrl",["$scope","$routeParams","$location","$route","$resource","$mdDialog","SessionService","MapService","Forms","Value","Files","Datas","Share","Calendar","Notify",function($scope,$routeParams,$location,$route,$resource,$mdDialog,SessionService,MapService,Forms,Value,Files,Datas,Share,Calendar,Notify){$scope.sessionData=SessionService.getSessionData(),$scope.$watch(function(){return SessionService.getSessionData()},function(e,o){e!=o&&($scope.sessionData=e,updateAppName())}),$scope.resolvePath=function(e,o){return o.split(".").reduce(function(e,o){return e?e[o]:void 0},e)},$scope.resolvePathUpdate=function(e,o,t){o.split(".").reduce(function(e,o,s,n){return s<n.length-1?(e[o]||(e[o]={}),e[o]):void(e[o]=t)},e)};var toString=function(e){return e?e+"":""},updateAppName=function(){var e=$scope.sessionData.applications;if(e)for(var o=0;o<e.length;o++)if(e[o]._id==$routeParams.application_id){$scope.sessionData.applicationName=SessionService.translate(e[o].name),$scope.sessionData.application_id=$routeParams.application_id,SessionService.setSessionData($scope.sessionData);break}};$scope.data={},$scope.localdata={},$scope.form={},$scope.skip=0,$scope.limit=10,$scope.datas=[],$scope.stopScroll=!1,$scope.tempStopScroll=!1,$scope.files=[],$scope.currentFile=0,$scope.filesCount=0,$scope.search_criteria="",$scope.show_search=!1,$scope.search_text="",$scope.formLoaded=!1,$scope.getNextData=function(){if($scope.formLoaded&&!$scope.stopScroll&&!$scope.tempStopScroll&&$scope.form.datamodel){var e=$scope.limit,o=$scope.skip;$scope.skip+=$scope.limit,$scope.tempStopScroll=!0,Datas.query({datamodel_id:$scope.form.datamodel._id,search_criteria:$scope.search_criteria,search_text:$scope.search_text,skip:o,limit:e,sort_by:$scope.form.sort_by}).$promise.then(function(e){e.length<$scope.limit&&($scope.stopScroll=!0);for(var o=0;o<e.length;o++)$scope.datas.push(e[o]);$scope.tempStopScroll=!1})}};var initText=function(){if($scope.form.title=SessionService.translate($scope.form.name),$scope.form.actions)for(var e=0;e<$scope.form.actions.length;e++)$scope.form.actions[e].translated_name=SessionService.translate($scope.form.actions[e].name);if($scope.form.fields)for(var o=$scope.form.fields,e=0;e<o.length;e++){if("address"==o[e].display)for(var t=Object.keys($scope.form.datamodel.projection),s=0;s<t.length;s++){var n=$scope.form.datamodel.projection[t[s]];n.path==o[e].full_path&&("address_line1"==n.technical_name?o[e].address_line1_translated_name=SessionService.translate(n.name):"address_line2"==n.technical_name?o[e].address_line2_translated_name=SessionService.translate(n.name):"address_city"==n.technical_name?o[e].address_city_translated_name=SessionService.translate(n.name):"address_state"==n.technical_name?o[e].address_state_translated_name=SessionService.translate(n.name):"address_postal_code"==n.technical_name?o[e].address_postal_code_translated_name=SessionService.translate(n.name):"address_country"==n.technical_name&&(o[e].address_country_translated_name=SessionService.translate(n.name)))}else if(("list"==o[e].display||"item"==o[e].display)&&o[e].item_actions)for(var s=0;s<o[e].item_actions.length;s++)o[e].item_actions[s].translated_name=SessionService.translate(o[e].item_actions[s].name);o[e].text&&""!=o[e].text?o[e].translated_name=SessionService.translate(o[e].text):o[e].translated_name=SessionService.translate($scope.form.datamodel.projection[o[e].name]),o[e].previous&&(o[e].translated_previous=SessionService.translate(o[e].previous))}},updateValuesForm=function(e,o){var t=$scope.form.fields[e];for(t.values=[],t.values_key={},k=0;k<o.length;k++)t.values.push({_id:o[k]._id,name:SessionService.translate(o[k].name)}),t.values_key[o[k]._id]=SessionService.translate(o[k])},updateValuesTitle=function(e,o){var t=$scope.form.fields[e];for(t.title_values={},k=0;k<o.length;k++)t.title_values[o[k]._id]=SessionService.translate(o[k].name)},updateValuesSubTitle=function(e,o){var t=$scope.form.fields[e];for(t.subtitle_values={},k=0;k<o.length;k++)t.subtitle_values[o[k]._id]=SessionService.translate(o[k].name)},updateValuesItems=function(e,o){var t=$scope.form.fields[e],s=t.items+"_values";t[s]=o,$scope.data[t.items]=o},initComponents=function(){for(var formFields=$scope.form.fields,formValues=$scope.form.values,i=0;i<formFields.length;i++)if("address"==formFields[i].display){if($scope.localdata[formFields[i].id]=$scope.resolvePath($scope.data,formFields[i].full_path),formFields[i].disabled){MapService.initMap("map"+field_id);var address=$scope.localdata[formFields[i].id];MapService.geocodeAddress("map"+formFields[i].full_path,(address.address_line1?address.address_line1+",":"")+(address.address_line2?address.address_line2+",":"")+(address.address_city?address.address_city+",":"")+(address.address_postal_code?address.address_postal_code+",":"")+(address.address_country?address.address_country+",":""))}}else if("selection"==formFields[i].display||"currency"==formFields[i].display){$scope.localdata[formFields[i].id]=$scope.resolvePath($scope.data,formFields[i].full_path);for(var j=0;j<formValues.length;j++)if(formFields[i].listofvalues==formValues[j]._id){if("list"==formValues[j].type)updateValuesForm(i,formValues[j].values);else{var itemValues=formValues[j].values;itemValues.index=i,Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesForm(e.index,e.values)})}break}}else if("calendar"==formFields[i].display)$scope.localdata[formFields[i].id]=$scope.resolvePath($scope.data,formFields[i].full_path),$scope.localdata[formFields[i].id]&&($scope.localdata[formFields[i].id]=new Date($scope.localdata[formFields[i].full_path]));else if("calculation"==formFields[i].display){var data=$scope.data;$scope.localdata[formFields[i].id]=eval(formFields[i].calculation)}else if("list"==formFields[i].display){$scope.show_search=!0;for(var j=0;j<formValues.length;j++)if(formFields[i].title_listofvalues==formValues[j]._id)if("list"==formValues[j].type)updateValuesTitle(i,formValues[j].values);else{var itemValues=formValues[j].values;itemValues.index=i,Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesTitle(e.index,e.values)})}else if(formFields[i].subtitle_listofvalues==formValues[j]._id)if("list"==formValues[j].type)updateValuesSubTitle(i,formValues[j].values);else{var itemValues=formValues[j].values;itemValues.index=i,Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesSubTitle(e.index,e.values)})}$scope.form.search_criteria&&($scope.search_criteria=$scope.form.search_criteria),$scope.search_criteria=$scope.search_criteria.replace(/@_user_id/g,$scope.sessionData.userData._id);var keysOfParameters=Object.keys($routeParams);for(k=0,l=keysOfParameters.length;k<l;k++)$scope.search_criteria=$scope.search_criteria.replace("@"+keysOfParameters[k],$routeParams[keysOfParameters[k]]);$scope.formLoaded=!0,$scope.getNextData()}else if("item"==formFields[i].display){for(var j=0;j<formValues.length;j++)if(formFields[i].listofvalues==formValues[j]._id)if("list"==formValues[j].type)updateValuesItems(i,formValues[j].values);else{var itemValues={index:i};itemValues.relation=formValues[j].values.relation,itemValues.id_list=$scope.data[formFields[i].items],Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesItems(e.index,e.values)})}}else $scope.localdata[formFields[i].id]=$scope.resolvePath($scope.data,formFields[i].full_path)};Forms.get({id:$routeParams.id},function(e){$scope.form=e;var o=$scope.form.display;if($scope.form.fields=[],o)for(var t=0;t<o.length;t++)for(var s=0;s<o[t].blocks.length;s++)for(var n=0;n<o[t].blocks[s].fields.length;n++)$scope.form.fields.push(o[t].blocks[s].fields[n]);updateAppName(),initText(),$scope.form.datamodel&&("0"==$routeParams.entry_id?($scope.data=new Datas({datamodel_id:$scope.form.datamodel._id,_files:[]}),initComponents()):Datas.get({datamodel_id:$scope.form.datamodel._id,entry_id:$routeParams.entry_id},function(e){$scope.data=e,initComponents()}))});var rand=function(){return Math.random().toString(16).substr(2)},gotoNextForm=function(e,o,t){if("home"==o)SessionService.location("/workflows/"+$scope.sessionData.application_id);else{var s="/form/"+o+"/";if(t&&t._id){if(s=s+t._id+"?application_id="+$routeParams.application_id,e)for(keys=Object.keys(e),i=0;i<keys.length;i++)s=s+"&"+e[keys[i]]+"="+t[e[keys[i]]]}else s=s+"0?application_id="+$routeParams.application_id;s!=$location.path()?SessionService.location(s):$route.reload()}};$scope.uploadFile=function(e,o,t){const s=new XMLHttpRequest;s.open("PUT",o),s.onreadystatechange=function(){4==s.readyState&&(200==s.status?($scope.currentFile++,$scope.currentFile>$scope.filesCount?(document.getElementById("file_upload").textContent=$scope.sessionData.appData.uploading_done,setTimeout(function(){document.getElementById("file_upload").textContent=""},4e3)):document.getElementById("file_upload").textContent=$scope.sessionData.appData.uploading_in_progress+" "+$scope.currentFile+"/"+$scope.filesCount):alert("Could not upload file."))},s.send(e)},$scope.changeFiles=function(e){if(0!=e.length)for($scope.data._files||($scope.data._files=[]),$scope.files||($scope.files=[]),$scope.filesCount=e.length,$scope.currentFile=1,document.getElementById("file_upload").textContent=$scope.sessionData.appData.uploading_in_progress+" "+$scope.currentFile+"/"+$scope.filesCount,i=0;i<$scope.filesCount;i++){$scope.files.push(e[i]);var o=new Files({name:e[i].name,type:e[i].type});o.$save().then(function(o){for(var t=0;t<$scope.files.length;t++)$scope.files[t].name==o.file.name&&($scope.data._files.push({_id:o.file._id,name:o.file.name,type:o.file.type}),$scope.uploadFile(e[t],o.signedRequest,o.url))})}},$scope.removeFile=function(e){for(var o=$scope.data._files,t=0;t<o.length;t++)if(o[t]._id==e){o.splice(t,1),Files.remove({id:e}).$promise.then(function(e){})["catch"](function(e){});break}};var updateComponents=function(e,o,t){t._user=$scope.sessionData.userData._id;for(var s=$scope.form.fields,n=0;n<s.length;n++)"feed"==s[n].display?e.newvalues&&e.newvalues[s[n].id]&&e.newvalues[s[n].id].length>0&&($scope.localdata[s[n].id]||($scope.localdata[s[n].id]=[]),$scope.localdata[s[n].id].push({text:e.newvalues[s[n].id],from:$scope.sessionData.userData.name,user:$scope.sessionData.userData.user,date:Date.now()})):"list"!=s[n].display&&"item"!=s[n].display&&$scope.resolvePathUpdate(t,s[n].full_path,$scope.localdata[s[n].id]);o&&$scope.resolvePathUpdate(t,o.full_path,o.value)},updateErrorAlert=function(){$mdDialog.show($mdDialog.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.new_document_version).textContent($scope.sessionData.appData.already_modified_document).ok($scope.sessionData.appData.ok))},notify=function(e,o,t,s){if(e){var n;if("current"==e)n=$scope.sessionData.userData._id;else if("owner"==e)n=$scope.data._user;else{if("item"!=e)return;n=itemId}if(n&&o&&t){for(var a=SessionService.translate(t),i=a.match(/@\w*@/g),r=0;r<i.length;r++)"@@"!=i[r]&&(a=a.replace(new RegExp(i[r],"g"),$scope.data[i[r].replace(/@/g,"")]));Notify.update({user_id:n},{email_title:SessionService.translate(o),email_html:a})}}};$scope.create=function(e,o,t,s,n,a,i){updateComponents($scope.form,t,$scope.data),$scope.data.$save().then(function(t){notify(n,a,i),gotoNextForm(e,o,s?t:null)})["catch"](function(e){$scope.data=e.data})},$scope.modify=function(e,o,t,s,n,a,i){updateComponents($scope.form,t,$scope.data),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id},$scope.data).$promise.then(function(t){notify(n,a,i),gotoNextForm(e,o,s?t:null)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope["delete"]=function(e,o,t,s,n){$mdDialog.show($mdDialog.confirm().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.confirmation).textContent($scope.sessionData.appData.removal_confirmation).ok($scope.sessionData.appData.ok).cancel($scope.sessionData.appData.cancel)).then(function(){Datas.remove({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id}).$promise.then(function(a){notify(t,s,n),gotoNextForm(e,o,null)})["catch"](function(e){})})},$scope.link=function(e,o,t,s,n,a){notify(s,n,a),gotoNextForm(e,o,t?$scope.data:null)},$scope.subscribe=function(e,o,t,s,n,a,i,r){updateComponents($scope.form,t,$scope.data),$scope.resolvePath($scope.data,actionItem).push($scope.sessionData.userData._id),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:data._id},$scope.data).$promise.then(function(t){notify(a,i,r),gotoNextForm(e,o,s?$scope.data:null)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.unsubscribe=function(e,o,t,s,n,a,i,r){updateComponents($scope.form,t,$scope.data);for(var d=$scope.resolvePath($scope.data,n),u=d.length-1;u>=0;u--)(d[u]==$scope.sessionData.userData._id||d[u]._id==$scope.sessionData.userData._id)&&d.splice(u,1);Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id},$scope.data).$promise.then(function(t){notify(a,i,r),gotoNextForm(e,o,s?$scope.data:null)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.deleteItem=function(e,o,t,s,n,a,i,r){$mdDialog.show($mdDialog.confirm().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.confirmation).textContent($scope.sessionData.appData.removal_confirmation).ok($scope.sessionData.appData.ok).cancel($scope.sessionData.appData.cancel)).then(function(){updateComponents($scope.form,t,$scope.data);for(var d=$scope.resolvePath($scope.data,s),u=d.length-1;u>=0;u--)(d[u]==n||d[u]._id==n)&&d.splice(u,1);Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id},$scope.data).$promise.then(function(t){notify(a,i,r,n),gotoNextForm(e,o,$scope.data)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})})},$scope.moveItem=function(e,o,t,s,n,a,i,r,d){updateComponents($scope.form,t,$scope.data);for(var u=$scope.resolvePath($scope.data,s),c=u.length-1;c>=0;c--)(u[c]==n||u[c]._id==n)&&u.splice(c,1);$scope.resolvePath($scope.data,a).push(n),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id},$scope.data).$promise.then(function(t){notify(i,r,d,n),gotoNextForm(e,o,$scope.data)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.modifyList=function(e,o,t,s,n,a,i){updateComponents($scope.form,t,s),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:s._id},s).$promise.then(function(t){notify(n,a,i),gotoNextForm(e,o,t)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.deleteList=function(e,o,t,s,n,a){$mdDialog.show($mdDialog.confirm().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.confirmation).textContent($scope.sessionData.appData.removal_confirmation).ok($scope.sessionData.appData.ok).cancel($scope.sessionData.appData.cancel)).then(function(){Datas.remove({datamodel_id:$scope.form.datamodel._id,entry_id:t._id}).$promise.then(function(t){notify(s,n,a),gotoNextForm(e,o,null)})["catch"](function(e){})})},$scope.linkList=function(e,o,t,s,n,a){notify(s,n,a),gotoNextForm(e,o,t)},$scope.download=function(e,o,t){for(var s="sep=,\n",n=0;n<o.attributes.length;n++)s+='"'+o.attributes[n]+'","'+toString($scope.resolvePath(e,o.attributes[n])).replace(/\"/g,'""')+'"\n';for(var n=0;n<o.items.length;n++)if(s+='"'+o.items[n].name+'","'+e[o.items[n].name].length+'"\n',e[o.items[n].name].length>0){for(var a=0;a<o.items[n].attributes.length;a++)s+='"'+o.items[n].attributes[a]+'",';s+="\n";for(var i=$scope.resolvePath(e,o.items[n].name),r=0;r<i.length;r++){for(var a=0;a<o.items[n].attributes.length;a++)s+='"'+toString($scope.resolvePath(i[r],o.items[n].attributes[a])).replace(/\"/g,'""')+'",';s+="\n"}}var d=document.createElement("a");if(d.setAttribute("target","_blank"),void 0!==Blob){var u=new Blob([s],{type:"text/csv"});d.setAttribute("href",URL.createObjectURL(u)),navigator.msSaveBlob?navigator.msSaveBlob(u,e[t]+".csv"):(d.setAttribute("download",e[t]+".csv"),d.click())}else d.setAttribute("href","data:text/csv,"+encodeURIComponent(s)),d.setAttribute("download",e[t]+".csv"),document.body.appendChild(d),d.click(),document.body.removeChild(d)},$scope.share=function(e,o,t,s,n,a,i){updateComponents($scope.form,t,i),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:i._id},i).$promise.then(function(t){Share.update({form_id:a,datamodel_id:$scope.form.datamodel._id,data_id:i._id,email:i[n],key:s.key,value:s.value}).$promise.then(function(t){gotoNextForm(e,o,i)})})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.calendar=function(e,o,t,s,n,a,i){updateComponents($scope.form,t,i),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:i._id},i).$promise.then(function(t){Calendar.get({project_name:i[s],start_date:i[n],end_date:i[a],user_id:i._user}).$promise.then(function(t){gotoNextForm(e,o,i)})})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.search=function(e){e||(e=""),$scope.search_text=e,$scope.skip=0,$scope.limit=10,$scope.stopScroll=!1,$scope.tempStopScroll=!1,$scope.datas=[],$scope.getNextData()}}]);
