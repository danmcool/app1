app1.controller("FormDetailsCtrl",["$scope","$routeParams","$location","$route","$resource","$mdDialog","SessionService","MapService","Forms","Value","Files","Datas","Share","Calendar","Notify",function($scope,$routeParams,$location,$route,$resource,$mdDialog,SessionService,MapService,Forms,Value,Files,Datas,Share,Calendar,Notify){$scope.sessionData=SessionService.getSessionData(),$scope.$watch(function(){return SessionService.getSessionData()},function(e,t){e!=t&&($scope.sessionData=e,updateAppName())});var resolvePath=function(e,t){return t.split(".").reduce(function(e,t){return e?e[t]:void 0},e||self)},toString=function(e){return e?e+="":e="",e},updateAppName=function(){var e=$scope.sessionData.applications;if(e)for(var t=0;t<e.length;t++)if(e[t]._id==$routeParams.application_id){$scope.sessionData.applicationName=SessionService.translate(e[t].name),$scope.sessionData.application_id=$routeParams.application_id,SessionService.setSessionData($scope.sessionData);break}};$scope.data={},$scope.form={},$scope.skip=0,$scope.limit=10,$scope.datas=[],$scope.stopScroll=!1,$scope.tempStopScroll=!1,$scope.files=[],$scope.currentFile=0,$scope.filesCount=0,$scope.search_criteria="",$scope.show_search=!1,$scope.search_text="",$scope.formLoaded=!1,$scope.getNextData=function(){if($scope.formLoaded&&!$scope.stopScroll&&!$scope.tempStopScroll&&$scope.form.datamodel){var e=$scope.limit,t=$scope.skip;$scope.skip+=$scope.limit,$scope.tempStopScroll=!0,Datas.query({datamodel_id:$scope.form.datamodel._id,search_criteria:$scope.search_criteria,search_text:$scope.search_text,skip:t,limit:e,sort_by:$scope.form.sort_by}).$promise.then(function(e){e.length<$scope.limit&&($scope.stopScroll=!0);for(var t=0;t<e.length;t++)$scope.datas.push(e[t]);$scope.tempStopScroll=!1})}};var initText=function(){if($scope.form.title=SessionService.translate($scope.form.name),$scope.form.actions)for(var e=0;e<$scope.form.actions.length;e++)$scope.form.actions[e].translated_name=SessionService.translate($scope.form.actions[e].name);if($scope.form.fields)for(var t=$scope.form.fields,e=0;e<t.length;e++){if("address"==t[e].display)t[e].address_line1_translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name].address_line1),t[e].address_line2_translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name].address_line2),t[e].address_city_translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name].address_city),t[e].address_state_translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name].address_state),t[e].address_postal_code_translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name].address_postal_code),t[e].address_country_translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name].address_country);else if(("list"==t[e].display||"item"==t[e].display)&&t[e].item_actions)for(var a=0;a<t[e].item_actions.length;a++)t[e].item_actions[a].translated_name=SessionService.translate(t[e].item_actions[a].name);t[e].text?t[e].translated_name=SessionService.translate(t[e].text):t[e].translated_name=SessionService.translate($scope.form.datamodel.translation[t[e].name]),t[e].previous&&(t[e].translated_previous=SessionService.translate(t[e].previous))}},updateValuesForm=function(e,t){var a=$scope.form.fields[e];for(a.values=[],a.values_key={},k=0;k<t.length;k++)a.values.push({_id:t[k]._id,name:SessionService.translate(t[k].name)}),a.values_key[t[k]._id]=SessionService.translate(t[k])},updateValuesTitle=function(e,t){var a=$scope.form.fields[e];for(a.title_values={},k=0;k<t.length;k++)a.title_values[t[k]._id]=SessionService.translate(t[k].name)},updateValuesSubTitle=function(e,t){var a=$scope.form.fields[e];for(a.subtitle_values={},k=0;k<t.length;k++)a.subtitle_values[t[k]._id]=SessionService.translate(t[k].name)},updateValuesItems=function(e,t){var a=$scope.form.fields[e],r=a.items+"_values";a[r]=t,$scope.data[a.items]=t},initComponents=function(){for(var formFields=$scope.form.fields,formValues=$scope.form.values,i=0;i<formFields.length;i++)if("address"==formFields[i].display){if(formFields[i].disabled){var field_name=formFields[i].name;MapService.initMap("map"+field_name);var address=$scope.data[field_name];MapService.geocodeAddress("map"+field_name,(address.address_line1?address.address_line1+",":"")+(address.address_line2?address.address_line2+",":"")+(address.address_city?address.address_city+",":"")+(address.address_postal_code?address.address_postal_code+",":"")+(address.address_country?address.address_country+",":""))}}else if("selection"==formFields[i].display||"currency"==formFields[i].display){for(var j=0;j<formValues.length;j++)if(formFields[i].listofvalues==formValues[j]._id){if("list"==formValues[j].type)updateValuesForm(i,formValues[j].values);else{var itemValues=formValues[j].values;itemValues.index=i,Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesForm(e.index,e.values)})}break}}else if("calendar"==formFields[i].display){var field_name=formFields[i].name;$scope.data[field_name]&&($scope.data[field_name]=new Date($scope.data[field_name]))}else if("calculation"==formFields[i].display){var data=$scope.data;formFields[i].calculation_value=eval(formFields[i].calculation)}else if("list"==formFields[i].display){$scope.show_search=!0;for(var j=0;j<formValues.length;j++)if(formFields[i].title_listofvalues==formValues[j]._id)if("list"==formValues[j].type)updateValuesTitle(i,formValues[j].values);else{var itemValues=formValues[j].values;itemValues.index=i,Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesTitle(e.index,e.values)})}else if(formFields[i].subtitle_listofvalues==formValues[j]._id)if("list"==formValues[j].type)updateValuesSubTitle(i,formValues[j].values);else{var itemValues=formValues[j].values;itemValues.index=i,Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesSubTitle(e.index,e.values)})}$scope.form.search_criteria&&($scope.search_criteria=$scope.form.search_criteria),$scope.search_criteria=$scope.search_criteria.replace(/@_user_id/g,$scope.sessionData.userData._id);var keysOfParameters=Object.keys($routeParams);for(k=0,l=keysOfParameters.length;k<l;k++)$scope.search_criteria=$scope.search_criteria.replace("@"+keysOfParameters[k],$routeParams[keysOfParameters[k]]);$scope.formLoaded=!0,$scope.getNextData()}else if("item"==formFields[i].display)for(var j=0;j<formValues.length;j++)if(formFields[i].listofvalues==formValues[j]._id)if("list"==formValues[j].type)updateValuesItems(i,formValues[j].values);else{var itemValues={index:i};itemValues.relation=formValues[j].values.relation,itemValues.id_list=$scope.data[formFields[i].items],Value.update({id:formValues[j]._id,type:formValues[j].type},itemValues).$promise.then(function(e){updateValuesItems(e.index,e.values)})}};Forms.get({id:$routeParams.id},function(e){$scope.form=e;var t=$scope.form.display;if($scope.form.fields=[],t)for(var a=0;a<t.length;a++)for(var r=0;r<t[a].blocks.length;r++)for(var o=0;o<t[a].blocks[r].fields.length;o++)$scope.form.fields.push(t[a].blocks[r].fields[o]);updateAppName(),initText(),$scope.form.datamodel&&("0"==$routeParams.entry_id?($scope.data=new Datas({datamodel_id:$scope.form.datamodel._id,_files:[]}),initComponents()):Datas.get({datamodel_id:$scope.form.datamodel._id,entry_id:$routeParams.entry_id},function(e){$scope.data=e,initComponents()}))});var rand=function(){return Math.random().toString(16).substr(2)},gotoNextForm=function(e,t,a){if("home"==t)SessionService.location("/workflows/"+$scope.sessionData.application_id);else{var r="/form/"+t+"/";if(a&&a._id){if(r=r+a._id+"?application_id="+$routeParams.application_id,e)for(keys=Object.keys(e),i=0;i<keys.length;i++)r=r+"&"+e[keys[i]]+"="+a[e[keys[i]]]}else r=r+"0?application_id="+$routeParams.application_id;r!=$location.path()?SessionService.location(r):$route.reload()}};$scope.uploadFile=function(e,t,a){const r=new XMLHttpRequest;r.open("PUT",t),r.onreadystatechange=function(){4==r.readyState&&(200==r.status?($scope.currentFile++,$scope.currentFile>$scope.filesCount?(document.getElementById("file_upload").textContent=$scope.sessionData.appData.uploading_done,setTimeout(function(){document.getElementById("file_upload").textContent=""},4e3)):document.getElementById("file_upload").textContent=$scope.sessionData.appData.uploading_in_progress+" "+$scope.currentFile+"/"+$scope.filesCount):alert("Could not upload file."))},r.send(e)},$scope.changeFiles=function(e){if(0!=e.length)for($scope.data._files||($scope.data._files=[]),$scope.files||($scope.files=[]),$scope.filesCount=e.length,$scope.currentFile=1,document.getElementById("file_upload").textContent=$scope.sessionData.appData.uploading_in_progress+" "+$scope.currentFile+"/"+$scope.filesCount,i=0;i<$scope.filesCount;i++){$scope.files.push(e[i]);var t=new Files({name:e[i].name,type:e[i].type});t.$save().then(function(t){for(var a=0;a<$scope.files.length;a++)$scope.files[a].name==t.file.name&&($scope.data._files.push({_id:t.file._id,name:t.file.name,type:t.file.type}),$scope.uploadFile(e[a],t.signedRequest,t.url))})}},$scope.removeFile=function(e){for(var t=$scope.data._files,a=0;a<t.length;a++)if(t[a]._id==e){t.splice(a,1),Files.remove({id:e}).$promise.then(function(e){})["catch"](function(e){});break}};var updateComponents=function(e,t,a){for(var r=$scope.form.fields,o=0;o<r.length;o++)if("feed"==r[o].display){var n=r[o].name;e.newvalues[n]&&e.newvalues[n].length>0&&(a[n]||(a[n]=[]),a[n].push({text:e.newvalues[n],from:$scope.sessionData.userData.name,user:$scope.sessionData.userData.user,date:Date.now()}))}t&&(a[t.name]=t.value)},updateErrorAlert=function(){$mdDialog.show($mdDialog.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.new_document_version).textContent($scope.sessionData.appData.already_modified_document).ok($scope.sessionData.appData.ok))},notify=function(e,t,a){if(e&&t&&a){for(var r=SessionService.translate(a),o=r.match(/@\w*@/g),n=0;n<o.length;n++)"@@"!=o[n]&&(r=r.replace(new RegExp(o[n],"g"),$scope.data[o[n].replace(/@/g,"")]));Notify.update({user_id:e},{email_title:SessionService.translate(t),email_html:r})}};$scope.create=function(e,t,a,r,o,n,i,s){updateComponents($scope.form,a,r),$scope.data.$save().then(function(a){n&&("current"==n?notify($scope.sessionData.userData._id,i,s):"owner"==n&&notify(r._user,i,s)),o?gotoNextForm(e,t,a):gotoNextForm(e,t,null)})["catch"](function(e){$scope.data=e.data})},$scope.modify=function(e,t,a,r,o,n,i){updateComponents($scope.form,a,r),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:r._id},r).$promise.then(function(a){o&&("current"==o?notify($scope.sessionData.userData._id,n,i):"owner"==o&&notify(r._user,n,i)),gotoNextForm(e,t,null)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope["delete"]=function(e,t,a,r,o,n){$mdDialog.show($mdDialog.confirm().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.confirmation).textContent($scope.sessionData.appData.removal_confirmation).ok($scope.sessionData.appData.ok).cancel($scope.sessionData.appData.cancel)).then(function(){Datas.remove({datamodel_id:$scope.form.datamodel._id,entry_id:a._id}).$promise.then(function(i){r&&("current"==r?notify($scope.sessionData.userData._id,o,n):"owner"==r&&notify(a._user,o,n)),gotoNextForm(e,t,null)})["catch"](function(e){})})},$scope.link=function(e,t,a,r,o,n){r&&("current"==r?notify($scope.sessionData.userData._id,o,n):"owner"==r&&notify(a._user,o,n)),gotoNextForm(e,t,a)},$scope.linkEmpty=function(e,t,a,r,o,n){r&&("current"==r?notify($scope.sessionData.userData._id,o,n):"owner"==r&&notify(a._user,o,n)),gotoNextForm(e,t,null)},$scope.associate=function(e,t,a,r,o,n,i,s,l,p){updateComponents($scope.form,a,r),"User"==n&&r[o].push($scope.sessionData.userData._id),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:r._id},r).$promise.then(function(a){s&&("current"==s?notify($scope.sessionData.userData._id,l,p):"owner"==s&&notify(r._user,l,p)),gotoNextForm(e,t,r)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.dissociate=function(e,t,a,r,o,n,i,s,l,p){if(updateComponents($scope.form,a,r),"User"==n)for(var c=r[o].length-1;c>=0;c--)(r[o][c]==$scope.sessionData.userData._id||r[o][c]._id==$scope.sessionData.userData._id)&&r[o].splice(c,1);Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:r._id},r).$promise.then(function(a){s&&("current"==s?notify($scope.sessionData.userData._id,l,p):"owner"==s&&notify(r._user,l,p)),gotoNextForm(e,t,r)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.deleteItem=function(e,t,a,r,o,n,i,s,l){$mdDialog.show($mdDialog.confirm().parent(angular.element(document.body)).clickOutsideToClose(!0).title($scope.sessionData.appData.confirmation).textContent($scope.sessionData.appData.removal_confirmation).ok($scope.sessionData.appData.ok).cancel($scope.sessionData.appData.cancel)).then(function(){if(updateComponents($scope.form,a,$scope.data),"User"==n)for(var p=$scope.data[o].length-1;p>=0;p--)($scope.data[o][p]._id==r||$scope.data[o][p]._id==r)&&$scope.data[o].splice(p,1);Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id},$scope.data).$promise.then(function(a){i&&("current"==i?notify($scope.sessionData.userData._id,s,l):"owner"==i?notify($scope.data._user,s,l):"item"==i&&notify(r,s,l)),gotoNextForm(e,t,$scope.data)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})})},$scope.moveItem=function(e,t,a,r,o,n,i,s,l,p){if(updateComponents($scope.form,a,$scope.data),"User"==i){for(var c=$scope.data[o].length-1;c>=0;c--)($scope.data[o][c]==r||$scope.data[o][c]._id==r)&&$scope.data[o].splice(c,1);$scope.data[n].push(r)}Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:$scope.data._id},$scope.data).$promise.then(function(a){s&&("current"==s?notify($scope.sessionData.userData._id,l,p):"owner"==s?notify($scope.data._user,l,p):"item"==s&&notify(r,l,p)),gotoNextForm(e,t,$scope.data)})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.download=function(e,t,a){for(var r="sep=,\n",o=0;o<t.attributes.length;o++)r+='"'+t.attributes[o]+'","'+toString(resolvePath(e,t.attributes[o])).replace(/\"/g,'""')+'"\n';for(var o=0;o<t.items.length;o++)if(r+='"'+t.items[o].name+'","'+e[t.items[o].name].length+'"\n',e[t.items[o].name].length>0){for(var n=0;n<t.items[o].attributes.length;n++)r+='"'+t.items[o].attributes[n]+'",';r+="\n";for(var i=resolvePath(e,t.items[o].name),s=0;s<i.length;s++){for(var n=0;n<t.items[o].attributes.length;n++)r+='"'+toString(resolvePath(i[s],t.items[o].attributes[n])).replace(/\"/g,'""')+'",';r+="\n"}}var l=document.createElement("a");if(l.setAttribute("target","_blank"),void 0!==Blob){var p=new Blob([r],{type:"text/csv"});l.setAttribute("href",URL.createObjectURL(p)),navigator.msSaveBlob?navigator.msSaveBlob(p,e[a]+".csv"):(l.setAttribute("download",e[a]+".csv"),l.click())}else l.setAttribute("href","data:text/csv,"+encodeURIComponent(r)),l.setAttribute("download",e[a]+".csv"),document.body.appendChild(l),l.click(),document.body.removeChild(l)},$scope.share=function(e,t,a,r,o,n,i){updateComponents($scope.form,a,i),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:i._id},i).$promise.then(function(a){Share.update({form_id:n,datamodel_id:$scope.form.datamodel._id,data_id:i._id,email:i[o],key:r.key,value:r.value}).$promise.then(function(a){gotoNextForm(e,t,i)})})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.calendar=function(e,t,a,r,o,n,i){updateComponents($scope.form,a,i),Datas.update({datamodel_id:$scope.form.datamodel._id,entry_id:i._id},i).$promise.then(function(a){Calendar.get({project_name:i[r],start_date:i[o],end_date:i[n],user_id:i._user}).$promise.then(function(a){gotoNextForm(e,t,i)})})["catch"](function(e){$scope.data=e.data,updateErrorAlert()})},$scope.search=function(e){e||(e=""),$scope.search_text=e,$scope.skip=0,$scope.limit=10,$scope.stopScroll=!1,$scope.tempStopScroll=!1,$scope.datas=[],$scope.getNextData()}}]);
