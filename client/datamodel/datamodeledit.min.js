app1.controller("DatamodelEditCtrl",["$scope","SessionService","DesignDataModel","$location","$routeParams","$mdDialog",function(e,a,t,o,s,l){e.sessionData=a.getSessionData(),e.$watch(function(){return a.getSessionData()},function(a,t){a!=t&&(e.sessionData=a)}),e.sessionData.applicationName=e.sessionData.appData.datamodel_designer,a.setSessionData(e.sessionData),e.field_type={text:{en:"Text",fr:"Texte"},number:{en:"Number",fr:"Nombre"},"boolean":{en:"Boolean",fr:"Boolean"},date:{en:"Date",fr:"Date"},period:{en:"Period",fr:"Période"},currency:{en:"Amount",fr:"Montant"},reference:{en:"Detail",fr:"Détail"},item:{en:"Detail List",fr:"Liste de détails"},feed:{en:"Discussion Feed",fr:"Fil de discussion"},file:{en:"File",fr:"Fichier"},address:{en:"Address",fr:"Adresse"},node:{en:"Node",fr:"Noeud"}};var n=Object.keys(e.field_type);for(e.field_types=[],i=0;i<n.length;i++)e.field_type[n[i]].translated_name=a.translate(e.field_type[n[i]]),e.field_types.push({translated_name:e.field_type[n[i]].translated_name,type:n[i]});e.datamodel_keys=[],t.get({id:s.id},function(a,t){if(a)if(e.datamodel=a,e.datamodel.projection)for(var o=Object.keys(e.datamodel.projection),s=0;s<o.length;s++){var i=e.datamodel.projection[o[s]];i.full_path=""==i.path?i.technical_name:i.path+"."+i.technical_name,e.datamodel_keys.push(i)}else e.datamodel.projection={};else e.datamodel={projection:{}};e.datamodel_keys.sort(function(e,a){return e.full_path.trim().localeCompare(a.full_path.trim())})}),t.query({skip:0,limit:500},function(t){for(var o=0;o<t.length;o++)t[o].properties?"userdata"==t[o].properties.reference?t[o].corrected_ref="User":"filedata"==t[o].properties.reference?t[o].corrected_ref="File":t[o].corrected_ref="datas"+t[o]._id:t[o].corrected_ref="datas"+t[o]._id,t[o].translated_name=a.translate(t[o].name);e.datamodels=t}),e.editText=function(e,a,t,o){e[a]||(e[a]={}),l.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[a],multipleLines:t},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(t){e[a]=t})},e.editTextCopy=function(e,a,t,o){e[a]||(e[a]={}),l.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[a],multipleLines:t},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(t){e[a]=t})};var r=function(){var a=Object.keys(e.datamodel.projection).length;do a+=1;while(e.datamodel.projection[a]);return a};e.changeFieldRef=function(a){for(var t=0;t<e.datamodels.length;t++)if(e.datamodels[t]._id==a.ref_id){a.ref=e.datamodels[t].corrected_ref;break}},e.newField=function(a,t){l.show({templateUrl:"datamodel/new.html",controller:"NewFieldCtrl",parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(o){var s=r();if(o.path=""==a?t:a+"."+t,o.full_path=""==o.path?o.technical_name:o.path+"."+o.technical_name,e.datamodel.projection[s]=o,e.datamodel_keys.push(e.datamodel.projection[s]),"currency"==o.type){var i=r();e.datamodel.projection[i]={path:o.full_path,type:"number",technical_name:"value",full_path:o.full_path+".value",name:{en:"Value",fr:"Montant"}},e.datamodel_keys.push(e.datamodel.projection[i]);var l=r();e.datamodel.projection[l]={path:o.full_path,type:"text",technical_name:"currency",full_path:o.full_path+".currency",name:{en:"Currency",fr:"Monnaie"}},e.datamodel_keys.push(e.datamodel.projection[l])}else if("period"==o.type){var n=r();e.datamodel.projection[n]={path:o.full_path,type:"date",technical_name:"start_time",full_path:o.full_path+".start_time",name:{en:"Start Time",fr:"Heure de debut"}},e.datamodel_keys.push(e.datamodel.projection[n]);var d=r();e.datamodel.projection[d]={path:o.full_path,type:"date",technical_name:"end_time",full_path:o.full_path+".end_time",name:{en:"End Time",fr:"Heure de fin"}},e.datamodel_keys.push(e.datamodel.projection[d])}else if("address"==o.type){var p=r();e.datamodel.projection[p]={path:o.full_path,type:"text",technical_name:"address_line1",full_path:o.full_path+".address_line1",name:{en:"Address Line 1",fr:"Adresse ligne 1"}},e.datamodel_keys.push(e.datamodel.projection[p]);var c=r();e.datamodel.projection[c]={path:o.full_path,type:"text",technical_name:"address_line2",full_path:o.full_path+".address_line2",name:{en:"Address Line 2",fr:"Adresse ligne 2"}},e.datamodel_keys.push(e.datamodel.projection[c]);var f=r();e.datamodel.projection[f]={path:o.full_path,type:"text",technical_name:"address_city",full_path:o.full_path+".address_city",name:{en:"City",fr:"Ville"}},e.datamodel_keys.push(e.datamodel.projection[f]);var u=r();e.datamodel.projection[u]={path:o.full_path,type:"text",technical_name:"address_state",full_path:o.full_path+".address_state",name:{en:"State",fr:"Region"}},e.datamodel_keys.push(e.datamodel.projection[u]);var m=r();e.datamodel.projection[m]={path:o.full_path,type:"text",technical_name:"address_postal_code",full_path:o.full_path+".address_postal_code",name:{en:"Postal Code",fr:"Code Postal"}},e.datamodel_keys.push(e.datamodel.projection[m]);var _=r();e.datamodel.projection[_]={path:o.full_path,type:"text",technical_name:"address_country",full_path:o.full_path+".address_country",name:{en:"Country",fr:"Pays"}},e.datamodel_keys.push(e.datamodel.projection[_])}e.datamodel_keys.sort(function(e,a){return e.full_path.trim().localeCompare(a.full_path.trim())})})},e.deleteField=function(a){for(var t=e.datamodel_keys.length-1;t>=0;t--)e.datamodel_keys[t].full_path.startsWith(a)&&e.datamodel_keys.splice(t,1);for(var o=Object.keys(e.datamodel.projection),t=0;t<o.length;t++)e.datamodel.projection[o[t]].full_path.startsWith(a)&&delete e.datamodel.projection[o[t]]},e.save=function(){t.update({id:e.datamodel._id},e.datamodel,function(e){a.location("/datamodel/")},function(a){e.datamodel=a.datamodel,updateErrorAlert()})}}]);
