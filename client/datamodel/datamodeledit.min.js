app1.controller("DatamodelEditCtrl",["$scope","SessionService","DesignDataModel","$location","$routeParams","$mdDialog",function(e,t,a,o,l,n){e.sessionData=t.getSessionData(),e.$watch(function(){return t.getSessionData()},function(t,a){t!=a&&(e.sessionData=t)}),e.sessionData.applicationName=e.sessionData.appData.datamodel_designer,t.setSessionData(e.sessionData),e.field_type={text:{en:"Text",fr:"Texte"},number:{en:"Number",fr:"Nombre"},"boolean":{en:"Boolean",fr:"Boolean"},date:{en:"Date",fr:"Date"},currency:{en:"Amount",fr:"Montant"},reference:{en:"Detail",fr:"Détail"},item:{en:"Detail List",fr:"Liste de détails"},feed:{en:"Discussion Feed",fr:"Fil de discussion"},file:{en:"File",fr:"Fichier"},address:{en:"Address",fr:"Adresse"},node:{en:"Node",fr:"Noeud"}};var d=Object.keys(e.field_type);for(e.field_types=[],i=0;i<d.length;i++)e.field_type[d[i]].translated_name=t.translate(e.field_type[d[i]]),e.field_types.push({translated_name:e.field_type[d[i]].translated_name,type:d[i]});e.datamodel_keys=[],a.get({id:l.id},function(t,a){if(t)if(e.datamodel=t,e.datamodel.projection)for(var o=Object.keys(e.datamodel.projection),l=0;l<o.length;l++){var n=e.datamodel.projection[o[l]];n.full_path=""==n.path?n.technical_name:n.path+"."+n.technical_name,e.datamodel_keys.push(n)}else e.datamodel.projection={};else e.datamodel={projection:{}};e.datamodel_keys.sort(function(e,t){return e.full_path.trim().localeCompare(t.full_path.trim())})}),a.query({skip:0,limit:500},function(a){for(var o=0;o<a.length;o++)a[o].properties&&a[o].properties.reference&&"userdata"==a[o].properties.reference?a[o].corrected_ref="User":a[o].corrected_ref="datas"+a[o]._id,a[o].translated_name=t.translate(a[o].name);e.datamodels=a}),e.editText=function(e,t,a,o){e[t]||(e[t]={}),n.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[t],multipleLines:a},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(a){e[t]=a})},e.editTextCopy=function(e,t,a,o){e[t]||(e[t]={}),n.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[t],multipleLines:a},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(a){e[t]=a})},e.editForm=function(a){DesignWorkflow.update({id:e.workflow._id},e.workflow).$promise.then(function(o){t.init(),t.location("/form_edit/"+a+"?application_id="+l.application_id+"&workflow_id="+e.workflow._id)})["catch"](function(t){e.application=t.application,updateErrorAlert()})};var r=function(){var t=Object.keys(e.datamodel.projection).length;do t+=1;while(e.datamodel.projection[t]);return t};e.newField=function(t,a){n.show({templateUrl:"datamodel/new.html",controller:"NewFieldCtrl",locals:{field_types:e.field_types},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(o){var l=r();if(o.path=""==t?a:t+"."+a,o.full_path=""==o.path?o.technical_name:o.path+"."+o.technical_name,e.datamodel.projection[l]=o,e.datamodel_keys.push(e.datamodel.projection[l]),"address"==o.type){var n=r();e.datamodel.projection[n]={path:o.full_path,type:"text",technical_name:"address_line1",full_path:o.full_path+".address_line1",name:{en:"Address Line 1",fr:"Adresse ligne 1"}},e.datamodel_keys.push(e.datamodel.projection[n]);var d=r();e.datamodel.projection[d]={path:o.full_path,type:"text",technical_name:"address_line2",full_path:o.full_path+".address_line2",name:{en:"Address Line 2",fr:"Adresse ligne 2"}},e.datamodel_keys.push(e.datamodel.projection[d]);var i=r();e.datamodel.projection[i]={path:o.full_path,type:"text",technical_name:"address_city",full_path:o.full_path+".address_city",name:{en:"City",fr:"Ville"}},e.datamodel_keys.push(e.datamodel.projection[i]);var s=r();e.datamodel.projection[s]={path:o.full_path,type:"text",technical_name:"address_state",full_path:o.full_path+".address_state",name:{en:"State",fr:"Region"}},e.datamodel_keys.push(e.datamodel.projection[s]);var p=r();e.datamodel.projection[p]={path:o.full_path,type:"text",technical_name:"address_postal_code",full_path:o.full_path+".address_postal_code",name:{en:"Postal Code",fr:"Code Postal"}},e.datamodel_keys.push(e.datamodel.projection[p]);var c=r();e.datamodel.projection[c]={path:o.full_path,type:"text",technical_name:"address_country",full_path:o.full_path+".address_country",name:{en:"Country",fr:"Pays"}},e.datamodel_keys.push(e.datamodel.projection[c])}e.datamodel_keys.sort(function(e,t){return e.full_path.trim().localeCompare(t.full_path.trim())})})},e.deleteField=function(t){for(var a=e.datamodel_keys.length-1;a>=0;a--)e.datamodel_keys[a].full_path.startsWith(t)&&e.datamodel_keys.splice(a,1);for(var o=Object.keys(e.datamodel.projection),a=0;a<o.length;a++)e.datamodel.projection[o[a]].full_path.startsWith(t)&&delete e.datamodel.projection[o[a]]},e.save=function(){a.update({id:e.datamodel._id},e.datamodel).$promise.then(function(e){t.location("/datamodel/")})["catch"](function(t){e.datamodel=t.datamodel,updateErrorAlert()})}}]);
