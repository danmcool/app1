app1.controller("DatamodelEditCtrl",["$scope","SessionService","DesignDataModel","$location","$routeParams","$mdDialog",function(e,o,s,t,n,a){e.sessionData=o.getSessionData(),e.$watch(function(){return o.getSessionData()},function(o,s){o!=s&&(e.sessionData=o)}),e.sessionData.applicationName=e.sessionData.appData.datamodel_designer,o.setSessionData(e.sessionData),e.field_type={text:{en:"Text",fr:"Texte"},number:{en:"Number",fr:"Nombre"},"boolean":{en:"Boolean",fr:"Boolean"},date:{en:"Date",fr:"Date"},currency:{en:"Amount",fr:"Montant"},reference:{en:"Detail",fr:"Détail"},item:{en:"Detail List",fr:"Liste de détails"},feed:{en:"Discussion Feed",fr:"Fil de discussion"},file:{en:"File",fr:"Fichier"},address:{en:"Address",fr:"Adresse"},node:{en:"Node",fr:"Noeud"}};var r=Object.keys(e.field_type);for(e.field_types=[],i=0;i<r.length;i++)e.field_type[r[i]].translated_name=o.translate(e.field_type[r[i]]),e.field_types.push({translated_name:e.field_type[r[i]].translated_name,type:r[i]});e.datamodel_keys=[],s.get({id:n.id},function(o,s){if(o)if(e.datamodel=o,e.datamodel.projection)for(var t=Object.keys(e.datamodel.projection),n=0;n<t.length;n++){var a=e.datamodel.projection[t[n]];a.full_path=""==a.path?a.technical_name:a.path+"."+a.technical_name,e.datamodel_keys.push(a)}else e.datamodel.projection={};else e.datamodel={projection:{}};e.datamodel_keys.sort(function(e,o){return e.full_path.trim().localeCompare(o.full_path.trim())})}),s.query({skip:0,limit:500},function(s){for(var t=0;t<s.length;t++)s[t].properties?"userdata"==s[t].properties.reference?s[t].corrected_ref="User":"filedata"==s[t].properties.reference?s[t].corrected_ref="File":s[t].corrected_ref="datas"+s[t]._id:s[t].corrected_ref="datas"+s[t]._id,s[t].translated_name=o.translate(s[t].name);e.datamodels=s}),e.editText=function(e,o,s,t){e[o]||(e[o]={}),a.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[o],multipleLines:s},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(s){e[o]=s})},e.editTextCopy=function(e,o,s,t){e[o]||(e[o]={}),a.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[o],multipleLines:s},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(s){e[o]=s})},e.editForm=function(s){DesignWorkflow.update({id:e.workflow._id},e.workflow).$promise.then(function(t){o.init(),o.location("/form_edit/"+s+"?application_id="+n.application_id+"&workflow_id="+e.workflow._id)})["catch"](function(o){e.application=o.application,updateErrorAlert()})};var d=function(){var o=Object.keys(e.datamodel.projection).length;do o+=1;while(e.datamodel.projection[o]);return o};e.newField=function(o,s){a.show({templateUrl:"datamodel/new.html",controller:"NewFieldCtrl",parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(t){var n=d();if(t.path=""==o?s:o+"."+s,t.full_path=""==t.path?t.technical_name:t.path+"."+t.technical_name,e.datamodel.projection[n]=t,e.datamodel_keys.push(e.datamodel.projection[n]),"address"==t.type){var a=d();e.datamodel.projection[a]={path:t.full_path,type:"text",technical_name:"address_line1",full_path:t.full_path+".address_line1",name:{en:"Address Line 1",fr:"Adresse ligne 1"}},e.datamodel_keys.push(e.datamodel.projection[a]);var i=d();e.datamodel.projection[i]={path:t.full_path,type:"text",technical_name:"address_line2",full_path:t.full_path+".address_line2",name:{en:"Address Line 2",fr:"Adresse ligne 2"}},e.datamodel_keys.push(e.datamodel.projection[i]);var r=d();e.datamodel.projection[r]={path:t.full_path,type:"text",technical_name:"address_city",full_path:t.full_path+".address_city",name:{en:"City",fr:"Ville"}},e.datamodel_keys.push(e.datamodel.projection[r]);var u=d();e.datamodel.projection[u]={path:t.full_path,type:"text",technical_name:"address_state",full_path:t.full_path+".address_state",name:{en:"State",fr:"Region"}},e.datamodel_keys.push(e.datamodel.projection[u]);var c=d();e.datamodel.projection[c]={path:t.full_path,type:"text",technical_name:"address_postal_code",full_path:t.full_path+".address_postal_code",name:{en:"Postal Code",fr:"Code Postal"}},e.datamodel_keys.push(e.datamodel.projection[c]);var f=d();e.datamodel.projection[f]={path:t.full_path,type:"text",technical_name:"address_country",full_path:t.full_path+".address_country",name:{en:"Country",fr:"Pays"}},e.datamodel_keys.push(e.datamodel.projection[f])}e.datamodel_keys.sort(function(e,o){return e.full_path.trim().localeCompare(o.full_path.trim())})})},e.deleteField=function(o){for(var s=e.datamodel_keys.length-1;s>=0;s--)e.datamodel_keys[s].full_path.startsWith(o)&&e.datamodel_keys.splice(s,1);for(var t=Object.keys(e.datamodel.projection),s=0;s<t.length;s++)e.datamodel.projection[t[s]].full_path.startsWith(o)&&delete e.datamodel.projection[t[s]]},e.save=function(){s.update({id:e.datamodel._id},e.datamodel).$promise.then(function(e){o.location("/datamodel/")})["catch"](function(o){e.datamodel=o.datamodel,updateErrorAlert()})}}]);
