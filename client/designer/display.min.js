app1.controller("FormDisplayEditCtrl",["$scope","$routeParams","$mdDialog","SessionService","DesignForm","DesignDataModel","DesignWorkflow",function(e,a,t,o,s,i,l){e.sessionData=o.getSessionData(),e.$watch(function(){return o.getSessionData()},function(a,t){a!=t&&(e.sessionData=a)}),e.section_index=a.section,e.block_index=a.block,e.field_index=a.field,e.title_ref={show:!1},e.subtitle_ref={show:!1},e.selection_ref={show:!1},e.datamodels=[],e.display_type={list:{en:"List",fr:"Liste"},item:{en:"Detail List",fr:"Liste de détails"},shorttext:{en:"Text",fr:"Texte"},number:{en:"Number",fr:"Nombre"},currency:{en:"Amount",fr:"Montant"},editor:{en:"Text Editor",fr:"Editeur texte"},feed:{en:"Discussion Feed",fr:"Fil de discussion"},file:{en:"File",fr:"Fichier"},image:{en:"Image",fr:"Image"},selection:{en:"Selection",fr:"Selection"},check:{en:"Check",fr:"Contrôle"},calendar:{en:"Calendar",fr:"Calendrier"},appointment:{en:"Appointment",fr:"Rendez-vous"},appointment_properties:{en:"Appointment Configuration",fr:"Configuration rendez-vous"},calculation:{en:"Formula",fr:"Formule"},email:{en:"Email",fr:"Courriel"},address:{en:"Address",fr:"Adresse"}},e.title_display_type={text:{en:"Text",fr:"Texte"},value:{en:"Value",fr:"Valeur"},currency:{en:"Amount",fr:"Montant"}},e.selection_display_type={property:{en:"Property",fr:"Proprieté"},calculation:{en:"Formula",fr:"Formule"}};var r=Object.keys(e.display_type);e.display_types=[];for(var n=0;n<r.length;n++)e.display_types.push({translated_name:o.translate(e.display_type[r[n]]),type:r[n]});var d=Object.keys(e.title_display_type);e.title_display_types=[];for(var c=0;c<d.length;c++)e.title_display_types.push({translated_name:o.translate(e.title_display_type[d[c]]),type:d[c]});var p=Object.keys(e.selection_display_type);e.selection_display_types=[];for(var f=0;f<p.length;f++)e.selection_display_types.push({translated_name:o.translate(e.selection_display_type[p[f]]),type:p[f]});e.list_action_type={modify_list:{en:"Modify",fr:"Modifier"},delete_list:{en:"Delete",fr:"Supprimer"},link_list:{en:"Link",fr:"Lien"}},e.item_action_type={modify_item:{en:"Modify",fr:"Modifier"},delete_item:{en:"Delete",fr:"Supprimer"},link_item:{en:"Link",fr:"Lien"},move_item:{en:"Move Item",fr:"Deplacer element"}};var u=Object.keys(e.list_action_type);for(e.list_action_types=[],n=0;n<u.length;n++)e.list_action_types.push({translated_name:o.translate(e.list_action_type[u[n]]),type:u[n]});var m=Object.keys(e.item_action_type);for(e.item_action_types=[],n=0;n<m.length;n++)e.item_action_types.push({translated_name:o.translate(e.item_action_type[m[n]]),type:m[n]});var _=function(a,t,s){for(var i=0;i<e.datamodels.length;i++)if(e.datamodels[i]._id==a){t=e.datamodels[i];for(var l=Object.keys(e.datamodels[i].projection),r=0;r<l.length;r++)s.push({translated_name:o.translate(e.datamodels[i].projection[l[r]].name),full_path:e.datamodels[i].projection[l[r]].full_path,id:l[r]});break}},$=function(){if(e.ref_datamodel_selection_keys=[],e.ref_datamodel_selection={},e.ref_datamodel_title_keys=[],e.ref_datamodel_title={},e.ref_datamodel_subtitle_keys=[],e.ref_datamodel_subtitle={},"item"==e.field.display||"reference"==e.field.display||"selection"==e.field.display){if(e.field&&e.field.projectionid){var a=e.form.datamodel.projection[e.field.projectionid].ref_id;a&&(e.selection_ref.show=!0),_(a,e.ref_datamodel_selection,e.ref_datamodel_selection_keys)}}else if("list"==e.field.display&&e.field){if(e.field.title){var a=e.form.datamodel.projection[e.field.title].ref_id;a&&(e.title_ref.show=!0),_(a,e.ref_datamodel_title,e.ref_datamodel_title_keys)}if(e.field.subtitle){var a=e.form.datamodel.projection[e.field.subtitle].ref_id;a&&(e.subtitle_ref.show=!0),_(a,e.ref_datamodel_subtitle,e.ref_datamodel_subtitle_keys)}}};s.get({id:a.id},function(a,t){if(e.form=a,e.form.translated_name=o.translate(e.form.name),e.field=e.form.display[e.section_index].blocks[e.block_index].fields[e.field_index],i.query({skip:0,limit:500},function(a){e.datamodels=a,$()}),e.changeValues(e.field.listofvalues,e.selection_ref),e.changeValues(e.field.title_listofvalues,e.title_ref),e.changeValues(e.field.subtitle_listofvalues,e.subtitle_ref),e.datamodel_keys=[],e.form.datamodel)for(var s=Object.keys(e.form.datamodel.projection),l=0;l<s.length;l++)e.datamodel_keys.push({translated_name:o.translate(e.form.datamodel.projection[s[l]].name),full_path:e.form.datamodel.projection[s[l]].full_path,id:s[l]});if(e.form.actions)for(var r=0;r<e.form.actions.length;r++)e.form.actions[r].translated_name=o.translate(e.form.actions[r].name);if(e.form.values)for(var n=0;n<e.form.values.length;n++)e.form.values[n].translated_name=o.translate(e.form.values[n].name);e.sessionData.applicationName=e.sessionData.appData.app_designer,o.setSessionData(e.sessionData)}),l.get({id:a.workflow_id},function(a,t){for(var s=0;s<a.forms.length;s++)a.forms[s].translated_name=o.translate(a.forms[s].name),a.forms[s].translated_description=o.translate(a.forms[s].description);e.forms=a.forms;var i={_id:"home",name:{en:"Application Home",fr:"Accueil de l`application"}};i.translated_name=o.translate(i.name),e.forms.push(i)}),e.changeFieldDisplay=function(e){$()},e.changeValues=function(a,t){if(t.show=!1,e.form.values)for(var o=0;o<e.form.values.length;o++)if(e.form.values[o]._id==a&&"list"!=e.form.values[o].type){t.show=!0;break}},e.changeSelectionRefDataModel=function(a){for(var t=0;t<e.ref_datamodel_selection_keys.length;t++)if(e.ref_datamodel_selection_keys[t].id==a.selection_id){a.selection_full_path=e.ref_datamodel_selection_keys[t].full_path;break}},e.changeTitleRefDataModel=function(a){for(var t=0;t<e.ref_datamodel_title_keys.length;t++)if(e.ref_datamodel_title_keys[t].id==a.title){a.title_full_path=e.ref_datamodel_title_keys[t].full_path;break}},e.changeSubtitleRefDataModel=function(a){for(var t=0;t<e.ref_datamodel_subtitle_keys.length;t++)if(e.ref_datamodel_subtitle_keys[t].id==a.subtitle){a.subtitle_full_path=e.ref_datamodel_subtitle_keys[t].full_path;break}},e.editText=function(e,a,o){e[a]||(e[a]={}),t.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[a],multipleLines:o},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(t){e[a]=t})},e.addActionList=function(a){t.show(t.prompt().parent(angular.element(document.body)).clickOutsideToClose(!0).title(e.sessionData.appData.new_action).initialValue("My Action").ok(e.sessionData.appData.ok).cancel(e.sessionData.appData.cancel)).then(function(t){a.item_actions||(a.item_actions=[]);var o={};o[e.sessionData.userData.properties.language]=t,a.item_actions.push({name:o,translated_name:t})})},e.save=function(){e.field.projectionid&&(e.field.full_path=""==e.form.datamodel.projection[e.field.projectionid].path?e.form.datamodel.projection[e.field.projectionid].technical_name:e.form.datamodel.projection[e.field.projectionid].path+"."+e.form.datamodel.projection[e.field.projectionid].technical_name),e.field.title&&("item"==e.field.display?e.ref_datamodel_selection.projection[e.field.title]&&(e.field.title_full_path=""==e.ref_datamodel_selection.projection[e.field.title].path?e.ref_datamodel_selection.projection[e.field.title].technical_name:e.ref_datamodel_selection.projection[e.field.title].path+"."+e.ref_datamodel_selection.projection[e.field.title].technical_name):"list"==e.field.display&&"value"==e.field.title_display&&"property"==e.field.title_display_text?e.ref_datamodel_title.projection[e.field.title]&&(e.field.title_full_path=""==e.ref_datamodel_title.projection[e.field.title].path?e.ref_datamodel_title.projection[e.field.title].technical_name:e.ref_datamodel_title.projection[e.field.title].path+"."+e.ref_datamodel_title.projection[e.field.title].technical_name):e.form.datamodel.projection[e.field.title]&&(e.field.title_full_path=""==e.form.datamodel.projection[e.field.title].path?e.form.datamodel.projection[e.field.title].technical_name:e.form.datamodel.projection[e.field.title].path+"."+e.form.datamodel.projection[e.field.title].technical_name)),e.field.subtitle&&("item"==e.field.display?e.ref_datamodel_selection.projection[e.field.subtitle]&&(e.field.subtitle_full_path=""==e.ref_datamodel_selection.projection[e.field.subtitle].path?e.ref_datamodel_selection.projection[e.field.subtitle].technical_name:e.ref_datamodel_selection.projection[e.field.subtitle].path+"."+e.ref_datamodel_selection.projection[e.field.subtitle].technical_name):"list"==e.field.display&&"value"==e.field.subtitle_display&&"property"==e.field.subtitle_display_text?e.ref_datamodel_subtitle.projection[e.field.subtitle]&&(e.field.subtitle_full_path=""==e.ref_datamodel_subtitle.projection[e.field.subtitle].path?e.ref_datamodel_subtitle.projection[e.field.subtitle].technical_name:e.ref_datamodel_subtitle.projection[e.field.subtitle].path+"."+e.ref_datamodel_subtitle.projection[e.field.subtitle].technical_name):e.form.datamodel.projection[e.field.subtitle]&&(e.field.subtitle_full_path=""==e.form.datamodel.projection[e.field.subtitle].path?e.form.datamodel.projection[e.field.subtitle].technical_name:e.form.datamodel.projection[e.field.subtitle].path+"."+e.form.datamodel.projection[e.field.subtitle].technical_name)),e.field.date&&("item"==e.field.display?e.ref_datamodel_selection.projection[e.field.date]&&(e.field.date_full_path=""==e.ref_datamodel_selection.projection[e.field.date].path?e.ref_datamodel_selection.projection[e.field.date].technical_name:e.ref_datamodel_selection.projection[e.field.date].path+"."+e.ref_datamodel_selection.projection[e.field.date].technical_name):e.form.datamodel.projection[e.field.date]&&(e.field.date_full_path=""==e.form.datamodel.projection[e.field.date].path?e.form.datamodel.projection[e.field.date].technical_name:e.form.datamodel.projection[e.field.date].path+"."+e.form.datamodel.projection[e.field.date].technical_name)),s.update({id:e.form._id},e.form,function(t){o.init(),o.location("/form_edit/"+e.form._id+"?application_id="+a.application_id+"&workflow_id="+a.workflow_id)},function(e){v()})};var v=function(){t.show(t.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title(e.sessionData.appData.new_document_version).textContent(e.sessionData.appData.already_modified_document).ok(e.sessionData.appData.ok))}}]);
