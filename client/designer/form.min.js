app1.controller("FormEditCtrl",["$scope","$resource","$location","$routeParams","$mdDialog","SessionService","DesignForm","DesignDataModel","DesignValue",function(e,o,s,t,n,r,i,a,d){e.sessionData=r.getSessionData(),e.$watch(function(){return r.getSessionData()},function(o,s){o!=s&&(e.sessionData=o)}),e.field_id_list={};var c=function(){var o=Object.keys(e.field_id_list),s=o.length;do s+=1;while(e.field_id_list[s]);return e.field_id_list[s]=!0,s};i.get({id:t.id},function(o,s){if(e.form=o,e.form.actions)for(var t=0;t<e.form.actions.length;t++)e.form.actions[t].translated_name=r.translate(e.form.actions[t].name);else e.form.actions=[];if(e.form.values)for(var t=0;t<e.form.values.length;t++)e.form.values[t].translated_name=r.translate(e.form.values[t].name);else e.form.values=[];if(e.form.display)for(var t=0;t<e.form.display.length;t++)for(var n=0;n<e.form.display[t].blocks.length;n++)for(var i=0;i<e.form.display[t].blocks[n].fields.length;i++)e.form.display[t].blocks[n].fields[i].id||(e.form.display[t].blocks[n].fields[i].id=c()),e.field_id_list[e.form.display[t].blocks[n].fields[i].id]=!0,e.form.display[t].blocks[n].fields[i].text?e.form.display[t].blocks[n].fields[i].translated_name=r.translate(e.form.display[t].blocks[n].fields[i].text):e.form.display[t].blocks[n].fields[i].translated_name=r.translate(e.form.datamodel.projection[e.form.display[t].blocks[n].fields[i].name]);else e.form.display=[];e.sessionData.applicationName=e.sessionData.appData.app_designer,r.setSessionData(e.sessionData)}),a.query({skip:0,limit:500},function(o){for(var s=0;s<o.length;s++)o[s].translated_name=r.translate(o[s].name);e.datamodels=o}),e.editText=function(e,o,s){e[o]||(e[o]={}),n.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:e[o],multipleLines:s},parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(s){e[o]=s})};var f=function(o){i.update({id:e.form._id},e.form).$promise.then(function(e){r.location(o)})["catch"](function(e){p()})};e.editField=function(o,s,n){f("/form_display_edit/"+e.form._id+"?section="+o+"&block="+s+"&field="+n+"&application_id="+t.application_id+"&workflow_id="+t.workflow_id)},e.deleteField=function(o,s,t){e.form.display[o].blocks[s].fields.length>0&&e.form.display[o].blocks[s].fields.splice(t,1),0==e.form.display[o].blocks[s].fields.length&&e.form.display[o].blocks.splice(s,1),0==e.form.display[o].blocks.length&&e.form.display.splice(o,1)},e.editAction=function(o){f("/form_action_edit/"+e.form._id+"?action="+o+"&application_id="+t.application_id+"&workflow_id="+t.workflow_id)},e.deleteAction=function(o){e.form.actions.splice(o,1)},e.editValue=function(o){f("/form_value_edit/"+o._id+"?datamodel_id="+e.form.datamodel._id+"&application_id="+t.application_id+"&workflow_id="+t.workflow_id+"&form_id="+e.form._id)},e.deleteValue=function(o){e.form.values.splice(o,1)},e.newAction=function(){var o={};o[e.sessionData.userData.properties.language]="",e.form.actions.push({name:o,translated_name:""}),f("/form_action_edit/"+e.form._id+"?action="+(e.form.actions.length-1)+"&application_id="+t.application_id+"&workflow_id="+t.workflow_id)},e.newValue=function(){var o={};o[e.sessionData.userData.properties.language]="";var s=new d({name:o});s.$save(function(){e.form.values||(e.form.values=[]),e.form.values.push({name:o,_id:s._id}),f("/form_value_edit/"+s._id+"?datamodel_id="+e.form.datamodel._id+"&application_id="+t.application_id+"&workflow_id="+t.workflow_id+"&form_id="+e.form._id)})},e.newSection=function(){e.form.display||(e.form.display=[]);var o={};o[e.sessionData.userData.properties.language]="",e.form.display.push({blocks:[{fields:[{text:o,translated_name:"",disabled:!1,mandatory:!1,id:c()}]}]})},e.newBlock=function(o){e.form.display||(e.form.display=[]);var s={};s[e.sessionData.userData.properties.language]="",o.push({fields:[{text:s,translated_name:"",disabled:!1,mandatory:!1,id:c()}]})},e.newField=function(o){var s={};s[e.sessionData.userData.properties.language]="",o.push({text:s,translated_name:"",disabled:!1,mandatory:!1,id:c()})},e.save=function(){f("/workflow_edit/"+t.workflow_id+"?application_id="+t.application_id)},e.onDragEnter=function(e){element.classList.add("dash_line")};var p=function(){n.show(n.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title(e.sessionData.appData.new_document_version).textContent(e.sessionData.appData.already_modified_document).ok(e.sessionData.appData.ok))}}]);
