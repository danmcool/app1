app1.controller("FormEditCtrl",["$scope","$resource","$location","$routeParams","$mdDialog","SessionService","DesignForm","DesignDataModel","DesignValue",function(e,r,n,i,t,a,o,s,l){e.sessionData=a.getSessionData(),e.$watch(function(){return a.getSessionData()},function(r,n){r!=n&&(e.sessionData=r)}),e.field_id_list={};var f=function(){var r=Object.keys(e.field_id_list),n=r.length;do n+=1;while(e.field_id_list[n]);return e.field_id_list[n]=!0,n};o.get({id:i.id},function(r,n){if(e.form=r,e.form.actions)for(var i=0;i<e.form.actions.length;i++)e.form.actions[i].translated_name=a.translate(e.form.actions[i].name);else e.form.actions=[];if(e.form.values)for(var i=0;i<e.form.values.length;i++)e.form.values[i].translated_name=a.translate(e.form.values[i].name);else e.form.values=[];if(e.form.display)for(var i=0;i<e.form.display.length;i++)for(var t=0;t<e.form.display[i].blocks.length;t++)for(var o=0;o<e.form.display[i].blocks[t].fields.length;o++)e.form.display[i].blocks[t].fields[o].id||(e.form.display[i].blocks[t].fields[o].id=f()),e.field_id_list[e.form.display[i].blocks[t].fields[o].id]=!0,e.form.display[i].blocks[t].fields[o].text?e.form.display[i].blocks[t].fields[o].translated_name=a.translate(e.form.display[i].blocks[t].fields[o].text):e.form.display[i].blocks[t].fields[o].translated_name=a.translate(e.form.datamodel.projection[e.form.display[i].blocks[t].fields[o].name]);else e.form.display=[];e.sessionData.applicationName=e.sessionData.appData.app_designer,a.setSessionData(e.sessionData)}),s.query({skip:0,limit:500},function(r){for(var n=0;n<r.length;n++)r[n].translated_name=a.translate(r[n].name);e.datamodels=r}),e.editText=function(r,n,i){r[n]||(r[n]={}),t.show({templateUrl:"designer/text.html",controller:"TextCtrl",locals:{text:r[n],multipleLines:i},theme:e.sessionData.userData.properties.theme,parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(e){r[n]=e})};var p=function(r){if(e.form.actions)for(var n=0;n<e.form.actions.length;n++)delete e.form.actions[n].translated_name;if(e.form.values)for(var i=0;i<e.form.values.length;i++)delete e.form.values[i].translated_name;if(e.form.display)for(var t=0;t<e.form.display.length;t++)for(var s=0;s<e.form.display[t].blocks.length;s++)for(var l=0;l<e.form.display[t].blocks[s].fields.length;l++)delete e.form.display[t].blocks[s].fields[l].translated_name;o.update({id:e.form._id},e.form,function(e){a.location(r)},function(e){c()})};e.editField=function(r,n,t){p("/form_display_edit/"+e.form._id+"?section="+r+"&block="+n+"&field="+t+"&application_id="+i.application_id+"&workflow_id="+i.workflow_id)},e.deleteField=function(r,n,i){e.form.display[r].blocks[n].fields.length>0&&e.form.display[r].blocks[n].fields.splice(i,1),0==e.form.display[r].blocks[n].fields.length&&e.form.display[r].blocks.splice(n,1),0==e.form.display[r].blocks.length&&e.form.display.splice(r,1);for(var t=0;t<e.form.display[r].blocks.length;t++)e.form.display[r].blocks[t].flex=100/e.form.display[r].blocks.length},e.editAction=function(r){p("/form_action_edit/"+e.form._id+"?action="+r+"&application_id="+i.application_id+"&workflow_id="+i.workflow_id)},e.deleteAction=function(r){e.form.actions.splice(r,1)},e.editValue=function(r){p("/form_value_edit/"+r._id+"?datamodel_id="+e.form.datamodel._id+"&application_id="+i.application_id+"&workflow_id="+i.workflow_id+"&form_id="+e.form._id)},e.deleteValue=function(r){e.form.values.splice(r,1)},e.newAction=function(){var r={};r[e.sessionData.userData.properties.correctedLanguage]="",e.form.actions.push({name:r,translated_name:""}),p("/form_action_edit/"+e.form._id+"?action="+(e.form.actions.length-1)+"&application_id="+i.application_id+"&workflow_id="+i.workflow_id)},e.newValue=function(){t.show({templateUrl:"designer/newvalue.html",controller:"NewValueCtrl",parent:angular.element(document.body),clickOutsideToClose:!0}).then(function(r){if(""==r){var n={};n[e.sessionData.userData.properties.correctedLanguage]="";var t=new l({name:n});t.$save(function(){e.form.values||(e.form.values=[]),e.form.values.push({name:n,_id:t._id}),p("/form_value_edit/"+t._id+"?datamodel_id="+e.form.datamodel._id+"&application_id="+i.application_id+"&workflow_id="+i.workflow_id+"&form_id="+e.form._id)})}else e.form.values.push({name:"",_id:r}),p("/form_value_edit/"+r+"?datamodel_id="+e.form.datamodel._id+"&application_id="+i.application_id+"&workflow_id="+i.workflow_id+"&form_id="+e.form._id)})},e.newSection=function(){e.form.display||(e.form.display=[]);var r={};r[e.sessionData.userData.properties.correctedLanguage]="",e.form.display.push({blocks:[{flex:100,fields:[{text:r,translated_name:"",disabled:!1,mandatory:!1,id:f()}]}]})},e.newBlock=function(r){e.form.display||(e.form.display=[]);var n={};n[e.sessionData.userData.properties.correctedLanguage]="",r.push({fields:[{text:n,translated_name:"",disabled:!1,mandatory:!1,id:f()}]});for(var i=0;i<r.length;i++)r[i].flex=100/r.length},e.newField=function(r){var n={};n[e.sessionData.userData.properties.correctedLanguage]="",r.push({text:n,translated_name:"",disabled:!1,mandatory:!1,id:f()})},e.save=function(){p("/workflow_edit/"+i.workflow_id+"?application_id="+i.application_id)},e.onDragEnter=function(e){element.classList.add("dash_line")};var c=function(){t.show(t.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title(e.sessionData.appData.new_document_version).textContent(e.sessionData.appData.already_modified_document).ok(e.sessionData.appData.ok))}}]);
